<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Профіль</title>
<style>
  html,body{height:100%;margin:0;background:#06080d;color:#e9f0ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px}
  .card{width:min(520px,100%);border-radius:18px;background:linear-gradient(180deg,rgba(20,32,60,.92),rgba(10,12,18,.92));
        border:1px solid rgba(140,180,255,.18);box-shadow:0 12px 40px rgba(0,0,0,.55), 0 0 0 1px rgba(90,160,255,.12) inset;
        overflow:hidden}
  .hdr{display:flex;gap:12px;align-items:center;padding:14px 16px;background:linear-gradient(90deg,rgba(40,120,255,.18),rgba(0,255,170,.08))}
  .avatar{width:42px;height:42px;border-radius:14px;display:grid;place-items:center;
          background:radial-gradient(circle at 30% 30%, rgba(0,255,170,.35), rgba(40,120,255,.18) 55%, rgba(0,0,0,0) 75%),
                     rgba(255,255,255,.06);
          border:1px solid rgba(255,255,255,.14);font-weight:800;letter-spacing:.5px}
  .title{font-size:15px;font-weight:800;margin:0}
  .sub{opacity:.75;font-size:12px;margin:2px 0 0}
  .body{padding:14px 16px;display:grid;gap:10px}
  .row{display:flex;justify-content:space-between;gap:12px;padding:10px 12px;border-radius:14px;
       background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}
  .k{opacity:.75;font-size:12px}
  .v{font-weight:800;font-size:13px;word-break:break-all;text-align:right}
  .actions{display:flex;gap:10px;padding:14px 16px;border-top:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.18)}
  .btn{flex:1;border:0;border-radius:14px;padding:12px 12px;font-weight:800;color:#061018;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#4ef,#3f6bff); }
  .btn.ghost{background:rgba(255,255,255,.08);color:#e9f0ff;border:1px solid rgba(255,255,255,.12)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="hdr">
      <div class="avatar" id="avatar">BT</div>
      <div>
        <p class="title" id="email">Профіль</p>
        <p class="sub" id="uid">—</p>
      </div>
    </div>
    <div class="body">
      <div class="row"><div class="k">Баланс</div><div class="v" id="balance">—</div></div>
      <div class="row"><div class="k">Валюта</div><div class="v" id="currency">UAH</div></div>
      <div class="row"><div class="k">Статус</div><div class="v" id="status">—</div></div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="backBtn" type="button">Назад</button>
      <button class="btn primary" id="logoutBtn" type="button">Вийти</button>
    </div>
  </div>
</div>

<script>
(function(){
  function send(type,payload){
    try{ window.parent && window.parent.postMessage(Object.assign({__btlider:true,type:type}, payload||{}), '*'); }catch(e){}
  }
  function log(msg,obj){ try{ window.parent && window.parent.__BTLIDER_LOG && window.parent.__BTLIDER_LOG(msg,obj||null);}catch(e){} }

  function setText(id, val){ var el=document.getElementById(id); if(el) el.textContent=val; }
  function initials(email){
    if(!email) return 'BT';
    var p=email.split('@')[0].replace(/[^a-z0-9]/ig,'');
    return (p.slice(0,2)||'BT').toUpperCase();
  }

  function render(st){
    if(!st){ setText('status','NO_PARENT'); return; }
    if(st.user){
      setText('email', st.user.email || 'Профіль');
      setText('uid', st.user.id || '—');
      var av=document.getElementById('avatar'); if(av) av.textContent=initials(st.user.email);
    }else{
      setText('email','Гість');
      setText('uid','—');
    }
    var bal = (st.balance==null)?'—':(Math.round(Number(st.balance)*100)/100).toFixed(2);
    setText('balance', bal + ' ' + (st.currency||'UAH'));
    setText('currency', String(st.currency||'UAH'));
    setText('status', st.authed ? 'AUTHED' : 'GUEST');
  }

  // initial render
  try{
    var st = window.parent && window.parent.BTLIDER && window.parent.BTLIDER.getState ? window.parent.BTLIDER.getState() : null;
    render(st);
  }catch(e){ setText('status','ERR'); }

  // listen updates
  window.addEventListener('message', function(ev){
    var d = ev && ev.data;
    if(!d || !d.__btlider) return;
    if(d.type==='BTLIDER_AUTH_CHANGED'){
      try{
        render({authed:!!d.authed, user:d.user||null, balance:d.balance, currency:d.currency||'UAH'});
      }catch(e){}
    }
    if(d.type==='BTLIDER_BALANCE'){
      try{
        var cur = String(d.currency||'UAH');
        var bal = (d.balance==null)?'—':(Math.round(Number(d.balance)*100)/100).toFixed(2);
        setText('balance', bal + ' ' + cur);
        setText('currency', cur);
      }catch(e){}
    }
  });

  document.getElementById('backBtn').addEventListener('click', function(){ send('NAV_HOME'); });
  document.getElementById('logoutBtn').addEventListener('click', function(){
    try{
      var api = window.parent && window.parent.BTLIDER && window.parent.BTLIDER.Auth;
      api && api.logout && api.logout();
    }catch(e){}
  });

  send('NEED_BALANCE');
})();
</script>

<!-- ASSISTANT PATCH v23.3: balance sync listener (profile.html) -->
<script>
(() => {
  function fmt(b,c) {
    const n = Number(b||0);
    return n.toFixed(2).replace(/\.00$/,'') + (c?(' '+c):'');
  }
  function apply(balance,currency){
    try{
      const text = fmt(balance,currency);
      const nodes = [];
      document.querySelectorAll('[data-btl-balance], #balance, .balance, .js-balance, [class*="balance"], [id*="balance"]').forEach(el=>nodes.push(el));
      // de-dup
      const seen = new Set();
      nodes.forEach(el=>{
        if(!el || seen.has(el)) return; seen.add(el);
        // Avoid overwriting inputs
        if(el.tagName==='INPUT' || el.tagName==='TEXTAREA') return;
        // If element has children and looks like container, try find a numeric span inside
        let target = el;
        const inner = el.querySelector && el.querySelector('.amount,.value,.num,.balance-value,span');
        if(inner && inner.textContent && /\d/.test(inner.textContent)) target = inner;
        target.textContent = text;
      });
    }catch(e){}
  }
  window.addEventListener('message', (ev) => {
    const d = ev.data;
    if(!d || !d.__btlider) return;
    if(d.type==='BTLIDER_BALANCE') {
      apply(d.balance, d.currency);
    }
    if(d.type==='BTLIDER_AUTH_CHANGED') {
      // nothing here; index controls routing
    }
  });
  // ask parent for latest balance when embedded
  try{
    if(window.parent && window.parent !== window) {
      window.parent.postMessage({__btlider:true, type:'NEED_BALANCE'}, '*');
    }
  }catch(e){}
})();
</script>

</body>
</html>
