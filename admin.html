<!doctype html>
<html lang="uk">
<head>
<!-- ASSISTANT PATCH: early addLine stub v23.14 -->
<script>
(function(){
  // ASSISTANT PATCH v31.1: dynamic viewport vars (Chrome Android address bar safe)
  function __btViewportVars(){
    try{
      var h = (window.innerHeight||0);
      var w = (window.innerWidth||0);
      if(h) document.documentElement.style.setProperty('--screen-height', h + 'px');
      if(h) document.documentElement.style.setProperty('--viewport-height', h + 'px');
      if(w) document.documentElement.style.setProperty('--window-width', w + 'px');
    }catch(e){}
  }
  __btViewportVars();
  window.addEventListener('resize', __btViewportVars);

  window.__BTLIDER_LINES = window.__BTLIDER_LINES || [];
  window.addLine = window.addLine || function(tag,msg,obj){
    try{
      window.__BTLIDER_LINES.push([Date.now(), tag, msg, obj]);
      if(window.__BTLIDER_LINES.length>600) window.__BTLIDER_LINES.shift();
    }catch(e){}
  };
})();
</script>

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BTLIDER Admin</title>
<style>
/* ASSISTANT PATCH: HEADER GUARD (keep top header visible) */
:root { --btlider-header-z: 2147483000; }
.btlider-header-guard-visible {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  transform: none !important;
  pointer-events: auto !important;
}
.btlider-header-guard-fixed {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  z-index: var(--btlider-header-z) !important;
}

  :root{
    --bg:#070A10; --panel:rgba(255,255,255,.06); --bd:rgba(255,255,255,.14);
    --txt:#EAF0FF; --mut:#A9B3D2; --acc:#7CFFB2; --bad:#FF6B6B;
    --shadow:0 18px 60px rgba(0,0,0,.55);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    background: radial-gradient(900px 600px at 20% 0%, rgba(124,255,178,.10), transparent 60%),
                radial-gradient(900px 600px at 90% 30%, rgba(109,168,255,.10), transparent 60%),
                var(--bg);
    color:var(--txt);
  }
  .wrap{min-height:100vh; display:flex; flex-direction:column}
  header{
    position:sticky; top:0; z-index:50;
    backdrop-filter: blur(10px);
    background: rgba(0,0,0,.35);
    border-bottom:1px solid rgba(255,255,255,.10);
  }
  .bar{display:flex; gap:10px; align-items:center; justify-content:space-between; padding:14px 14px}
  .brand{display:flex; gap:10px; align-items:center}
  .badge{padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:var(--mut); font-weight:700; font-size:12px}
  .btn{
    appearance:none; border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.06); color:var(--txt);
    padding:10px 12px; border-radius:12px; font-weight:800;
  }
  .btn.primary{border-color:rgba(124,255,178,.35); background:rgba(124,255,178,.10)}
  .btn.danger{border-color:rgba(255,107,107,.35); background:rgba(255,107,107,.10)}
  main{flex:1; padding:14px}
  .grid{display:grid; grid-template-columns: 1fr; gap:14px}
  @media(min-width: 980px){ .grid{grid-template-columns: 420px 1fr} }
  .card{
    background:var(--panel);
    border:1px solid var(--bd);
    border-radius:18px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .card h2{margin:0; padding:14px 14px 0 14px; font-size:16px}
  .card p{margin:8px 14px; color:var(--mut); font-size:13px; line-height:1.35}
  .card .body{padding:14px}
  .row{display:flex; gap:10px; align-items:center}
  .row.wrap{flex-wrap:wrap}
  input, select, textarea{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.28);
    color: var(--txt);
    outline:none;
  }
  textarea{min-height:86px; resize:vertical}
  .hint{font-size:12px; color:var(--mut); margin-top:6px}
  .list{
    max-height: 58vh;
    overflow:auto;
    border-top:1px solid rgba(255,255,255,.10);
  }
  .item{
    padding:12px 14px;
    border-bottom:1px solid rgba(255,255,255,.08);
    cursor:pointer;
  }
  .item:hover{background: rgba(255,255,255,.06)}
  .item.active{background: rgba(124,255,178,.10); border-bottom-color:rgba(124,255,178,.20)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .kv{display:grid; grid-template-columns: 160px 1fr; gap:10px; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,.10)}
  .k{color:var(--mut); font-weight:800; font-size:12px}
  .v{font-weight:800; font-size:12px; overflow-wrap:anywhere}
  .msg{padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.25); color:var(--mut); font-size:12px}
  .msg.ok{border-color: rgba(124,255,178,.30); background: rgba(124,255,178,.08)}
  .msg.bad{border-color: rgba(255,107,107,.30); background: rgba(255,107,107,.08); color:#FFD0D0}
  .cols{display:grid; grid-template-columns: 1fr; gap:10px}
  @media(min-width: 980px){ .cols{grid-template-columns: 1fr 1fr} }
  .colDesc{padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.22)}
</style>

<!-- ASSISTANT PATCH v27: GLOBAL HEADER HEIGHT OVERRIDE (fix collapsed top header on all pages) -->
<style>
:root{
  --header-height: var(--header-height-v2, 56px) !important;
  --header-mobile-height: var(--header-mobile-height-v1, 44px) !important;
}
@media (max-width: 768px){
  :root{ --header-height: var(--header-mobile-height, 44px) !important; }
}
body{ scroll-padding-top: var(--header-height, 56px); }
#top-container{ position: sticky; top: env(safe-area-inset-top, 0px); z-index: 2147480000; }
</style>

<!-- ASSISTANT PATCH: HEADER ALWAYS VISIBLE v34 (Y) -->
<style>
/* Override older guard that used fixed positioning; sticky is safer on mobile + avoids "UAH only" collapse */
.btlider-header-guard-fixed{
  position: sticky !important;
  top: 0 !important;
  left: auto !important;
  right: auto !important;
  width: 100% !important;
}
</style>
<script>
(function(){
  function qs(sel, root){ try{return (root||document).querySelector(sel);}catch(e){return null;} }
  function qsa(sel, root){ try{return Array.from((root||document).querySelectorAll(sel));}catch(e){return [];} }

  function pickHeader(){
    return qs('[data-id="header-wrapper"]') ||
           qs('[data-id="header-title"]')?.closest('[data-id]') ||
           qs('#header') ||
           qs('header') ||
           qs('[role="banner"]') ||
           qs('.header') ||
           qs('.header-wrapper') ||
           qs('.topbar') ||
           qs('.top-bar');
  }

  function forceShow(el){
    if(!el) return;
    try{
      el.classList.add('btlider-header-guard-visible','btlider-header-guard-fixed');
      el.style.display = 'block';
      el.style.visibility = 'visible';
      el.style.opacity = '1';
      el.style.transform = 'none';
      el.style.pointerEvents = 'auto';
      el.style.zIndex = '2147483000';
      // also unhide a few ancestors (common when wrapper gets hidden)
      var p = el.parentElement;
      for(var i=0;i<3 && p;i++){
        if(p && p.style){
          if(p.style.display==='none') p.style.display='block';
          if(p.style.visibility==='hidden') p.style.visibility='visible';
          if(p.style.opacity==='0') p.style.opacity='1';
        }
        p = p.parentElement;
      }
    }catch(e){}
  }

  var snapshot = null;
  function ensure(){
    var h = pickHeader();
    if(h){
      if(!snapshot){
        try{ snapshot = h.cloneNode(true); snapshot.__btliderSnapshot = true; }catch(e){}
      }
      forceShow(h);
      return;
    }
    // header missing: try restore from snapshot
    if(snapshot && document.body){
      try{
        var existing = pickHeader();
        if(existing) return;
        var ins = snapshot.cloneNode(true);
        // prevent duplicate ids by leaving markup as-is; this is last-resort fallback and only runs if header is missing
        document.body.insertBefore(ins, document.body.firstChild);
        forceShow(ins);
      }catch(e){}
    }
  }

  // Observe DOM changes that might hide/remove the header after load
  var mo = null;
  function startObserver(){
    if(mo) return;
    try{
      mo = new MutationObserver(function(){ ensure(); });
      mo.observe(document.documentElement || document.body, {subtree:true, childList:true, attributes:true, attributeFilter:['style','class','hidden']});
    }catch(e){}
  }

  ensure();
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ ensure(); startObserver(); }, {once:true});
  } else {
    startObserver();
  }
  window.addEventListener('load', function(){ ensure(); }, {once:true});
  // short burst checks right after load, then slow keepalive
  var n=0;
  var fast = setInterval(function(){ n++; ensure(); if(n>=30) { clearInterval(fast); } }, 250);
  setInterval(ensure, 1500);
})();
</script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="bar">
      <div class="brand">
        <div style="width:36px;height:36px;border-radius:12px;background:rgba(124,255,178,.15);border:1px solid rgba(124,255,178,.25);display:grid;place-items:center;font-weight:900">A</div>
        <div>
          <div style="font-weight:900;letter-spacing:.4px">BTLIDER Admin</div>
          <div style="font-size:12px;color:var(--mut);margin-top:2px">Керування користувачами / балансами</div>
        </div>
      </div>
      <div class="row">
        <span id="authBadge" class="badge">session: ?</span>
        <button id="backBtn" class="btn">Назад</button>
        <button id="logoutBtn" class="btn danger">Вийти</button>
      </div>
    </div>
  </header>

  <main>
    <div id="topMsg" class="msg">Панель читає/пише через Supabase Edge Function. Якщо функції ще не розгорнуті — буде помилка, це нормально.</div>
    <div class="grid">
      <section class="card">
        <h2>Користувачі</h2>
        <p>Список завантажується з функції <span class="mono">admin-users</span>. Пошук працює по email / user_id.</p>
        <div class="body">
          <div class="row">
            <input id="q" placeholder="Пошук: email або user_id" autocomplete="off"/>
            <button id="refreshBtn" class="btn primary" style="width:auto;white-space:nowrap">Оновити</button>
          </div>
          <div class="hint">Права: потрібен адмін (role=admin або ваша перевірка в функції).</div>
        </div>
        <div id="list" class="list"></div>
      </section>

      <section class="card">
        <h2>Редактор користувача</h2>
        <p>Вибери користувача зліва, змінюй поля, натискай “Зберегти”.</p>
        <div class="body">
          <div id="selMsg" class="msg">Немає вибраного користувача.</div>

          <div id="editor" style="display:none">
            <div class="kv"><div class="k">user_id</div><div id="u_id" class="v mono"></div></div>
            <div class="kv"><div class="k">email</div><div id="u_email" class="v"></div></div>

            <div class="cols" style="margin-top:12px">
              <div class="colDesc">
                <div style="font-weight:900;margin-bottom:8px">wallets</div>
                <div class="hint">Таблиця гаманця: <span class="mono">wallets.user_id</span>, <span class="mono">wallets.balance</span>, <span class="mono">wallets.currency</span>.</div>
                <label style="display:block;margin-top:10px;font-weight:800;font-size:12px;color:var(--mut)">balance</label>
                <input id="f_balance" inputmode="decimal" placeholder="0.00"/>
                <label style="display:block;margin-top:10px;font-weight:800;font-size:12px;color:var(--mut)">currency</label>
                <select id="f_currency">
                  <option value="UAH">UAH</option>
                  <option value="USD">USD</option>
                  <option value="EUR">EUR</option>
                </select>
              </div>

              <div class="colDesc">
                <div style="font-weight:900;margin-bottom:8px">profiles</div>
                <div class="hint">Опційно: <span class="mono">profiles.role</span>, <span class="mono">profiles.display_name</span>, <span class="mono">profiles.note</span>.</div>
                <label style="display:block;margin-top:10px;font-weight:800;font-size:12px;color:var(--mut)">role</label>
                <select id="f_role">
                  <option value="">(нема)</option>
                  <option value="user">user</option>
                  <option value="admin">admin</option>
                  <option value="moder">moder</option>
                </select>
                <label style="display:block;margin-top:10px;font-weight:800;font-size:12px;color:var(--mut)">display_name</label>
                <input id="f_name" placeholder="Імʼя для UI"/>
                <label style="display:block;margin-top:10px;font-weight:800;font-size:12px;color:var(--mut)">note</label>
                <textarea id="f_note" placeholder="Коментар/причина змін"></textarea>
              </div>
            </div>

            <div class="row wrap" style="margin-top:12px;justify-content:flex-end">
              <button id="loadBtn" class="btn">Перечитати</button>
              <button id="saveBtn" class="btn primary">Зберегти в БД</button>
            </div>

            <div id="saveMsg" class="msg" style="margin-top:10px;display:none"></div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  function setMsg(el, text, type){
    if(!el) return;
    el.textContent = text || '';
    el.classList.remove('ok','bad');
    if(type) el.classList.add(type);
    el.style.display = 'block';
  }

  // Acquire supabase client from parent (preferred) or local (if opened standalone)
  function getSupabase(){
    try{
      if(window.parent && window.parent !== window && window.parent.BTLIDER && window.parent.BTLIDER.supabase){
        return window.parent.BTLIDER.supabase;
      }
    }catch(e){}

    // ASSISTANT PATCH v28: handle relative internal routes (not only full btlider.local URLs)
    try{
      const hh = String(h||'').trim();
      if(/^\/?((uk|ru|en)\/)?(my-account|profile|account)\b/i.test(hh)) return {t:'OPEN_PROFILE'};
      if(/^\/?((uk|ru|en)\/)?(promo|promotions|bonuses|bonus)\b/i.test(hh)) return {t:'OPEN_PROMO'};
      if(/^\/?((uk|ru|en)\/)?admin\b/i.test(hh)) return {t:'OPEN_ADMIN'};
    }catch(e){}

    return null;
  }

  const sb = getSupabase();
  if(!sb){
    setMsg($('topMsg'), 'Немає доступу до Supabase client (відкрий через головний index.html).', 'bad');
  }

  async function ensureAuthed(){
    try{
      const { data } = await sb.auth.getSession();
      const sess = data && data.session;
      $('authBadge').textContent = 'session: ' + (sess ? 'YES' : 'NO');
      if(!sess){
        setMsg($('topMsg'), 'Немає сесії. Увійди.', 'bad');
        return null;
      }
      // Variant B: admin by profiles.role === 'admin'
      try{
        const pr = await sb.from('profiles').select('role,email').eq('user_id', sess.user.id).maybeSingle();
        const role = pr && pr.data && pr.data.role ? String(pr.data.role).toLowerCase() : 'user';
        $('roleBadge').textContent = 'role: ' + role;
        if(role !== 'admin'){
          setMsg($('topMsg'), 'Доступ заборонено. Тільки для admin.', 'bad');
          return null;
        }
      }catch(e){
        setMsg($('topMsg'), 'Не можу перевірити role в profiles. Переконайся що таблиця profiles є і RLS дозволяє читати свій рядок.', 'bad');
        return null;
      }
      return sess;
    }catch(e){
      setMsg($('topMsg'), 'Помилка перевірки сесії: ' + (e && e.message ? e.message : String(e)), 'bad');
      return null;
    }
  }

  function back(){
    try{
      if(window.parent && window.parent !== window){
        window.parent.postMessage({__btlider:true,type:'ROUTE_HOME'}, '*');
      }else{
        location.href = './';
      }
    }catch(e){}
  }

  $('backBtn').addEventListener('click', back);
  $('logoutBtn').addEventListener('click', async ()=>{
    try{ await sb.auth.signOut(); }catch(e){}
    back();
  });

  let USERS = [];
  let SELECTED = null;

  function renderList(list){
    const root = $('list');
    root.innerHTML = '';
    (list||[]).forEach(u=>{
      const d = document.createElement('div');
      d.className = 'item' + (SELECTED && SELECTED.user_id === u.user_id ? ' active' : '');
      d.innerHTML = '<div style="font-weight:900">'+(u.email||'(no email)')+'</div>'
                  + '<div class="hint mono">'+u.user_id+'</div>'
                  + '<div class="hint">balance: <b>'+String(u.balance??'—')+'</b> '+String(u.currency||'')+'</div>';
      d.addEventListener('click', ()=>selectUser(u));
      root.appendChild(d);
    });
  }

  function selectUser(u){
    SELECTED = u;
    $('selMsg').style.display='none';
    $('editor').style.display='block';
    $('u_id').textContent = u.user_id || '';
    $('u_email').textContent = u.email || '';
    $('f_balance').value = (u.balance ?? '');
    $('f_currency').value = (u.currency || 'UAH');
    $('f_role').value = (u.role || '');
    $('f_name').value = (u.display_name || '');
    $('f_note').value = (u.note || '');
    $('saveMsg').style.display='none';
    renderList(USERS);
  }

  function filterList(){
    const q = ($('q').value||'').trim().toLowerCase();
    if(!q) return USERS;
    return USERS.filter(u=>{
      return (String(u.email||'').toLowerCase().includes(q) || String(u.user_id||'').toLowerCase().includes(q));
    });
  }

  $('q').addEventListener('input', ()=>renderList(filterList()));

  async function loadUsers(){
    if(!sb) return;
    const sess = await ensureAuthed();
    if(!sess) return;

    setMsg($('topMsg'), 'Завантажую список користувачів…', null);

    try{
      // Requires Supabase Edge Function "admin-users"
      const { data, error } = await sb.functions.invoke('admin-users', { body: { q: ($('q').value||'').trim() } });
      if(error) throw error;
      USERS = (data && data.users) ? data.users : [];
      renderList(filterList());
      setMsg($('topMsg'), 'Ок. Користувачів: ' + USERS.length, 'ok');
    }catch(e){
      setMsg($('topMsg'),
        'Не вдалося завантажити користувачів. Потрібно розгорнути Edge Function admin-users. ' +
        'Помилка: ' + (e && e.message ? e.message : String(e)),
        'bad'
      );
    }
  }

  async function reloadSelected(){
    if(!sb || !SELECTED) return;
    try{
      const { data, error } = await sb.functions.invoke('admin-user', { body: { user_id: SELECTED.user_id } });
      if(error) throw error;
      if(data && data.user){
        // merge
        const u = data.user;
        USERS = USERS.map(x => x.user_id === u.user_id ? u : x);
        SELECTED = u;
        selectUser(u);
      }
      setMsg($('saveMsg'), 'Дані перечитані.', 'ok');
    }catch(e){
      setMsg($('saveMsg'), 'Не вдалося перечитати: ' + (e && e.message ? e.message : String(e)), 'bad');
    }
  }

  async function saveSelected(){
    if(!sb || !SELECTED) return;
    const payload = {
      user_id: SELECTED.user_id,
      wallets: {
        balance: Number(String($('f_balance').value||'0').replace(',','.')),
        currency: $('f_currency').value || 'UAH',
      },
      profiles: {
        role: $('f_role').value || null,
        display_name: ($('f_name').value||'').trim() || null,
        note: ($('f_note').value||'').trim() || null,
      }
    };

    try{
      setMsg($('saveMsg'), 'Зберігаю…', null);
      const { data, error } = await sb.functions.invoke('admin-update-user', { body: payload });
      if(error) throw error;
      setMsg($('saveMsg'), 'Збережено в БД.', 'ok');
      if(data && data.user){
        const u = data.user;
        USERS = USERS.map(x => x.user_id === u.user_id ? u : x);
        SELECTED = u;
        renderList(filterList());
      }
    }catch(e){
      setMsg($('saveMsg'),
        'Не вдалося зберегти. Потрібна Edge Function admin-update-user. ' +
        'Помилка: ' + (e && e.message ? e.message : String(e)),
        'bad'
      );
    }
  }

  $('refreshBtn').addEventListener('click', loadUsers);
  $('loadBtn').addEventListener('click', reloadSelected);
  $('saveBtn').addEventListener('click', saveSelected);

  // boot
  (async ()=>{
    if(!sb) return;
    await ensureAuthed();
    await loadUsers();
  })();
})();
</script>

<!-- ASSISTANT PATCH v23.6: BALANCE + NAV hooks (keep visual, no gorilla nav) -->
<script>
(function(){
  if(window.__BTLIDER_BAL_NAV_HOOKS) return; window.__BTLIDER_BAL_NAV_HOOKS=true;
  function post(type, extra){ try{ parent && parent.postMessage(Object.assign({__btlider:true,type:type}, extra||{}), '*'); }catch(e){} }
  function applyBalance(bal, cur){
    try{
      var val = (bal===null||bal===undefined) ? '--' : String(bal);
      var curTxt = cur || 'UAH';
      var txt = val + ' ' + curTxt;
      var sel = [
        '[data-btl-balance]',
        '#balance','#userBalance','#walletBalance',
        '[id*="balance" i]','[class*="balance" i]',
        '[id*="wallet" i]','[class*="wallet" i]',
        '[class*="money" i]','[class*="amount" i]','[class*="sum" i]','[class*="cash" i]'
      ].join(',');
      var nodes = Array.prototype.slice.call(document.querySelectorAll(sel));
      nodes.forEach(function(n){
        if(!n) return;
        // do not overwrite large blocks
        var t = (n.textContent||'').trim();
        if(t.length>0 && t.length<60){
          n.textContent = txt;
        }else if(n.hasAttribute('data-btl-balance')){
          n.textContent = txt;
        }
      });
      // Offline/localStorage balance removed: Supabase DB is the only source of truth.
    }catch(e){}
  }
  // ask parent for balance once
  try{ post('NEED_BALANCE'); }catch(e){}
  window.addEventListener('message', function(ev){
    var d = ev && ev.data;
    if(!d || !d.__btlider) return;
    if(d.type==='BTLIDER_BALANCE'){
      applyBalance(d.balance, d.currency);
    }
  });
  // nav hooks
  function norm(s){ return (s||'').toString().trim().toLowerCase(); }
  document.addEventListener('click', function(e){
    try{
      var t = e.target;
      if(!t) return;
      var a = t.closest ? t.closest('a,button,[role="button"]') : null;
      if(!a) return;
      var href = (a.getAttribute && (a.getAttribute('href')||a.getAttribute('data-href')||'')) || '';
      var txt = norm(a.textContent||'');
      var idc = norm((a.id||'')+' '+(a.className||'')+' '+(a.getAttribute && (a.getAttribute('aria-label')||'')));
      var isProfile = href.indexOf('/my-account')>-1 || href.indexOf('my-account')>-1 || idc.indexOf('account')>-1 || idc.indexOf('profile')>-1 || txt==='профіль' || txt==='профиль';
      var isPromo = href.indexOf('promo')>-1 || href.indexOf('bonus')>-1 || href.indexOf('quest')>-1 || href.indexOf('#btlider_promo')>-1 || idc.indexOf('promo')>-1 || idc.indexOf('bonus')>-1 || txt.indexOf('промо')>-1 || txt.indexOf('бонус')>-1;
      if(isProfile){
        e.preventDefault(); e.stopPropagation();
        post('OPEN_PROFILE');
        return;
      }
      if(isPromo){
        e.preventDefault(); e.stopPropagation();
        post('OPEN_PROMO');
        return;
      }
      // block external gorilla links
      if(href && (href.indexOf('btlider.local')>-1 || false)){
        e.preventDefault(); e.stopPropagation();
        post('OPEN_STUB',{label:'Скоро'});
        return;
      }
    }catch(_){}
  }, true);
})();
</script>
<!-- /ASSISTANT PATCH v23.6 -->


<script>
/* ASSISTANT PATCH v23.11: block external/gorilla navigation inside admin */
(function(){
  function isExternal(href){
    try{ const u=new URL(href, location.href); return u.origin !== location.origin; }catch(e){ return false; }
  }
  function looksGorilla(href){
    href = href || '';
    if(/gorilla\.ua/i.test(href) || /betlider\.ua/i.test(href)) return true;
    if(/^\/(uk|ru|en)\//i.test(href)) return true;
    if(/^\/my-account/i.test(href)) return true;
    if(/^\/account/i.test(href)) return true;
    if(/^\/promo/i.test(href)) return true;
    return false;
  }
  document.addEventListener('click', function(e){
    const a = e.target && (e.target.closest ? e.target.closest('a') : null);
    if(!a) return;
    const href = a.getAttribute('href') || '';
    if(!href) return;
    if(looksGorilla(href) || isExternal(href)){
      e.preventDefault(); e.stopPropagation();
      try{ parent && parent.__BTLIDER_LOG && parent.__BTLIDER_LOG('WARN','NAV_BLOCKED',{href}); }catch(_){}
      try{
        const hh = String(href||'').toLowerCase();
        if(hh.includes('my-account') || /\/(uk|ru|en)\/(my-account|account)\b/.test(hh) || hh.startsWith('/my-account') || hh.startsWith('/account')){
          parent && parent.postMessage({__btlider:true,type:'OPEN_PROFILE'}, '*'); return;
        }
        if(hh.includes('promo') || hh.includes('bonus') || hh.includes('quest') || hh.includes('промо') || hh.includes('бонус') || hh.includes('квест')){
          parent && parent.postMessage({__btlider:true,type:'OPEN_PROMO'}, '*'); return;
        }
        parent && parent.postMessage({__btlider:true,type:'OPEN_STUB', title:'Скоро'}, '*');
      }catch(_){}
    }
  }, true);
})();
</script>

<!-- ASSISTANT PATCH: universal diag + loader failsafe v23.14 -->
<script>
(function(){
  'use strict';
  function ts(){
    try{
      const d=new Date();
      return d.toTimeString().slice(0,8);
    }catch(e){ return ''; }
  }
  function safeJson(o){
    try{ return JSON.stringify(o); }catch(e){ return String(o); }
  }
  function pushLine(tag,msg,obj){
    window.__BTLIDER_LINES = window.__BTLIDER_LINES || [];
    window.__BTLIDER_LINES.push([Date.now(), tag, msg, obj]);
    if(window.__BTLIDER_LINES.length>800) window.__BTLIDER_LINES.shift();
  }
  // Hard guarantee
  window.addLine = window.addLine || function(tag,msg,obj){ pushLine(tag,msg,obj); };

  // Capture errors for everyone (temporary)
  window.addEventListener('error', function(e){
    pushLine('ERROR', (e && e.message) ? e.message : 'error', {filename:e && e.filename, lineno:e && e.lineno, colno:e && e.colno});
  });
  window.addEventListener('unhandledrejection', function(e){
    var r = e && e.reason;
    pushLine('REJECT', (r && (r.message||r.toString())) || 'unhandledrejection', {reason: (r && (r.stack||r.message)) || String(r)});
  });

  function mount(){
    if(document.getElementById('btlDiagPanel')) return;
    var wrap=document.createElement('div');
    wrap.id='btlDiagPanel';
    wrap.style.cssText='position:fixed;left:8px;bottom:68px;width:min(360px,92vw);max-height:42vh;z-index:2147483647;background:rgba(0,0,0,.72);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.18);border-radius:14px;overflow:hidden;font:12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#fff;';
    var head=document.createElement('div');
    head.style.cssText='display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.12);';
    head.innerHTML='<div style="font-weight:700;letter-spacing:.2px;">BTLIDER LOG</div><div style="opacity:.75;flex:1;">(тимчасово для всіх)</div>';
    var btnCopy=document.createElement('button');
    btnCopy.textContent='COPY';
    btnCopy.style.cssText='background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:6px 10px;font-weight:700;';
    var btnHide=document.createElement('button');
    btnHide.textContent='HIDE';
    btnHide.style.cssText=btnCopy.style.cssText;
    btnHide.onclick=function(){ wrap.style.display='none'; };
    btnCopy.onclick=function(){
      try{
        var lines=(window.__BTLIDER_LINES||[]).slice(-250).map(function(x){
          var t = ts();
          try{ t = new Date(x[0]).toTimeString().slice(0,8); }catch(e){}
          var tag=x[1], msg=x[2], obj=x[3];
          return '['+t+'] '+tag+': '+msg+(obj!==undefined ? ' | '+safeJson(obj) : '');
        }).join('\n');
        navigator.clipboard.writeText(lines).then(function(){
          pushLine('COPIED','OK');
        }).catch(function(){
          pushLine('COPIED','FAILED');
        });
      }catch(e){ pushLine('COPIED','EX', String(e && e.message || e)); }
    };
    head.appendChild(btnCopy);
    head.appendChild(btnHide);

    var body=document.createElement('div');
    body.id='btlDiagBody';
    body.style.cssText='padding:8px 10px;overflow:auto;max-height:34vh;white-space:pre-wrap;word-break:break-word;';
    wrap.appendChild(head);
    wrap.appendChild(body);
    document.body.appendChild(wrap);

    function render(){
      var arr=(window.__BTLIDER_LINES||[]).slice(-200);
      body.textContent=arr.map(function(x){
        var t=ts(); try{ t=new Date(x[0]).toTimeString().slice(0,8);}catch(e){}
        return '['+t+'] '+x[1]+': '+x[2]+(x[3]!==undefined ? ' | '+safeJson(x[3]) : '');
      }).join('\n');
      body.scrollTop = body.scrollHeight;
    }
    render();
    setInterval(render, 700);
  }

  function loaderFailsafe(){
    try{
      // remove common full-screen blockers
      var kill = [
        '#preloader','#loader','#loading','#loadingOverlay','.preloader','.loader','.loading-overlay','.loadingOverlay','[data-btl-loader]','[data-loader]'
      ];
      kill.forEach(function(sel){
        document.querySelectorAll(sel).forEach(function(el){
          try{ el.style.display='none'; }catch(e){}
        });
      });
      if(document.documentElement) document.documentElement.classList.remove('loading');
      if(document.body) document.body.classList.remove('loading');
      pushLine('DIAG','loader failsafe executed');
    }catch(e){
      pushLine('DIAG','loader failsafe error', String(e && e.message || e));
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    mount();
    // If anything still blocks after 7s, kill it
    setTimeout(loaderFailsafe, 7000);
  });

  // If DOM already loaded
  if(document.readyState === 'interactive' || document.readyState === 'complete'){
    setTimeout(function(){ try{ mount(); }catch(e){} }, 0);
    setTimeout(loaderFailsafe, 7000);
  }
})();
</script>


<!-- ASSISTANT PATCH: LINK_SANITIZER_NAV (remove Gorilla redirects, map to internal stubs/pages) -->
<script>
(function(){
  'use strict';
  function send(type, extra){
    try{
      (window.parent && window.parent!==window ? window.parent : window).postMessage(Object.assign({__btlider:true, type:type}, extra||{}), '*');
    }catch(e){}
  }
  function mapHref(h){
    if(!h) return null;
    // internal hash targets
    if(h === '#BTLIDER_PROMO') return {t:'OPEN_PROMO'};
    if(h === '#BTLIDER_PROFILE') return {t:'OPEN_PROFILE'};
    if(h === '#BTLIDER_MENU') return {t:'OPEN_STUB', label:'Меню'};
    // legacy external Gorilla links
    try{
      if(/gorilla\.ua/i.test(h)){
        if(/\/uk\/my-account/i.test(h)) return {t:'OPEN_PROFILE'};
        if(/\/uk\/promo/i.test(h)) return {t:'OPEN_PROMO'};
        if(/\/uk\/menu/i.test(h)) return {t:'OPEN_STUB', label:'Меню'};
        return {t:'OPEN_STUB', label:'Зовнішній перехід'};
      }
    }catch(e){}
    return null;
  }
  document.addEventListener('click', function(ev){
  const a = ev.target && ev.target.closest ? ev.target.closest('a') : null;
  if(!a) return;
  const hrefRaw = (a.getAttribute('href') || '').trim();
  let m = mapHref(hrefRaw);

  // STRICT ROUTER-ONLY fallback: many bottom-nav items use href="#" or empty. Infer by label/class/id.
  if(!m){
    try{
      const hr = String(hrefRaw||'').toLowerCase();
      const isVoid = (!hrefRaw || hr === '#' || hr === '#!' || hr === '/' || hr.startsWith('javascript:') || hr.indexOf('void(0)')>=0);
      if(isVoid){
        const txt = ((a.textContent||'') + ' ' + (a.getAttribute('aria-label')||'') + ' ' + (a.getAttribute('title')||'')).trim().toLowerCase();
        const cls = (a.className||'').toString().toLowerCase();
        const id  = (a.id||'').toString().toLowerCase();
        const hay = (txt + ' ' + cls + ' ' + id);

        if(/\b(admin|админ|адмін)\b/i.test(hay)) m = {t:'OPEN_ADMIN'};
        else if(/\b(profile|profil|проф|кабінет|кабинет|account|my\s*account)\b/i.test(hay)) m = {t:'OPEN_PROFILE'};
        else if(/\b(promo|промо|акц|акції|promotions|bonus|bonuses|бонус)\b/i.test(hay)) m = {t:'OPEN_PROMO'};
        else if(/\b(home|головн|lobby|casino|казино)\b/i.test(hay)) m = {t:'ROUTE_HOME'};
      }
    }catch(e){}
  }

  if(!m) return;
  ev.preventDefault();
  ev.stopPropagation();

  if(m.t==='OPEN_STUB') send('OPEN_STUB', {label:m.label||'Скоро'});
  else if(m.t==='ROUTE_HOME') send('ROUTE_HOME');
  else send(m.t);
}, true);
})();
</script>

<!-- ASSISTANT PATCH: HEADER GUARD 2026-02-05 18:01:12 UTC -->
<script>
(function(){
  function q(sel){ try{return document.querySelector(sel);}catch(e){return null;} }
  function pickHeader(){
    return q('[data-id="header-wrapper"]') ||
           q('#header') ||
           q('header') ||
           q('.header') ||
           q('.header-wrapper') ||
           q('.topbar') ||
           q('.top-bar');
  }
  function forceShow(el){
    if(!el) return;
    try{
      el.classList.add('btlider-header-guard-visible','btlider-header-guard-fixed');
      el.style.display = 'block';
      el.style.visibility = 'visible';
      el.style.opacity = '1';
      el.style.transform = 'none';
      el.style.pointerEvents = 'auto';
      el.style.zIndex = '2147483000';
    }catch(e){}
  }
  function fixAuthButtons(){
    var ids = ['#header-login','#header-register','#loginBtn','#registerBtn'];
    ids.forEach(function(s){
      var el = q(s);
      if(el){
        try{
          el.style.display = '';
          el.style.visibility = 'visible';
          el.style.opacity = '1';
          el.style.pointerEvents = 'auto';
        }catch(e){}
      }
    });
  }
  function tick(){
    var h = pickHeader();
    if(h){ forceShow(h); fixAuthButtons(); }
  }
  tick();
  document.addEventListener('DOMContentLoaded', tick, { once:true });
  window.addEventListener('load', tick, { once:true });
  setInterval(tick, 900);
})();
</script>

<!-- ASSISTANT PATCH: ADMIN UI GATE (do NOT hide header) 2026-02-05 18:01:12 UTC -->
<script>
(function(){
  var ADMIN_EMAILS = ['bondarenkodarrderrrr@gmail.com','bondarenkodarderrrr@gmail.com'];
  function q(sel){ try{return document.querySelector(sel);}catch(e){return null;} }
  function qa(sel){ try{return Array.from(document.querySelectorAll(sel));}catch(e){return [];} }
  function hide(el){ if(!el) return; try{ el.style.display='none'; }catch(e){} }
  function show(el){ if(!el) return; try{ el.style.display=''; }catch(e){} }
  function isAdminEmail(email){
    if(!email) return false;
    email = String(email).toLowerCase().trim();
    for(var i=0;i<ADMIN_EMAILS.length;i++) if(ADMIN_EMAILS[i]===email) return true;
    return false;
  }
  function getEmailFromSession(){
    try{
      if(window.BTLIDER && window.BTLIDER.Auth && typeof window.BTLIDER.Auth.session==='function') return null;
      var keys = Object.keys(localStorage||{});
      for(var i=0;i<keys.length;i++) {
        var k = keys[i];
        if(k.indexOf('supabase')>=0 && k.indexOf('auth-token')>=0) {
          var raw = localStorage.getItem(k);
          if(!raw) continue;
          try {
            var j = JSON.parse(raw);
            var email = j && j.user && j.user.email;
            if(email) return email;
          } catch(e){}
        }
      }
    }catch(e){}
    return null;
  }
  function applyGate(isAdmin){
    qa('[data-btlider-admin-only]').forEach(function(el){ if(isAdmin) show(el); else hide(el); });
    var sels = ['#toggleLog','#copyLog','#btliderAdminBtn','#adminBtn','#adminPanelBtn','.btlider-admin-only'];
    sels.forEach(function(sel){
      var el = q(sel);
      if(el){ if(isAdmin) show(el); else hide(el); }
    });
  }
  async function tickAsync(){
    var email = null;
    try{
      if(window.BTLIDER && window.BTLIDER.Auth && typeof window.BTLIDER.Auth.session==='function') {
        var s = await window.BTLIDER.Auth.session();
        email = s && s.email ? s.email : null;
      }
    }catch(e){}
    if(!email) email = getEmailFromSession();
    applyGate(isAdminEmail(email));
  }
  document.addEventListener('DOMContentLoaded', function(){
    tickAsync();
    setInterval(tickAsync, 1200);
  });
})();
</script>

</body>
</html>
