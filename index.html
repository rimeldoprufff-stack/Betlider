<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BTLIDER — Unified</title>
  <style>
    /* ASSISTANT PATCH: unified shell (no scroll, fullscreen, click-safe) */
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden; background: #000;
    }
    #appShell {
      position: fixed; inset: 0; width: 100%; height: 100%;
      overflow: hidden;
    }
    .screenFrame {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      border: 0; margin: 0; padding: 0;
      display: none;
      background: transparent;
    }
    .screenFrame.active {
      display: block;
    }
  </style>

  <!-- ASSISTANT PATCH: bonus modal styles -->
  <style>
    /* ASSISTANT PATCH: modal overlay (non-blocking when closed) */
    #bonusModal { position: fixed; inset: 0; display: none; z-index: 2147483000; }
    #bonusModal.open { display: block; }
    #bonusModal .assistant-modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.65); }
    #bonusModal .assistant-modal-panel { position: absolute; inset: 10px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.14); border-radius: 16px; overflow: hidden; }
    @media (min-width: 700px){ #bonusModal .assistant-modal-panel { inset: 28px; } }
    #bonusModal .assistant-modal-close { position: absolute; top: 10px; right: 10px; z-index: 2; width: 40px; height: 40px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.18); background: rgba(31,32,41,0.85); color: #fff; font-size: 22px; line-height: 38px; cursor: pointer; }
    #bonusModal .assistant-modal-iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; background: #0a0a0a; }
  </style>
  <!-- ASSISTANT PATCH: promo modal styles -->
  <style>
    /* ASSISTANT PATCH: modal overlay (non-blocking when closed) */
    #promoModal { position: fixed; inset: 0; display: none; z-index: 2147483000; }
    #promoModal.open { display: block; }
    #promoModal .assistant-modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.65); }
    #promoModal .assistant-modal-panel { position: absolute; inset: 6vh 6vw; background: rgba(12,16,28,0.96); border: 1px solid rgba(255,255,255,0.14); border-radius: 16px; overflow: hidden; box-shadow: 0 16px 60px rgba(0,0,0,0.45); }
    #promoModal .assistant-modal-close { position: absolute; top: 10px; right: 10px; width: 34px; height: 34px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18); background: rgba(0,0,0,0.25); color: #fff; font-size: 22px; line-height: 30px; cursor: pointer; z-index: 2; }
    #promoModal .assistant-modal-iframe { width: 100%; height: 100%; border: 0; display: block; }
    @media (max-width: 560px){
      #promoModal .assistant-modal-panel { inset: 0; border-radius: 0; }
      #promoModal .assistant-modal-close { top: 8px; right: 8px; }
    }
  </style>



</head>
<body>
  <div id="appShell">
    <iframe id="guestFrame" class="screenFrame active"
      sandbox="allow-scripts allow-forms allow-modals allow-same-origin"
      referrerpolicy="no-referrer"></iframe>

    <iframe id="authedFrame" class="screenFrame"
      sandbox="allow-scripts allow-forms allow-modals allow-same-origin"
      referrerpolicy="no-referrer"></iframe>

    <!-- ASSISTANT PATCH: bonus modal container -->
    <div id="bonusModal" aria-hidden="true">
      <div class="assistant-modal-backdrop" data-assistant-close="1"></div>
      <div class="assistant-modal-panel" role="dialog" aria-modal="true">
        <button type="button" class="assistant-modal-close" data-assistant-close="1" aria-label="Close">×</button>
        <iframe id="bonusFrame" class="assistant-modal-iframe" sandbox="allow-scripts allow-forms allow-same-origin" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>

  </div>

  
    <!-- ASSISTANT PATCH: promo modal container -->
    <div id="promoModal" aria-hidden="true">
      <div class="assistant-modal-backdrop" data-assistant-close="1"></div>
      <div class="assistant-modal-panel" role="dialog" aria-modal="true">
        <button type="button" class="assistant-modal-close" data-assistant-close="1" aria-label="Close">×</button>
        <iframe id="promoFrame" class="assistant-modal-iframe"
          sandbox="allow-scripts allow-forms allow-same-origin"
          referrerpolicy="no-referrer"></iframe>
      </div>
    </div>

<!-- ASSISTANT PATCH: embedded pages (base64) -->
  <script>
  (function(){
    'use strict';

    const GUEST_B64 = "";
    const AUTH_B64  = "";

    // ASSISTANT PATCH: embedded bonus page (vv15-1.html)
    const BONUS_B64 = "";

    // ASSISTANT PATCH: embedded promo page (shell)
    const PROMO_B64 = "";



    function b64ToUtf8(b64) {
      // Robust UTF-8 decode for large strings
      try {
        const bin = atob(b64);
        // Chunk to avoid call stack / memory spikes
        const chunkSize = 0x8000;
        let result = '';
        for (let i = 0; i < bin.length; i += chunkSize) {
          const chunk = bin.slice(i, i + chunkSize);
          const bytes = new Uint8Array(chunk.length);
          for (let j = 0; j < chunk.length; j++) bytes[j] = chunk.charCodeAt(j);
          result += new TextDecoder('utf-8').decode(bytes);
        }
        return result;
      } catch(e) {
        // Fallback
        try {
          return decodeURIComponent(escape(atob(b64)));
        } catch(_) {
          return '';
        }
      }
    }

    const guestFrame = document.getElementById('guestFrame');
    const authedFrame = document.getElementById('authedFrame');

    function setActive(which) {
      guestFrame.classList.toggle('active', which === 'guest');
      authedFrame.classList.toggle('active', which === 'authed');
    }

    /* ASSISTANT PATCH: бонуси (кнопка → реєстрація якщо гість, інакше відкриває бонуси) + синхронізація з гравцем */
    const LS_KEYS = {
      authed: 'isAuthed',
      player: 'BTLIDER_PLAYER_STATE',
      bonuses: 'BTLIDER_BONUS_STATE'
    };

    function lsGet(key, fallback){
      try { const v = localStorage.getItem(key); return (v == null ? fallback : v); } catch(e){ return fallback; }
    }
    function lsSet(key, val){
      try { localStorage.setItem(key, val); } catch(e){}
    }
    function lsGetJSON(key, fallback){
      try { const v = localStorage.getItem(key); if(!v) return fallback; return JSON.parse(v); } catch(e){ return fallback; }
    }
    function lsSetJSON(key, obj){
      try { localStorage.setItem(key, JSON.stringify(obj)); } catch(e){}
    }

    function isAuthed(){
      return lsGet(LS_KEYS.authed, '0') === '1';
    }

    function ensurePlayerState(){
      let p = lsGetJSON(LS_KEYS.player, null);
      if(!p || typeof p !== 'object'){
        p = { id: 'demo', createdAt: Date.now(), balance: 0, notifications: 2 };
        lsSetJSON(LS_KEYS.player, p);
      }
      let b = lsGetJSON(LS_KEYS.bonuses, null);
      if(!b || typeof b !== 'object'){
        // Мінімальна модель бонусів (можна розширювати під твій контент)
        b = {
          updatedAt: Date.now(),
          items: [
            { id:'welcome_100', title:'100% до депозиту', status:'available', progress:0, goal:1, claimable:true },
            { id:'wager_15x', title:'Вейджер 15x', status:'locked', progress:0, goal:15, claimable:false }
          ],
          claimed: []
        };
        lsSetJSON(LS_KEYS.bonuses, b);
      }
      return { player: p, bonuses: b };
    }

    // Bonus modal controls (shell-level)
    const bonusModal = document.getElementById('bonusModal');
    const bonusFrame = document.getElementById('bonusFrame');

    function bonusModalOpen(){
      if(!bonusModal || !bonusFrame) return;
      // Load once
      if(!bonusFrame.dataset.loaded){
        try { if(BONUS_B64 && BONUS_B64.length > 1000){ bonusFrame.srcdoc = b64ToUtf8(BONUS_B64); } else { bonusFrame.removeAttribute('srcdoc'); bonusFrame.src = 'bonus.html'; } } catch(e){ bonusFrame.srcdoc = '<!doctype html><meta charset="utf-8"><body style="background:#0a0a0a;color:#fff;font-family:sans-serif;padding:16px">BONUS view load error</body>'; }
        bonusFrame.dataset.loaded = '1';

        bonusFrame.addEventListener('load', function(){
          // Push current state into bonus iframe
          try {
            const st = ensurePlayerState();
            bonusFrame.contentWindow && bonusFrame.contentWindow.postMessage({type:'ASSISTANT_BONUS_STATE', payload: st}, '*');
          try{ bonusFrame.contentWindow && bonusFrame.contentWindow.postMessage({type:'ASSISTANT_OPEN', target:'bonus'}, '*'); }catch(e){}
          } catch(e){}
          // Also inject click-outside prevention inside iframe if needed (no-op if blocked)
          try { installBonusStateBridge(bonusFrame); } catch(e){}
        }, { once:true });
      } else {
        try {
          const st = ensurePlayerState();
          bonusFrame.contentWindow && bonusFrame.contentWindow.postMessage({type:'ASSISTANT_BONUS_STATE', payload: st}, '*');
          try{ bonusFrame.contentWindow && bonusFrame.contentWindow.postMessage({type:'ASSISTANT_OPEN', target:'bonus'}, '*'); }catch(e){}
        } catch(e){}
      }

      bonusModal.classList.add('open');
      bonusModal.setAttribute('aria-hidden','false');
    }

    function bonusModalClose(){
      if(!bonusModal) return;
      bonusModal.classList.remove('open');
      bonusModal.setAttribute('aria-hidden','true');
    }

    // ASSISTANT PATCH: promo modal controls (shell-level)
    const promoModal = document.getElementById('promoModal');
    const promoFrame = document.getElementById('promoFrame');

    function promoModalOpen(){
      if(!promoModal || !promoFrame) return;
      if(!promoFrame.dataset.loaded){
        try { if(PROMO_B64 && PROMO_B64.length > 1000){ promoFrame.srcdoc = b64ToUtf8(PROMO_B64); } else { promoFrame.removeAttribute('srcdoc'); promoFrame.src = 'promo.html'; } } catch(e){ promoFrame.srcdoc = '<!doctype html><html><body style="font-family:sans-serif;padding:16px">PROMO view load error</body></html>'; }
        promoFrame.dataset.loaded = '1';
        promoFrame.addEventListener('load', function(){
          try { const st = ensurePlayerState(); promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_PROMO_STATE', payload: st}, '*');
          try{ promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_OPEN', target:'promo'}, '*'); }catch(e){} } catch(e){}
        }, { once:true });
      } else {
        try { const st = ensurePlayerState(); promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_PROMO_STATE', payload: st}, '*');
          try{ promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_OPEN', target:'promo'}, '*'); }catch(e){} } catch(e){}
      }
      promoModal.classList.add('open');
      promoModal.setAttribute('aria-hidden','false');
    }

    function promoModalClose(){
      if(!promoModal) return;
      promoModal.classList.remove('open');
      promoModal.setAttribute('aria-hidden','true');
    }



    // Close handlers
    (function initBonusModalClose(){
      if(!bonusModal) return;
      bonusModal.addEventListener('click', function(e){
        const t = e.target;
        if(!(t instanceof HTMLElement)) return;
        if(t && t.getAttribute('data-assistant-close') === '1') bonusModalClose();
      });
      document.addEventListener('keydown', function(e){
        if(e.key === 'Escape' && bonusModal.classList.contains('open')) bonusModalClose();
      });
    })();

    // ASSISTANT PATCH: promo modal close handlers
    (function initPromoModalClose(){
      if(!promoModal) return;
      promoModal.addEventListener('click', function(e){
        const t = e.target;
        if(!(t instanceof HTMLElement)) return;
        if(t && t.getAttribute('data-assistant-close') === '1') promoModalClose();
      });
      document.addEventListener('keydown', function(e){
        if(e.key === 'Escape' && promoModal.classList.contains('open')) promoModalClose();
      });
    })();

    function broadcastBonusState(){
      try {
        const st = ensurePlayerState();
        authedFrame && authedFrame.contentWindow && authedFrame.contentWindow.postMessage({type:'ASSISTANT_BONUS_STATE', payload: st}, '*');
      } catch(e){}
    }

    // ASSISTANT PATCH: promo state broadcaster
    function broadcastPromoState(){
      try {
        const st = ensurePlayerState();
        promoFrame && promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_PROMO_STATE', payload: st}, '*');
          try{ promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_OPEN', target:'promo'}, '*'); }catch(e){}
      } catch(e){}
    }



    /* ASSISTANT PATCH: sync notifications (bell counter) across guest/authed */
    function getNotifCount(){
      try { const st = ensurePlayerState(); return Math.max(0, parseInt((st.player && st.player.notifications)||0, 10) || 0); } catch(e){ return 0; }
    }
    function syncNotifBadges(){
      const n = getNotifCount();
      try { guestFrame && guestFrame.contentWindow && guestFrame.contentWindow.postMessage({type:'ASSISTANT_SET_NOTIFICATIONS', count:n}, '*'); } catch(e){}
      try { authedFrame && authedFrame.contentWindow && authedFrame.contentWindow.postMessage({type:'ASSISTANT_SET_NOTIFICATIONS', count:n}, '*'); } catch(e){}
    }


    function openRegisterInGuest(){
      try { setActive('guest'); } catch(e){}
      try {
        const w = guestFrame && guestFrame.contentWindow;
        const d = guestFrame && guestFrame.contentDocument;
        if(!w || !d) return false;
        const candidates = d.querySelectorAll('button, a, [role="button"], [data-testid]');
        const re = /(реєстрац|регистрац|sign\s*up|register)/i;
        for(const el of candidates){
          const txt = (el.textContent || '').trim();
          const dt = (el.getAttribute && (el.getAttribute('data-testid')||'')) || '';
          if(re.test(txt) || re.test(dt)){
            el.click();
            return true;
          }
        }
      } catch(e){}
      // Fallback: show stub
      try {
        alert('Потрібна реєстрація/вхід для доступу до бонусів.');
      } catch(e){}
      return false;
    }

    function isBonusTriggerElement(el){
      if(!el || !(el instanceof Element)) return false;
      const txt = (((el.textContent || '') + ' ' + (el.getAttribute('aria-label')||'') + ' ' + (el.getAttribute('title')||'') + ' ' + (el.getAttribute('alt')||'') + ' ' + (el.getAttribute('data-id')||''))).toLowerCase();
      const dt = (el.getAttribute('data-testid')||'').toLowerCase();
      const href = (el.getAttribute('href')||'').toLowerCase();
      const src = (el.getAttribute('src')||'').toLowerCase();
      const cls = (el.getAttribute('class')||'').toLowerCase();
      // Heuristics: "Бонуси/Promotions/Акції/Промо", or URL hints
      if(/бонус|bonus|promo|promotions|акц|акції|promotion/.test(txt)) return true;
      if(/bonus|promo|promotions|promotion/.test(dt)) return true;
      if(/bonus|promo|promotions|promotion/.test(href)) return true;
      if(/bonus|promo|promotions|promotion/.test(src)) return true;
      if(/bonus|promo|promotions|promotion/.test(cls)) return true;
      return false;
    }

    
    // ASSISTANT PATCH: promo click intercept (priority over bonus)
    function isPromoTriggerElement(el){
      if(!el || !(el instanceof Element)) return false;
      const txt = (((el.textContent || '') + ' ' + (el.getAttribute('aria-label')||'') + ' ' + (el.getAttribute('title')||'') + ' ' + (el.getAttribute('data-id')||''))).toLowerCase();
      const dt = (el.getAttribute('data-testid')||'').toLowerCase();
      const href = (el.getAttribute('href')||'').toLowerCase();
      const cls = (el.getAttribute('class')||'').toLowerCase();
      // Promo-only heuristics (exclude explicit bonus words)
      const promoHit = /promo|promocode|promotions|promotion|промо|промокод|акц|акції|акція|купон|coupon/.test(txt)
                    || /promo|promocode|promotions|promotion/.test(dt)
                    || /promo|promocode|promotions|promotion|promokod|promocode/.test(href)
                    || /promo|promocode|promotions|promotion/.test(cls);
      const bonusHit = /бонус|bonus/.test(txt) || /bonus/.test(dt) || /bonus/.test(href) || /bonus/.test(cls);
      return promoHit && !bonusHit;
    }

    // Capture phase: handle promo before bonus intercepts
    document.addEventListener('click', function(e){
      try {
        const t = e.target;
        if(!(t instanceof Element)) return;

        // Ignore clicks inside our modals
        if(t.closest && (t.closest('#promoModal') || t.closest('#bonusModal'))) return;

        // Walk up few levels to catch wrappers
        let el = t, found = null;
        for(let i=0;i<6 && el; i++){
          if(isPromoTriggerElement(el)){ found = el; break; }
          el = el.parentElement;
        }
        if(!found) return;

        e.preventDefault();
        e.stopPropagation();

        if(isAuthed()){
          promoModalOpen();
        } else {
          openRegisterInGuest();
        }
      } catch(err){}
    }, true);

function installBonusClickBridge(frame, label){
      try {
        const d = frame && frame.contentDocument;
        const w = frame && frame.contentWindow;
        if(!d || !w) return;

        if(d.documentElement && d.documentElement.hasAttribute('data-assistant-bonus-bridge')) return;
        d.documentElement && d.documentElement.setAttribute('data-assistant-bonus-bridge','1');

        d.addEventListener('click', function(e){
          let el = e.target;
          if(!(el instanceof Element)) return;

          // Walk up a few levels to catch clicks on icons inside buttons/cards
          let cur = el;
          for(let i=0;i<8 && cur;i++){
            if(isPromoTriggerElement(cur)){
              e.preventDefault();
              e.stopPropagation();
              if(typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
              try { window.postMessage({type:'ASSISTANT_PROMO_CLICK', from: label}, '*'); } catch(_e){}
              return;
            }
            if(isBonusTriggerElement(cur)){
              e.preventDefault();
              e.stopPropagation();
              if(typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
              try { window.postMessage({type:'ASSISTANT_BONUS_CLICK', from: label}, '*'); } catch(_e){}
              return;
            }
            cur = cur.parentElement;
          }
        }, true);
      } catch(e){}
    }

    function installBonusStateBridge(frame){
      // Non-invasive: listens for bonus actions posted from vv15-1.html if present
      try {
        const w = frame && frame.contentWindow;
        if(!w) return;
        // no-op; message handler in shell handles mutations
      } catch(e){}
    }


    
    // <!-- ASSISTANT PATCH: iframe click bridge injector -->
    function injectIframeClickBridge(innerHtml){
      try{
        if(!innerHtml || typeof innerHtml !== 'string') return innerHtml;
        if(innerHtml.indexOf('ASSISTANT_IFRAME_CLICK_BRIDGE') !== -1) return innerHtml;

        const bridge = (
          "\n<!-- ASSISTANT_IFRAME_CLICK_BRIDGE -->\n" +
          "<script>(function(){\n" +
          "  try{\n" +
          "    function closestEl(t){\n" +
          "      while(t && t.nodeType===1){\n" +
          "        const tag=(t.tagName||'').toLowerCase();\n" +
          "        if(tag==='a' || tag==='button' || t.getAttribute('role')==='button') return t;\n" +
          "        t = t.parentElement;\n" +
          "      }\n" +
          "      return null;\n" +
          "    }\n" +
          "    function getTxt(el){\n" +
          "      const txt=(el.innerText||el.textContent||'');\n" +
          "      const aria=(el.getAttribute('aria-label')||'');\n" +
          "      const title=(el.getAttribute('title')||'');\n" +
          "      const dt=(el.getAttribute('data-testid')||'');\n" +
          "      const cls=(el.getAttribute('class')||'');\n" +
          "      const href=(el.getAttribute('href')||'');\n" +
          "      return (txt+' '+aria+' '+title+' '+dt+' '+cls+' '+href).toLowerCase();\n" +
          "    }\n" +
          "    function isHome(el){\n" +
          "      const s=getTxt(el);\n" +
          "      if(/\bhome\b/.test(s) || /головн/.test(s)) return true;\n" +
          "      // common Gorilla/Gorilla UA homepage hrefs\n" +
          "      if(/gorilla\.(ua|com)/.test(s) && (/\/uk\/?(\b|$)/.test(s) || /\/ua\/?(\b|$)/.test(s) || /\/\s*$/.test(s))) return true;\n" +
          "      // bottom nav often uses just '/' or '/uk'\n" +
          "      if(/\bhref=/.test(s) && (/(^|\s)(\/|\.\/|#)($|\s)/.test(s) || /\shref=\"\/uk\"/.test(s))){}\n" +
          "      return false;\n" +
          "    }\n" +
          "    function isPromo(el){\n" +
          "      const s=getTxt(el);\n" +
          "      const promo = /promo|promocode|promotions|promotion|промо|промокод|акц|акції|акція|купон|coupon/.test(s);\n" +
          "      const bonus = /bonus|бонус/.test(s);\n" +
          "      return promo && !bonus;\n" +
          "    }\n" +
          "    function isBonus(el){\n" +
          "      const s=getTxt(el);\n" +
          "      return /bonus|бонус|free\s*spins|фріспіни|fs\b/.test(s);\n" +
          "    }\n" +
          "    function setNotifCount(n){\n" +
          "      try{\n" +
          "        const num = Math.max(0, parseInt(n,10) || 0);\n" +
          "        // Most pages have a counter span near bell\n" +
          "        const spans = document.querySelectorAll('span[class*="counter"],span[class*="Counter"],*[class*="counter__"],*[class*="Counter__"],*[data-assistant-notif]');\n" +
          "        spans && spans.forEach && spans.forEach(function(el){ try{ el.textContent = String(num); }catch(_e){} });\n" +
          "        // Try known bell container\n" +
          "        const bellRoot = document.getElementById('notification-service-navbar') || document.querySelector('[id*="notification"][class*="navbar"], [class*="notification"][class*="navbar"]');\n" +
          "        if(bellRoot){\n" +
          "          const b = bellRoot.querySelector('span,div');\n" +
          "          if(b && /\d/.test(b.textContent||'') ){ try{ b.textContent = String(num); }catch(_e){} }\n" +
          "        }\n" +
          "      }catch(_e){}\n" +
          "    }\n" +
          "    function pullNotifFromStorage(){\n" +
          "      try{\n" +
          "        const ps = JSON.parse(localStorage.getItem('BTLIDER_PLAYER_STATE')||'null');\n" +
          "        if(ps && typeof ps==='object'){ setNotifCount(ps.notifications); }\n" +
          "      }catch(_e){}\n" +
          "    }\n" +
          "    window.addEventListener('message', function(ev){\n" +
          "      const d = ev && ev.data;\n" +
          "      if(!d || typeof d !== 'object') return;\n" +
          "      if(d.type === 'ASSISTANT_SET_NOTIFICATIONS'){ setNotifCount(d.count); return; }\n" +
          "      if(d.type === 'ASSISTANT_NAV_HOME'){\n" +
          "        try{ if(typeof window.showScreen === 'function') window.showScreen('home'); }catch(_e){}\n" +
          "        try{ window.scrollTo(0,0); }catch(_e){}\n" +
          "      }\n" +
          "    }, false);\n" +
          "    document.addEventListener('click', function(e){\n" +
          "      const t=e && e.target;\n" +
          "      const el=closestEl(t);\n" +
          "      if(!el) return;\n" +
          "      // HOME\n" +
          "      if(isHome(el) && !isPromo(el) && !isBonus(el)){\n" +
          "        e.preventDefault();\n" +
          "        e.stopPropagation();\n" +
          "        if(typeof e.stopImmediatePropagation==='function') e.stopImmediatePropagation();\n" +
          "        try{ window.parent && window.parent.postMessage({type:'ASSISTANT_HOME_CLICK'}, '*'); }catch(_){ }\n" +
          "        return;\n" +
          "      }\n" +
          "      // PROMO\n" +
          "      if(isPromo(el)){\n" +
          "        e.preventDefault();\n" +
          "        e.stopPropagation();\n" +
          "        if(typeof e.stopImmediatePropagation==='function') e.stopImmediatePropagation();\n" +
          "        try{ window.parent && window.parent.postMessage({type:'ASSISTANT_PROMO_CLICK'}, '*'); }catch(_){ }\n" +
          "        return;\n" +
          "      }\n" +
          "      // BONUS\n" +
          "      if(isBonus(el)){\n" +
          "        e.preventDefault();\n" +
          "        e.stopPropagation();\n" +
          "        if(typeof e.stopImmediatePropagation==='function') e.stopImmediatePropagation();\n" +
          "        try{ window.parent && window.parent.postMessage({type:'ASSISTANT_BONUS_CLICK'}, '*'); }catch(_){ }\n" +
          "        return;\n" +
          "      }\n" +
          "    }, true);\n" +
          "    // Initial + periodic sync for bell counter\n" +
          "    pullNotifFromStorage();\n" +
          "    try{ setInterval(pullNotifFromStorage, 800); }catch(_e){}\n" +
          "  }catch(_e){}\n" +
          "})();<\/script>\n"
        );  );

        const bodyIdx = innerHtml.toLowerCase().lastIndexOf('</body>');
        if(bodyIdx !== -1){
          return innerHtml.slice(0, bodyIdx) + bridge + innerHtml.slice(bodyIdx);
        }
        const htmlIdx = innerHtml.toLowerCase().lastIndexOf('</html>');
        if(htmlIdx !== -1){
          return innerHtml.slice(0, htmlIdx) + bridge + innerHtml.slice(htmlIdx);
        }
        return innerHtml + bridge;
      }catch(e){
        return innerHtml;
      }
    }
    // <!-- /ASSISTANT PATCH: iframe click bridge injector -->
function loadFrames() {
      // If embedded base64 exists (legacy single-file mode), use srcdoc; otherwise load split pages (GitHub-friendly).
      if(GUEST_B64 && GUEST_B64.length > 1000 && AUTH_B64 && AUTH_B64.length > 1000){
        const guestHtml = b64ToUtf8(GUEST_B64);
        const authedHtml = b64ToUtf8(AUTH_B64);

        const guestHtmlPatched = injectIframeClickBridge(guestHtml);
        const authedHtmlPatched = injectIframeClickBridge(authedHtml);

        guestFrame.srcdoc = guestHtmlPatched;
        authedFrame.srcdoc = authedHtmlPatched;
      } else {
        guestFrame.removeAttribute('srcdoc');
        authedFrame.removeAttribute('srcdoc');
        guestFrame.src = 'guest.html';
        authedFrame.src = 'authed.html';
      }

      // ASSISTANT PATCH: install bonus click bridges after each iframe load
      guestFrame.onload = function(){ try { installBonusClickBridge(guestFrame, 'guest'); } catch(e){} };
      authedFrame.onload = function(){ try { installBonusClickBridge(authedFrame, 'authed'); } catch(e){} };

      setActive('guest');
      try{ syncNotifBadges(); }catch(e){}
    }

    // Switch to authed on successful auth signal from guest
    window.addEventListener('message', function(ev) {
      const d = ev && ev.data;
      if(!d || typeof d !== 'object') return;

      // Auth success: switch to authed + sync session
      if(d.type === 'ASSISTANT_AUTH_SUCCESS') {
        try {
          try { localStorage.setItem('isAuthed', '1'); } catch(e){}
          // Ensure baseline player state on first auth
          ensurePlayerState();
        } catch(e) {}

        setActive('authed');
        try {
          authedFrame.contentWindow && authedFrame.contentWindow.postMessage({type:'ASSISTANT_SET_SESSION'}, '*');
          // push bonus state to authed frame too
          broadcastBonusState();
          try{ syncNotifBadges(); }catch(e){}
        } catch(e) {}

      // ASSISTANT PATCH: HOME click -> open correct main page (guest/authed)
      if(d.type === 'ASSISTANT_HOME_CLICK'){
        try { promoModalClose(); } catch(e){}
        try { bonusModalClose(); } catch(e){}
        if(isAuthed()){
          try { setActive('authed'); } catch(e){}
          try { authedFrame && authedFrame.contentWindow && authedFrame.contentWindow.postMessage({type:'ASSISTANT_NAV_HOME'}, '*'); } catch(e){}
        } else {
          try { setActive('guest'); } catch(e){}
          try { guestFrame && guestFrame.contentWindow && guestFrame.contentWindow.postMessage({type:'ASSISTANT_NAV_HOME'}, '*'); } catch(e){}
        }
        try{ syncNotifBadges(); }catch(e){}
        return;
      }

        return;
      }

      
      // ASSISTANT PATCH: bridge request from embedded page (external-link mapping)
      if(d.type === 'ASSISTANT_BRIDGE' && d.kind){
        const k = String(d.kind||'').toLowerCase();
        if(k === 'promo'){
          if(isAuthed()) { promoModalOpen(); } else { openRegisterInGuest(); }
          return;
        }
        if(k === 'bonus'){
          if(isAuthed()) { bonusModalOpen(); } else { openRegisterInGuest(); }
          return;
        }
      }


      // Promo click from any embedded frame
      if(d.type === 'ASSISTANT_PROMO_CLICK') {
        if(isAuthed()) {
          promoModalOpen();
        } else {
          openRegisterInGuest();
        }
        return;
      }

// Bonus click from any embedded frame
      if(d.type === 'ASSISTANT_BONUS_CLICK') {
        if(isAuthed()) {
          bonusModalOpen();
        } else {
          openRegisterInGuest();
        }
        return;
      }

      // Optional: bonus iframe can report mutations (claim/progress). We persist and broadcast.
      if(d.type === 'ASSISTANT_BONUS_MUTATION' && d.payload && typeof d.payload === 'object') {
        try {
          // Merge minimal: replace bonuses object if provided
          if(d.payload.bonuses && typeof d.payload.bonuses === 'object') {
            lsSetJSON(LS_KEYS.bonuses, d.payload.bonuses);
          }
          if(d.payload.player && typeof d.payload.player === 'object') {
            lsSetJSON(LS_KEYS.player, d.payload.player);
          }
        } catch(e){}
        broadcastBonusState();
          try{ syncNotifBadges(); }catch(e){}
        return;
      }
            // ASSISTANT PATCH: bridge external promo/bonus links from embedded authed page
      if(d.type === 'ASSISTANT_BRIDGE') {
        const kind = (d.kind ? String(d.kind).toLowerCase() : '');
        if(kind === 'promo') {
          if(isAuthed()) { promoModalOpen(); } else { openRegisterInGuest(); }
          return;
        }
        if(kind === 'bonus') {
          if(isAuthed()) { try { bonusModalOpen(); } catch(_e){} } else { openRegisterInGuest(); }
          return;
        }
      }

// Promo click from any embedded frame
      if(d.type === 'ASSISTANT_PROMO_CLICK') {
        if(isAuthed()) {
          promoModalOpen();
        } else {
          openRegisterInGuest();
        }
        return;
      }

      // Promo iframe requests current state
      if(d.type === 'ASSISTANT_PROMO_REQUEST') {
        try {
          const st = ensurePlayerState();
          promoFrame && promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_PROMO_STATE', payload: st}, '*');
          try{ promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_OPEN', target:'promo'}, '*'); }catch(e){}
        } catch(e){}
        return;
      }

      // Apply promo code (demo logic) and sync with player/bonuses
      if(d.type === 'ASSISTANT_PROMO_APPLY') {
        try {
          const codeRaw = (d.code || '').toString().trim();
          const code = codeRaw.toUpperCase();
          const KNOWN = {
            'WELCOME100': { add: 100, msg: 'Вітальний бонус +100 (demo).' },
            'BONUS50': { add: 50, msg: 'Промо +50 (demo).' }
          };

          const st = ensurePlayerState();
          const player = st.player || {};
          const bonuses = st.bonuses || {};

          bonuses.promos = bonuses.promos && typeof bonuses.promos === 'object' ? bonuses.promos : { used: [], history: [] };
          bonuses.promos.used = Array.isArray(bonuses.promos.used) ? bonuses.promos.used : [];
          bonuses.promos.history = Array.isArray(bonuses.promos.history) ? bonuses.promos.history : [];

          if(!code){
            promoFrame && promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_PROMO_RESULT', ok:false, message:'Введи промокод.'}, '*');
            return;
          }

          if(bonuses.promos.used.includes(code)){
            promoFrame && promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_PROMO_RESULT', ok:false, message:'Цей промокод вже використано.'}, '*');
            return;
          }

          if(!KNOWN[code]){
            promoFrame && promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_PROMO_RESULT', ok:false, message:'Невірний промокод (demo).' }, '*');
            return;
          }

          // Apply
          bonuses.promos.used.push(code);
          bonuses.promos.history.push({ code, at: Date.now(), add: KNOWN[code].add });

          // Sync with player: add to balance (demo)
          player.balance = (Number(player.balance)||0) + Number(KNOWN[code].add||0);
          // Keep notifications stable baseline (2) unless bigger already
          player.notifications = Math.max(2, Number(player.notifications)||0);

          lsSetJSON(LS_KEYS.player, player);
          lsSetJSON(LS_KEYS.bonuses, bonuses);

          broadcastBonusState();
          try{ syncNotifBadges(); }catch(e){}
          broadcastPromoState();
          try{ syncNotifBadges(); }catch(e){}

          promoFrame && promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_PROMO_RESULT', ok:true, message:'Промокод застосовано: +' + KNOWN[code].add + ' (demo).' }, '*');
        } catch(e){
          try { promoFrame && promoFrame.contentWindow && promoFrame.contentWindow.postMessage({type:'ASSISTANT_PROMO_RESULT', ok:false, message:'Помилка застосування промокоду.' }, '*'); } catch(_){}
        }
        return;
      }


    });

    // If user reloads and had authed flag, keep guest as стартова (за вимогою), але можна автоперехід вимкнути/увімкнути тут.
    // We keep guest first always.
    

    /* ASSISTANT PATCH: перехоплення кліків PROMO/BONUS всередині authedFrame
       щоб не спрацьовували зовнішні "заглушки" та завжди працювало правило:
       гість -> реєстрація, авторизований -> відкриття модалок */
    function installAuthedNavBridge(){
      if(!authedFrame) return;

      function closestInteractive(start){
        let el = start;
        for(let i=0; i<8 && el; i++){
          if(el.tagName === 'A' || el.tagName === 'BUTTON' || (el.getAttribute && el.getAttribute('role') === 'button')) return el;
          el = el.parentElement;
        }
        return start;
      }

      function matchByTextOrHref(el, kind){
        if(!el) return false;
        const txt = ((el.textContent || '') + ' ' + (el.getAttribute ? (el.getAttribute('aria-label')||'') : '') + ' ' + (el.getAttribute ? (el.getAttribute('title')||'') : '')).trim().toLowerCase();
        const href = (el.getAttribute && el.getAttribute('href') ? (el.getAttribute('href')||'').toLowerCase() : '');
        if(kind === 'promo'){
          if(href && href.includes('promo')) return true;
          if(txt === 'промо' || txt.includes(' промо') || txt.includes('promo')) return true;
        }
        if(kind === 'bonus'){
          if(href && (href.includes('bonus') || href.includes('bonuses'))) return true;
          if(txt.includes('бонус')) return true;
        }
        return false;
      }

      function attach(){
        let doc;
        try { doc = authedFrame.contentDocument; } catch(e){ return; }
        if(!doc || !doc.documentElement) return;
        if(doc.documentElement.dataset && doc.documentElement.dataset.assistantNavBridge === '1') return;

        try { doc.documentElement.dataset.assistantNavBridge = '1'; } catch(e){}

        doc.addEventListener('click', function(e){
          const t = e.target;
          const el = closestInteractive(t instanceof Element ? t : null);

          // PROMO
          if(matchByTextOrHref(el, 'promo')){
            e.preventDefault();
            e.stopPropagation();
            if(typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();

            if(isAuthed()){
              try { promoModalOpen(); } catch(_){ /* noop */ }
            } else {
              try { openRegisterInGuest(); } catch(_){ /* noop */ }
            }
            return;
          }

          // BONUS
          if(matchByTextOrHref(el, 'bonus')){
            e.preventDefault();
            e.stopPropagation();
            if(typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();

            if(isAuthed()){
              try { bonusModalOpen(); } catch(_){ /* noop */ }
            } else {
              try { openRegisterInGuest(); } catch(_){ /* noop */ }
            }
            return;
          }
        }, true);
      }

      authedFrame.addEventListener('load', attach);
      // Best-effort immediate attach (if already loaded)
      try { attach(); } catch(e){}
    }


    installAuthedNavBridge();
    loadFrames();
  })();
  </script>

    <!-- ASSISTANT PATCH: BONUSES_MAX_V9 -->
    <style>
      /* ASSISTANT PATCH: бонуси - розширений список */
      #assistantBonusMaxRoot { padding: 12px; max-height: 56vh; overflow:auto; }
      #assistantBonusMaxRoot .abx-top { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:10px; }
      #assistantBonusMaxRoot .abx-search { flex:1; min-width: 120px; }
      #assistantBonusMaxRoot input[type="search"]{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.14); background:rgba(0,0,0,0.25); color:#fff; outline:none; }
      #assistantBonusMaxRoot .abx-filters { display:flex; gap:8px; flex-wrap:wrap; }
      #assistantBonusMaxRoot .abx-chip{ padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.14); background:rgba(0,0,0,0.18); color:#fff; font-size:12px; cursor:pointer; user-select:none; }
      #assistantBonusMaxRoot .abx-chip.active{ background:rgba(255,255,255,0.12); }
      #assistantBonusMaxRoot .abx-list{ display:grid; gap:10px; }
      #assistantBonusMaxRoot .abx-card{ border-radius:16px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.22); padding:12px; }
      #assistantBonusMaxRoot .abx-row{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; }
      #assistantBonusMaxRoot .abx-title{ font-weight:800; letter-spacing:0.2px; color:#fff; }
      #assistantBonusMaxRoot .abx-desc{ opacity:0.92; color:#e9e9e9; font-size:13px; margin-top:4px; }
      #assistantBonusMaxRoot .abx-meta{ opacity:0.9; color:#d6d6d6; font-size:12px; margin-top:6px; }
      #assistantBonusMaxRoot .abx-badge{ font-size:11px; padding:6px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.16); white-space:nowrap; }
      #assistantBonusMaxRoot .abx-actions{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
      #assistantBonusMaxRoot .abx-btn{ padding:10px 12px; border-radius:12px; border:0; cursor:pointer; font-weight:800; }
      #assistantBonusMaxRoot .abx-btn.primary{ background:rgba(180,255,40,0.85); color:#111; }
      #assistantBonusMaxRoot .abx-btn.ghost{ background:rgba(255,255,255,0.10); color:#fff; border:1px solid rgba(255,255,255,0.14); }
      #assistantBonusMaxRoot .abx-progress{ height:8px; border-radius:999px; background:rgba(255,255,255,0.10); overflow:hidden; margin-top:10px; }
      #assistantBonusMaxRoot .abx-progress > i{ display:block; height:100%; width:0%; background:rgba(180,255,40,0.75); }
      #assistantBonusMaxRoot .abx-foot{ opacity:0.75; font-size:11px; margin-top:8px; color:#d0d0d0; }
      #assistantBonusMaxRoot .abx-divider{ height:1px; background:rgba(255,255,255,0.10); margin:10px 0; }
      #assistantBonusMaxRoot .abx-note{ font-size:12px; opacity:0.9; color:#e8e8e8; }
    </style>

    <script>
/* ASSISTANT PATCH: BONUSES_MAX_V9 */
    (function(){
      'use strict';
      const LS_PLAYER = 'BTLIDER_PLAYER_STATE';
      const LS_BONUS  = 'BTLIDER_BONUS_STATE';
      const SCHEMA = 2;

      function safeJSONParse(v, fallback){ try{ return JSON.parse(v); } catch(e){ return fallback; } }
      function lsGet(key, fallback){ try{ const v = localStorage.getItem(key); return v==null?fallback:v; } catch(e){ return fallback; } }
      function lsSet(key, val){ try{ localStorage.setItem(key, val); } catch(e){} }
      function lsGetJSON(key, fallback){ return safeJSONParse(lsGet(key, ''), fallback); }
      function lsSetJSON(key, obj){ try{ lsSet(key, JSON.stringify(obj)); } catch(e){} }

      function ensureBaseState(){
        if(typeof window.ensurePlayerState === 'function'){
          try { return window.ensurePlayerState(); } catch(e){}
        }
        let p = lsGetJSON(LS_PLAYER, null);
        if(!p || typeof p !== 'object'){ p = { id:'demo', createdAt:Date.now(), balance:0, notifications:2 }; lsSetJSON(LS_PLAYER, p); }
        let b = lsGetJSON(LS_BONUS, null);
        if(!b || typeof b !== 'object'){ b = { schemaVersion:SCHEMA, updatedAt:Date.now(), items:[], claimed:[], promoApplied:[], stats:{deposits:0,wager:0,spins:0,days:0,streak:0,lastDay:0} }; lsSetJSON(LS_BONUS,b); }
        return { player:p, bonuses:b };
      }

      const TEMPLATE = [
        {id:'welcome_100', title:'Welcome: 100% до депозиту', desc:'Подвоюй перший депозит. Активується після внесення депозиту.', requirement:'deposits', goal:1, reward:'100% bonus', tags:['welcome','deposit'], status:'available', claimable:true},
        {id:'fs_week_game', title:'Гра тижня: 50 FS', desc:'Обери бонус і отримай фріспіни в грі тижня (demo).', requirement:'activate', goal:1, reward:'50 FS', tags:['fs','weekly'], status:'available', claimable:true},
        {id:'cashback_10', title:'Кешбек 10%', desc:'Повернення 10% від програшів за день (demo).', requirement:'wager', goal:2000, unit:'UAH', reward:'10% cashback', tags:['cashback','daily'], status:'active', claimable:false},
        {id:'reload_50', title:'Reload: 50% на 2-й депозит', desc:'Другий депозит дає 50% бонус.', requirement:'deposits', goal:2, reward:'50% bonus', tags:['deposit'], status:'locked', claimable:false},
        {id:'reload_25', title:'Reload: 25% на 3-й депозит', desc:'Третій депозит дає 25% бонус.', requirement:'deposits', goal:3, reward:'25% bonus', tags:['deposit'], status:'locked', claimable:false},

        {id:'wager_15x', title:'Вейджер 15x', desc:'Відіграй бонус: загальний відіграш 15x (demo-логіка).', requirement:'wager', goal:15000, unit:'UAH', reward:'Unlock payouts', tags:['wager'], status:'active', claimable:false},
        {id:'mission_50_spins', title:'Місія: 50 спінів', desc:'Зроби 50 обертань у будь-яких слотах.', requirement:'spins', goal:50, reward:'20 FS', tags:['mission'], status:'available', claimable:false},
        {id:'mission_200_spins', title:'Місія: 200 спінів', desc:'Зроби 200 обертань.', requirement:'spins', goal:200, reward:'x5 booster', tags:['mission'], status:'locked', claimable:false},
        {id:'mission_10000_wager', title:'Місія: Відіграш 10 000', desc:'Накрути ставок на 10 000 (demo).', requirement:'wager', goal:10000, unit:'UAH', reward:'Mystery bonus', tags:['mission'], status:'available', claimable:false},

        {id:'vip_bronze', title:'VIP Bronze', desc:'Відкрий Bronze після 3 депозитів.', requirement:'deposits', goal:3, reward:'VIP Bronze perks', tags:['vip'], status:'locked', claimable:false},
        {id:'vip_silver', title:'VIP Silver', desc:'Відкрий Silver після 7 депозитів.', requirement:'deposits', goal:7, reward:'VIP Silver perks', tags:['vip'], status:'locked', claimable:false},
        {id:'vip_gold', title:'VIP Gold', desc:'Відкрий Gold після 15 депозитів.', requirement:'deposits', goal:15, reward:'VIP Gold perks', tags:['vip'], status:'locked', claimable:false},

        {id:'daily_login', title:'Щоденний бонус', desc:'Заходь щодня та забирай нагороду (серія).', requirement:'days', goal:1, reward:'Daily reward', tags:['daily'], status:'available', claimable:true},
        {id:'streak_3', title:'Серія входів: 3 дні', desc:'Утримай серію 3 дні.', requirement:'streak', goal:3, reward:'30 FS', tags:['daily'], status:'available', claimable:false},
        {id:'streak_7', title:'Серія входів: 7 днів', desc:'Утримай серію 7 днів.', requirement:'streak', goal:7, reward:'100 FS', tags:['daily'], status:'locked', claimable:false},

        {id:'promo_code_any', title:'Промокод', desc:'Активуй будь-який промокод у розділі “Промо”.', requirement:'promo', goal:1, reward:'Promo reward', tags:['promo'], status:'available', claimable:false},
        {id:'promo_weekend', title:'Weekend Boost', desc:'Активуй промо на вихідні (demo).', requirement:'promo', goal:1, reward:'x2 weekend', tags:['promo'], status:'locked', claimable:false},

        {id:'tour_daily', title:'Щоденний турнір', desc:'Візьми участь у турнірі дня (demo-реєстрація).', requirement:'activate', goal:1, reward:'Leaderboard entry', tags:['event'], status:'available', claimable:true},
        {id:'event_mystery', title:'Mystery Monday', desc:'Отримай таємний бонус у понеділок (demo).', requirement:'activate', goal:1, reward:'Mystery', tags:['event'], status:'available', claimable:true},

        {id:'fs_pack_10', title:'Пачка: 10 FS', desc:'Дрібний бонус для розігріву.', requirement:'activate', goal:1, reward:'10 FS', tags:['fs'], status:'available', claimable:true},
        {id:'fs_pack_25', title:'Пачка: 25 FS', desc:'Середній бонус.', requirement:'activate', goal:1, reward:'25 FS', tags:['fs'], status:'available', claimable:true},
        {id:'fs_pack_75', title:'Пачка: 75 FS', desc:'Велика пачка (demo).', requirement:'activate', goal:1, reward:'75 FS', tags:['fs'], status:'locked', claimable:false},

        {id:'cashback_5', title:'Кешбек 5%', desc:'М’який кешбек (demo).', requirement:'wager', goal:1000, unit:'UAH', reward:'5% cashback', tags:['cashback'], status:'available', claimable:false},
        {id:'cashback_20', title:'Кешбек 20%', desc:'Підвищений кешбек (demo).', requirement:'wager', goal:20000, unit:'UAH', reward:'20% cashback', tags:['cashback'], status:'locked', claimable:false},

        {id:'ref_1', title:'Реферал: 1 друг', desc:'Запроси 1 друга (demo).', requirement:'activate', goal:1, reward:'Referral bonus', tags:['ref'], status:'available', claimable:true},
        {id:'ref_5', title:'Реферал: 5 друзів', desc:'Запроси 5 друзів (demo).', requirement:'activate', goal:1, reward:'Big referral', tags:['ref'], status:'locked', claimable:false}
      ];

      function mergeTemplate(prev){
        const prevMap = new Map(((prev && prev.items) ? prev.items : []).map(x => [String(x.id||''), x]));
        const items = TEMPLATE.map(t => {
          const old = prevMap.get(t.id);
          const merged = Object.assign({}, t, old||{});
          merged.id = t.id;
          merged.title = t.title;
          merged.desc = merged.desc || t.desc;
          if(typeof merged.progress !== 'number') merged.progress = (old && typeof old.progress==='number') ? old.progress : 0;
          if(typeof merged.goal !== 'number') merged.goal = t.goal;
          if(typeof merged.claimable !== 'boolean') merged.claimable = !!t.claimable;
          if(!merged.status) merged.status = t.status || 'available';
          if(!Array.isArray(merged.tags)) merged.tags = t.tags || [];
          return merged;
        });
        return {
          schemaVersion: SCHEMA,
          updatedAt: Date.now(),
          items,
          claimed: Array.isArray(prev && prev.claimed) ? prev.claimed : [],
          promoApplied: Array.isArray(prev && prev.promoApplied) ? prev.promoApplied : [],
          stats: (prev && typeof prev.stats==='object' && prev.stats) ? prev.stats : {deposits:0,wager:0,spins:0,days:0,streak:0,lastDay:0}
        };
      }

      function upgradeIfNeeded(){
        const st = ensureBaseState();
        const b = lsGetJSON(LS_BONUS, null);
        const need = (!b || typeof b!=='object' || b.schemaVersion!==SCHEMA || !Array.isArray(b.items) || b.items.length < 18);
        if(need){
          const merged = mergeTemplate(b||st.bonuses||null);
          lsSetJSON(LS_BONUS, merged);
        }
      }

      function getState(){
        const st = ensureBaseState();
        const b = lsGetJSON(LS_BONUS, st.bonuses||null) || st.bonuses;
        return { player: st.player, bonuses: b };
      }

      function setNotifCount(next){
        try{
          const p = lsGetJSON(LS_PLAYER, null) || {};
          p.notifications = Math.max(0, parseInt(next,10)||0);
          lsSetJSON(LS_PLAYER, p);
          if(typeof window.syncNotifBadges === 'function'){ try{ window.syncNotifBadges(); }catch(e){} }
        }catch(e){}
      }

      function addNotif(delta){
        try{
          const st = getState();
          const cur = Math.max(0, parseInt(st.player && st.player.notifications,10)||0);
          setNotifCount(cur + (parseInt(delta,10)||0));
        }catch(e){}
      }

      function fmtProgress(x){ return (typeof x==='number' && isFinite(x)) ? x : 0; }
      function pct(p,g){ if(!g) return 0; const v = Math.max(0, Math.min(1, (p||0)/g)); return Math.round(v*100); }

      function computeBadge(item){
        const s = String(item.status||'').toLowerCase();
        if(s==='claimed') return 'Забрано';
        if(s==='completed') return 'Готово';
        if(s==='active') return 'Активний';
        if(s==='available') return 'Доступний';
        if(s==='locked') return 'Заблоковано';
        if(s==='expired') return 'Завершено';
        return item.status||'';
      }

      function canClaim(item){
        const s = String(item.status||'').toLowerCase();
        if(s==='claimed' || s==='locked') return false;
        if(item.claimable) return true;
        return fmtProgress(item.progress) >= (item.goal||0) && (item.goal||0)>0;
      }

      function normalizeProgressByStats(b){
        const stats = b.stats || (b.stats = {deposits:0,wager:0,spins:0,days:0,streak:0,lastDay:0});
        const nowDay = Math.floor(Date.now()/86400000);
        if(stats.lastDay !== nowDay){
          stats.days = (stats.days||0) + 1;
          if(stats.lastDay && stats.lastDay === nowDay-1){
            stats.streak = (stats.streak||0) + 1;
          } else {
            stats.streak = 1;
          }
          stats.lastDay = nowDay;
        }
        (b.items||[]).forEach(it=>{
          const req = it.requirement;
          if(req==='deposits') it.progress = Math.max(it.progress||0, stats.deposits||0);
          if(req==='wager') it.progress = Math.max(it.progress||0, stats.wager||0);
          if(req==='spins') it.progress = Math.max(it.progress||0, stats.spins||0);
          if(req==='days') it.progress = Math.max(it.progress||0, stats.days||0);
          if(req==='streak') it.progress = Math.max(it.progress||0, stats.streak||0);
          if(req==='promo') it.progress = Math.max(it.progress||0, (b.promoApplied||[]).length||0);
          if(it.goal && fmtProgress(it.progress) >= it.goal && sLower(it.status)!=='claimed'){
            if(sLower(it.status)!=='completed' && !it.claimable){
              it.status = 'completed';
            }
          }
        });
      }

      function sLower(x){ return String(x||'').toLowerCase(); }

      function saveBonuses(b){
        b.updatedAt = Date.now();
        lsSetJSON(LS_BONUS, b);
        if(typeof window.syncNotifBadges === 'function'){ try{ window.syncNotifBadges(); }catch(e){} }
      }

      function claimBonus(id){
        const st = getState();
        const b = st.bonuses;
        const it = (b.items||[]).find(x=>String(x.id)===String(id));
        if(!it || !canClaim(it)) return;
        it.status = 'claimed';
        it.claimedAt = Date.now();
        b.claimed = Array.isArray(b.claimed) ? b.claimed : [];
        if(!b.claimed.includes(it.id)) b.claimed.push(it.id);
        saveBonuses(b);
        addNotif(-1);
      }

      function activateBonus(id){
        const st = getState();
        const b = st.bonuses;
        const it = (b.items||[]).find(x=>String(x.id)===String(id));
        if(!it) return;
        const s = sLower(it.status);
        if(s==='locked' || s==='claimed') return;
        it.status = 'active';
        it.activatedAt = Date.now();
        saveBonuses(b);
        addNotif(1);
      }

      function renderBonusesIntoModal(){
        const modal = document.getElementById('bonusModal');
        if(!modal) return;
        const panel = modal.querySelector('.assistant-modal-panel') || modal;

        let root = panel.querySelector('#assistantBonusMaxRoot');
        if(!root){
          root = document.createElement('div');
          root.id = 'assistantBonusMaxRoot';
          const iframe = panel.querySelector('iframe');
          if(iframe && iframe.parentNode){
            iframe.parentNode.insertBefore(root, iframe);
            const div = document.createElement('div');
            div.className = 'abx-divider';
            iframe.parentNode.insertBefore(div, iframe);
            try{ iframe.style.height = '28vh'; iframe.style.borderRadius = '14px'; iframe.style.overflow='hidden'; }catch(e){}
          } else {
            panel.appendChild(root);
          }
        }

        const st = getState();
        const b = st.bonuses;
        normalizeProgressByStats(b);
        saveBonuses(b);

        const UI = (window.__BTLIDER_BONUS_UI ||= { q:'', filter:'all' });
        const chips = [['all','Усі'],['available','Доступні'],['active','Активні'],['completed','Готові'],['claimed','Забрані'],['locked','Locked']];

        function matchFilter(it){
          const f = UI.filter;
          const s = sLower(it.status);
          return (f==='all') ? true : (s===f);
        }
        function matchSearch(it){
          const q = (UI.q||'').trim().toLowerCase();
          if(!q) return true;
          return (String(it.title||'')+' '+String(it.desc||'')+' '+(it.tags||[]).join(' ')).toLowerCase().includes(q);
        }

        const items = (b.items||[]).filter(it=>matchFilter(it) && matchSearch(it));

        root.innerHTML = `
          <div class="abx-top">
            <div class="abx-search"><input type="search" placeholder="Пошук бонусів..." value="${(UI.q||'').replace(/"/g,'&quot;')}" aria-label="Пошук бонусів"></div>
          </div>
          <div class="abx-filters">
            ${chips.map(([k,lab])=>`<div class="abx-chip ${UI.filter===k?'active':''}" data-chip="${k}">${lab}</div>`).join('')}
          </div>
          <div class="abx-divider"></div>
          <div class="abx-note">Стан бонусів збережено локально і синхронізується з гравцем (demo). Прогрес: депозити/спіни/відіграш/серія входів.</div>
          <div class="abx-divider"></div>
          <div class="abx-list"></div>
          <div class="abx-foot">* Це демо-режим. Реальні виплати/платежі не виконуються.</div>
        `;

        const list = root.querySelector('.abx-list');

        const cardHTML = (it)=>{
          const p = fmtProgress(it.progress);
          const g = it.goal||0;
          const percent = pct(p,g);
          const badge = computeBadge(it);
          const unit = it.unit ? (' '+it.unit) : '';
          const progText = g ? `${Math.min(p,g)} / ${g}${unit}` : (it.requirement==='activate' ? 'Натисни “Активувати”' : '');
          const claim = canClaim(it);
          const locked = (sLower(it.status)==='locked');
          const claimed = (sLower(it.status)==='claimed');

          return `
            <div class="abx-card" data-id="${it.id}">
              <div class="abx-row">
                <div style="min-width:0;flex:1">
                  <div class="abx-title">${it.title}</div>
                  <div class="abx-desc">${it.desc || ''}</div>
                  <div class="abx-meta">Нагорода: <b>${it.reward||'—'}</b>${g?` • Прогрес: <b>${progText}</b>`:''}</div>
                </div>
                <div class="abx-badge">${badge}</div>
              </div>
              ${g ? `<div class="abx-progress"><i style="width:${percent}%"></i></div>` : ``}
              <div class="abx-actions">
                ${(!locked && !claimed) ? `<button class="abx-btn ghost" data-act="activate" data-id="${it.id}">Активувати</button>` : ''}
                ${claim ? `<button class="abx-btn primary" data-act="claim" data-id="${it.id}">Забрати</button>` : ''}
                ${locked ? `<button class="abx-btn ghost" data-act="how" data-id="${it.id}">Як відкрити</button>` : ''}
              </div>
            </div>
          `;
        };

        list.innerHTML = items.map(cardHTML).join('') || '<div class="abx-note">Нічого не знайдено.</div>';

        const search = root.querySelector('input[type="search"]');
        search && search.addEventListener('input', (e)=>{ UI.q = String(e.target.value||''); renderBonusesIntoModal(); }, { passive:true });

        root.querySelectorAll('.abx-chip').forEach(ch=>{
          ch.addEventListener('click', ()=>{
            UI.filter = ch.getAttribute('data-chip')||'all';
            renderBonusesIntoModal();
          });
        });

        root.querySelectorAll('button[data-act]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const act = btn.getAttribute('data-act');
            const id = btn.getAttribute('data-id');
            if(act==='claim') claimBonus(id);
            else if(act==='activate') activateBonus(id);
            else if(act==='how'){ try{ alert('Виконай умову бонусу (депозити/спіни/відіграш) або активуй промокод у “Промо”.'); }catch(e){} }
            renderBonusesIntoModal();
          });
        });
      }

      function observeBonusModal(){
        const modal = document.getElementById('bonusModal');
        if(!modal) return;
        const obs = new MutationObserver(()=>{
          if(modal.classList.contains('open')){
            try{ renderBonusesIntoModal(); }catch(e){}
          }
        });
        obs.observe(modal, { attributes:true, attributeFilter:['class'] });
      }

      function onMessage(e){
        const d = e && e.data;
        if(!d || typeof d !== 'object') return;
        if(d.type==='BTLIDER_DEPOSIT' || d.type==='ASSISTANT_DEPOSIT'){
          const amt = Math.max(0, Number(d.amount||0));
          const st = getState();
          st.bonuses.stats.deposits = (st.bonuses.stats.deposits||0) + 1;
          st.bonuses.stats.wager = (st.bonuses.stats.wager||0) + Math.max(0, amt*10);
          saveBonuses(st.bonuses);
          addNotif(1);
        }
        if(d.type==='BTLIDER_BET' || d.type==='BTLIDER_WAGER'){
          const amt = Math.max(0, Number(d.amount||0));
          const st = getState();
          st.bonuses.stats.wager = (st.bonuses.stats.wager||0) + amt;
          saveBonuses(st.bonuses);
        }
        if(d.type==='BTLIDER_SPIN'){
          const st = getState();
          st.bonuses.stats.spins = (st.bonuses.stats.spins||0) + 1;
          saveBonuses(st.bonuses);
        }
        if(d.type==='ASSISTANT_PROMO_APPLIED'){
          const code = String(d.code||'').trim();
          const st = getState();
          st.bonuses.promoApplied = Array.isArray(st.bonuses.promoApplied) ? st.bonuses.promoApplied : [];
          if(code && !st.bonuses.promoApplied.includes(code)) st.bonuses.promoApplied.push(code);
          saveBonuses(st.bonuses);
          addNotif(1);
        }
      }

      function install(){
        try{
          upgradeIfNeeded();
          observeBonusModal();
          window.addEventListener('message', onMessage);
          const modal = document.getElementById('bonusModal');
          if(modal && modal.classList.contains('open')) renderBonusesIntoModal();
        }catch(e){}
      }

      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', install, { once:true });
      } else {
        install();
      }
    })();
    </script>

</body>
</html>
