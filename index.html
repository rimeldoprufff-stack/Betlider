<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>BTLIDER</title>
  <style>
    html,body{height:100%;margin:0;background:#05070b;color:#e8eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    #app{position:fixed;inset:0;display:flex;flex-direction:column}
    #frameWrap{position:relative;flex:1 1 auto;min-height:0}
    #appFrame{position:absolute;inset:0;width:100%;height:100%;border:0;background:transparent}
    #splash{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;
      background:radial-gradient(1200px 800px at 50% 30%, rgba(44,56,86,.45), rgba(10,12,18,.94));
      z-index:50}
    #progressBar{width:min(520px,86vw);height:10px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden}
    #progressBar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#6ea8ff,#9b7bff,#ff6ea8);transition:width .25s ease}
    #progressText{opacity:.85;font-size:14px}
    #logPanel{position:fixed;left:0;top:0;bottom:0;width:min(360px,92vw);max-width:92vw;background:rgba(6,8,12,.92);
      border-right:1px solid rgba(255,255,255,.08);backdrop-filter: blur(10px);z-index:80;display:flex;flex-direction:column}
    #logHdr{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
    #logHdr strong{font-size:13px;opacity:.9}
    .lb{margin-left:auto;display:flex;gap:6px}
    .btn{font-size:12px;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#e8eefc}
    .btn:active{transform:scale(.98)}
    #logBody{padding:10px;overflow:auto;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;line-height:1.35}
    #logBody .err{color:#ff8f8f}
    #logBody .warn{color:#ffd28f}
    #logBody .ok{color:#9bffb5}
    #logHint{padding:8px 10px;border-top:1px solid rgba(255,255,255,.08);font-size:11px;opacity:.75}
    #logPanel.is-hidden{display:none}
    #logToggle{position:fixed;left:10px;bottom:10px;z-index:90}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="app">
    <div id="frameWrap">
      <iframe id="appFrame" title="BTLIDER App" src="about:blank"></iframe>
      <div id="splash" aria-live="polite">
        <div style="font-weight:700;letter-spacing:.3px">BTLIDER</div>
        <div id="progressBar"><i id="progressFill"></i></div>
        <div id="progressText">Завантаження 0%</div>
      </div>
    </div>
  </div>

  <div id="logPanel">
    <div id="logHdr">
      <strong>LOG</strong>
      <div class="lb">
        <button class="btn" id="copyLogBtn">COPY</button>
        <button class="btn" id="clearLogBtn">CLEAR</button>
        <button class="btn" id="hideLogBtn">HIDE</button>
      </div>
    </div>
    <div id="logBody"></div>
    <div id="logHint">CTRL: COPY/CLEAR/HIDE • Якщо зависло — скинь COPY сюди.</div>
  </div>
  <button class="btn" id="logToggle">LOG</button>

<script>
(() => {
  const BUILD = "BTLIDER v22 build 2026-02-03 23:51:49 UTC";
  const SB_URL = "https://vshzqiqppgitnhuqmcgn.supabase.co";
  const SB_ANON = "sb_publishable_DJSaoIKQQPU_5rio3xt8ZQ_8H_6Xs4X";
  const BASE_PATH = "/Betlider/"; // GitHub Pages repo path
  const frame = document.getElementById('appFrame');
  const splash = document.getElementById('splash');
  const fill = document.getElementById('progressFill');
  const ptxt = document.getElementById('progressText');

  const logPanel = document.getElementById('logPanel');
  const logBody = document.getElementById('logBody');
  const copyBtn = document.getElementById('copyLogBtn');
  const clearBtn = document.getElementById('clearLogBtn');
  const hideBtn = document.getElementById('hideLogBtn');
  const toggleBtn = document.getElementById('logToggle');

  const lines = [];
  function stamp() {
    const d = new Date();
    return d.toTimeString().slice(0,8);
  }
  function addLine(level, msg, data) {
    const t = `[${stamp()}] ${msg}` + (data !== undefined ? ` | ${JSON.stringify(data)}` : '');
    lines.push(t);
    const div = document.createElement('div');
    if(level==='err') div.className='err';
    if(level==='warn') div.className='warn';
    if(level==='ok') div.className='ok';
    div.textContent = t;
    logBody.appendChild(div);
    logBody.scrollTop = logBody.scrollHeight;
  }
  // Compatibility: some old code may call log(...)
  window.log = (...a) => addLine('ok', a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' '));
  window.__BTLIDER_LOG = (lvl,msg,data) => addLine(lvl,msg,data);

  function setProgress(p) {
    const pct = Math.max(0, Math.min(100, p|0));
    fill.style.width = pct + '%';
    ptxt.textContent = `Завантаження ${pct}%`;
    if(pct >= 100) {
      setTimeout(() => splash.style.display='none', 150);
    }
  }

  copyBtn.onclick = async () => {
    const txt = lines.join('\n');
    try { await navigator.clipboard.writeText(txt); addLine('ok','COPIED'); }
    catch(e) { addLine('warn','COPY_FAIL', String(e && e.message || e)); }
  };
  clearBtn.onclick = () => { lines.length=0; logBody.textContent=''; addLine('ok','CLEARED'); };
  hideBtn.onclick = () => logPanel.classList.add('is-hidden');
  toggleBtn.onclick = () => logPanel.classList.toggle('is-hidden');

  // Clean offline leftovers that could fake auth
  const offlineKeys = ['gorilla_current','gorilla_users','BTLIDER_AUTH','BTLIDER_AUTHED','BTLIDER_DEMO_USER'];
  offlineKeys.forEach(k => {
    if(localStorage.getItem(k) !== null) {
      localStorage.removeItem(k);
      addLine('warn', `CLEAN: removed ${k}`);
    }
  });

  addLine('ok', 'BUILD: ' + BUILD);

  // Global error hooks
  window.addEventListener('error', (e) => {
    addLine('err', 'ERROR: ' + (e.message || 'unknown'), {filename:e.filename, lineno:e.lineno, colno:e.colno});
  });
  window.addEventListener('unhandledrejection', (e) => {
    addLine('err', 'UNHANDLED_REJECTION', String(e.reason && e.reason.message || e.reason || 'unknown'));
  });

  // Supabase client
  const supabase = window.supabase.createClient(SB_URL, SB_ANON, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true
    }
  });
  window.BTLIDER = window.BTLIDER || {};
  window.BTLIDER.supabase = supabase;

  async function getSessionSafe(source) {
    try {
      const { data, error } = await supabase.auth.getSession();
      if(error) addLine('err','AUTH_ERR getSession', error.message);
      return data && data.session ? data.session : null;
    } catch(e) {
      addLine('err','AUTH_ERR getSession EX', String(e && e.message || e));
      return null;
    }
  }

  function navTo(path) {
    frame.src = path;
    addLine('ok', 'route -> ' + path);
    setProgress(30);
  }

  function setAuthed(isAuthed, source) {
    window.__BTLIDER_AUTHED = !!isAuthed;
    addLine('ok', 'AUTH: session=' + (isAuthed ? 'YES' : 'NO'), {source});
  }

  // Bridge API for iframes
  window.BTLIDER.Auth = {
    async register(email, password) {
      addLine('ok','AUTH_CALL: signUp', {email});
      const { data, error } = await supabase.auth.signUp({
        email, password,
        options: {
          emailRedirectTo: location.origin + BASE_PATH + 'index.html'
        }
      });
      if(error) {
        addLine('err','AUTH_ERR: signUp', error.message);
        throw error;
      }
      // When confirm email is OFF => session may be present
      const sess = data && data.session ? data.session : null;
      addLine('ok','AUTH_RES: signUp', {session: !!sess, user: !!(data && data.user)});
      return data;
    },
    async login(email, password) {
      addLine('ok','AUTH_CALL: signInWithPassword', {email});
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) {
        addLine('err','AUTH_ERR: signInWithPassword', error.message);
        throw error;
      }
      addLine('ok','AUTH_RES: signInWithPassword', {session: !!(data && data.session)});
      return data;
    },
    async logout() {
      addLine('ok','AUTH_CALL: signOut');
      const { error } = await supabase.auth.signOut();
      if(error) {
        addLine('err','AUTH_ERR: signOut', error.message);
        throw error;
      }
      addLine('ok','AUTH_RES: signOut');
      return true;
    },
    async session() {
      return await getSessionSafe('api');
    }
  };

  // Auth state changes
  supabase.auth.onAuthStateChange((evt, session) => {
    addLine('ok', 'AUTH_EVT: ' + evt, session ? {user:session.user && session.user.email} : null);
    setAuthed(!!session, evt);
    // notify iframe
    try {
      frame.contentWindow && frame.contentWindow.postMessage({type:'BTLIDER_AUTH_CHANGED', authed: !!session}, '*');
    } catch(_e) {}
    // route
    if(session) {
      navTo('authed.html');
      setProgress(80);
    } else {
      navTo('guest.html');
      setProgress(60);
    }
  });

  // Boot routing (lazy iframe to avoid freeze)
  (async () => {
    setProgress(5);
    // Let first frame paint
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    setProgress(12);

    const sess = await getSessionSafe('boot');
    setAuthed(!!sess, 'boot');
    // Delay iframe heavy load a bit to avoid jank
    setTimeout(() => {
      if(sess) navTo('authed.html'); else navTo('guest.html');
      setProgress(65);
    }, 50);

    // If iframe doesn't load in time, show error but keep log
    const t0 = Date.now();
    let loaded = false;
    frame.addEventListener('load', () => {
      loaded = true;
      setProgress(100);
    }, { once:true });
    setTimeout(() => {
      if(!loaded) {
        addLine('warn','WARN: iframe load timeout', {ms: Date.now()-t0, src: frame.src});
        // Keep splash but allow user to click LOG and see errors
      }
    }, 8000);
  })();
})();
</script>
</body>
</html>
