<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Burning Chilli X</title>
<style>
  :root{
    --bg0:#050506;
    --bg1:#0b0b0e;
    --gold1:#f7d77c;
    --gold2:#b8841f;
    --gold3:#6d3b08;
    --panel:#140b06;
    --panel2:#2a1408;
    --uiText:#f2f2f2;
    --muted:#b9b9b9;
    --green:#b7ff3a;
    --shadow: rgba(0,0,0,.55);
    --safeT: env(safe-area-inset-top, 0px);
    --safeB: env(safe-area-inset-bottom, 0px);
    --safeL: env(safe-area-inset-left, 0px);
    --safeR: env(safe-area-inset-right, 0px);
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  html,body{height:100%; margin:0; background: #000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--uiText);}
  body{overflow:hidden;}
  button{font:inherit;}
  #app{
    position:fixed; inset:0;
    background: radial-gradient(1200px 800px at 50% 35%, #101012 0%, #050506 55%, #000 100%);
  }

  /* Top bar (original-like) */
  .topbar{
    position:absolute; left:0; right:0; top:0;
    height:56px;
    padding-top: var(--safeT);
    display:flex; align-items:center;
    gap:10px;
    padding-left: calc(12px + var(--safeL));
    padding-right: calc(12px + var(--safeR));
    background: linear-gradient(#0a0a0c, #060607);
    border-bottom: 1px solid rgba(255,255,255,.06);
    z-index:30;
  }
  .tb-left{
    width:44px; height:44px; display:grid; place-items:center;
    border-radius: 10px;
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(255,255,255,.08);
    box-shadow: 0 8px 18px rgba(0,0,0,.35);
    cursor:pointer;
  }
  .tb-left:active{transform: translateY(1px);}
  .tb-title{
    flex:1;
    text-align:center;
    font-weight:650;
    letter-spacing:.2px;
    opacity:.95;
    transform: translateX(-22px); /* compensate left button width */
    pointer-events:none;
  }
  .tb-right{
    width:110px; display:flex; justify-content:flex-end;
  }
  .deposit{
    height:36px; padding:0 14px;
    border-radius: 18px;
    background: linear-gradient(#b7ff3a, #79d800);
    border: 0;
    color:#0c0f05;
    font-weight:750;
    box-shadow: 0 10px 22px rgba(115, 255, 0, .18), 0 8px 18px rgba(0,0,0,.35);
    cursor:pointer;
  }
  .deposit:active{transform: translateY(1px); filter:saturate(1.05);}

  /* Screens */
  .screen{
    position:absolute; inset:0;
    padding-top: calc(56px + var(--safeT));
    padding-bottom: var(--safeB);
  }
  .hidden{display:none !important;}

  /* Launch screen */
  #launch{
    display:flex; align-items:center; justify-content:center;
    background: radial-gradient(900px 700px at 50% 45%, rgba(120,20,20,.35) 0%, rgba(0,0,0,0) 55%),
                radial-gradient(1400px 1000px at 50% 35%, #0c0c0e 0%, #050506 55%, #000 100%);
  }
  .launch-wrap{
    width:min(520px, 92vw);
    display:flex; flex-direction:column; align-items:center;
    gap:22px;
    padding: 12px 0 0 0;
  }
  .logo-block{
    width: min(520px, 92vw);
    aspect-ratio: 1.35 / 1;
    display:grid;
    place-items:center;
    position:relative;
  }
  .logo-canvas{
    width:100%; height:100%;
    filter: drop-shadow(0 22px 40px rgba(0,0,0,.7));
  }

  .bgaming{
    display:flex; gap:6px; align-items:flex-end;
    margin-top: -12px;
    user-select:none;
  }
  .bgaming span{
    width: 26px; height: 44px;
    display:grid; place-items:center;
    border-radius: 4px;
    background: linear-gradient(#1a1a1f,#0d0d10);
    border:1px solid rgba(255,255,255,.10);
    box-shadow: 0 10px 22px rgba(0,0,0,.45);
    font-weight:800;
    letter-spacing: .5px;
  }
  .bgaming span.b{
    background: linear-gradient(#f2d56b,#b78618);
    border: 1px solid rgba(255,255,255,.12);
    color:#111;
  }
  .bgaming span.flip{
    position:relative;
    overflow:hidden;
  }
  .bgaming span.flip::after{
    content: attr(data-char);
    position:absolute; inset:0;
    display:grid; place-items:center;
    transform: translateY(110%);
    opacity:.9;
    filter: blur(.0px);
    animation: flip 1.1s ease-in-out infinite;
  }
  .bgaming span.flip::before{
    content: attr(data-char);
    position:absolute; inset:0;
    display:grid; place-items:center;
    transform: translateY(-110%);
    opacity:.35;
    animation: flip2 1.1s ease-in-out infinite;
  }
  @keyframes flip{
    0%{transform: translateY(110%); opacity:.0}
    30%{transform: translateY(0%); opacity:1}
    60%{transform: translateY(0%); opacity:1}
    100%{transform: translateY(-110%); opacity:.0}
  }
  @keyframes flip2{
    0%{transform: translateY(-110%); opacity:.0}
    30%{transform: translateY(0%); opacity:.25}
    60%{transform: translateY(0%); opacity:.25}
    100%{transform: translateY(110%); opacity:.0}
  }
  .loading{
    margin-top: 6px;
    display:flex; flex-direction:column; align-items:center;
    gap:10px;
    opacity:.85;
  }
  .dot{
    width:18px; height:18px; border-radius: 50%;
    background: #dd2a2a;
    box-shadow: 0 0 0 6px rgba(221,42,42,.08), 0 0 26px rgba(221,42,42,.25);
    animation: pulse 1.1s ease-in-out infinite;
  }
  @keyframes pulse{
    0%{transform: scale(.88); opacity:.75}
    50%{transform: scale(1.12); opacity:1}
    100%{transform: scale(.88); opacity:.75}
  }
  .loading label{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    letter-spacing: 1.2px;
    color: rgba(255,255,255,.55);
    font-size: 14px;
  }
  .tapto{
    margin-top: 14px;
    font-size: 13px;
    color: rgba(255,255,255,.45);
    letter-spacing:.5px;
    user-select:none;
  }
  /* <!-- ASSISTANT PATCH: v11 make loading feel instant --> */
  #launch.ready .loading{opacity:.18;}
  #launch.ready .loading label{opacity:0;}
  #launch.ready .tapto{color: rgba(255,255,255,.78);}


  /* Game screen */
  #game{
    background: radial-gradient(1200px 800px at 50% 30%, rgba(255,120,0,.12) 0%, rgba(0,0,0,0) 55%),
                radial-gradient(1600px 1200px at 50% 60%, rgba(180,20,20,.08) 0%, rgba(0,0,0,0) 55%),
                linear-gradient(#09090b, #000);
    display:flex; align-items:center; justify-content:center;
  }
  .game-wrap{
    width: min(620px, 96vw);
    height: calc(100vh - (56px + var(--safeT)) - var(--safeB));
    display:flex; flex-direction:column;
    justify-content:space-between;
    padding: 14px 0 14px 0;
    gap: 10px;
  }

  /* Reel background blur */
  .reels-bg{
    position:relative;
    width:100%;
    flex: 1 1 auto;
    min-height: 320px;
    border-radius: 22px;
    overflow:hidden;
    box-shadow: 0 30px 65px rgba(0,0,0,.55);
  }
  .reels-bg::before{
    content:"";
    position:absolute; inset:-30px;
    background:
      radial-gradient(520px 280px at 30% 35%, rgba(255,195,0,.28), rgba(0,0,0,0) 65%),
      radial-gradient(520px 280px at 70% 55%, rgba(255,70,0,.20), rgba(0,0,0,0) 65%),
      linear-gradient(90deg, rgba(255,215,0,.08), rgba(255,0,0,.04), rgba(90,170,255,.06)),
      linear-gradient(#160a06, #0a0606);
    filter: blur(18px) saturate(1.05);
    transform: scale(1.1);
    opacity:.95;
  }
  .reels-frame{
    position:absolute; inset: 18px 14px 18px 14px;
    border-radius: 18px;
    background: linear-gradient(#2a1108, #140806);
    border: 2px solid rgba(255,215,120,.22);
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.55), inset 0 0 30px rgba(0,0,0,.55);
  }
  .reels-inner{
    position:absolute; inset: 10px 10px 10px 10px;
    border-radius: 14px;
    background: linear-gradient(#1a0906, #070304);
    border: 1px solid rgba(255,215,120,.18);
    overflow:hidden;
  }

  #reelsCanvas{
    position:absolute; inset:0;
    width:100%; height:100%;
  }

  /* Bottom controls (original-ish) */
  .controls{
    flex: 0 0 auto;
    width:100%;
    border-radius: 22px;
    padding: 10px 12px calc(12px + var(--safeB));
    background: linear-gradient(rgba(18,18,20,.85), rgba(6,6,7,.92));
    border:1px solid rgba(255,255,255,.08);
    box-shadow: 0 20px 45px rgba(0,0,0,.55);
    position:relative;
  }
  .row{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
  }
  .pill{
    display:flex; flex-direction:column;
    gap:2px;
    min-width: 96px;
  }
  .pill .k{font-size:11px; color: rgba(255,255,255,.55); letter-spacing:.4px;}
  .pill .v{font-size:16px; font-weight:750;}
  .v.money{color:#ffe08a; text-shadow: 0 0 18px rgba(255,200,80,.18);}

  .linesbar{
    margin-top: 10px;
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:10px;
  }
  .lbtn{
    height: 52px;
    border-radius: 14px;
    background: linear-gradient(#141416, #0a0a0c);
    border: 1px solid rgba(255,255,255,.09);
    color: #f0d07e;
    font-weight:800;
    font-size: 24px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.55);
    cursor:pointer;
  }
  .lbtn.active{
    background: linear-gradient(#2a160a,#140a06);
    border: 1px solid rgba(255,215,120,.25);
    box-shadow: 0 0 0 2px rgba(247,215,124,.10), 0 10px 22px rgba(0,0,0,.45);
  }
  .lbtn:active{transform: translateY(1px);}

  .spinrow{
    margin-top: 12px;
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
  }
  .smallbtn{
    width:56px; height:56px;
    border-radius: 16px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    color:#fff;
    display:grid; place-items:center;
    cursor:pointer;
    box-shadow: 0 12px 26px rgba(0,0,0,.45);
  }
  .smallbtn:active{transform: translateY(1px);}
  .spinbtn{
    flex:1;
    height: 72px;
    border-radius: 26px;
    border: 0;
    background: radial-gradient(80px 80px at 30% 30%, rgba(255,255,255,.20), rgba(255,255,255,0) 60%),
                linear-gradient(#2b2b2f, #0b0b0c);
    box-shadow: 0 18px 34px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.10);
    color:#fff;
    font-weight:900;
    letter-spacing: .8px;
    display:flex; align-items:center; justify-content:center;
    gap:12px;
    cursor:pointer;
    position:relative;
    overflow:hidden;
  }
  .spinbtn .ring{
    width:44px; height:44px; border-radius:50%;
    border: 3px solid rgba(255,255,255,.75);
    border-left-color: rgba(255,255,255,.22);
    border-top-color: rgba(255,255,255,.22);
    transform: rotate(20deg);
  }
  .spinbtn:active{transform: translateY(1px);}
  .tog{
    display:flex; gap:8px; align-items:center;
    font-size: 12px; color: rgba(255,255,255,.65);
  }
  .chip{
    height:28px; padding:0 10px; border-radius: 999px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    display:flex; align-items:center; gap:8px;
    cursor:pointer;
  }
  .chip b{color:#ffe08a;}
  .chip.on{
    background: rgba(255,215,120,.10);
    border:1px solid rgba(255,215,120,.20);
  }

  /* Toast */
  .toast{
    position:fixed; left:50%; top: calc(56px + var(--safeT) + 10px);
    transform: translateX(-50%);
    padding:10px 12px;
    border-radius: 12px;
    background: rgba(10,10,12,.90);
    border:1px solid rgba(255,255,255,.10);
    color: rgba(255,255,255,.86);
    box-shadow: 0 18px 38px rgba(0,0,0,.55);
    z-index: 80;
    opacity:0; pointer-events:none;
    transition: opacity .18s ease, transform .18s ease;
  }
  .toast.show{opacity:1; transform: translateX(-50%) translateY(0);}
  .toast.hide{opacity:0;}

  /* Debug / logs */
  #logPanel{
    position:fixed;
    left: 10px; right: 10px;
    bottom: calc(10px + var(--safeB));
    max-height: 42vh;
    background: rgba(0,0,0,.75);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 14px;
    padding: 10px 10px 8px 10px;
    z-index: 999;
    display:none;
    box-shadow: 0 30px 60px rgba(0,0,0,.6);
  }
  #logPanel header{
    display:flex; justify-content:space-between; align-items:center;
    gap:10px;
    margin-bottom: 8px;
  }
  #logPanel header b{font-size:12px; color: rgba(255,255,255,.75); letter-spacing:.4px;}
  #logPanel header .lpbtns{display:flex; gap:8px;}
  .lpbtn{
    height:28px; padding:0 10px; border-radius: 10px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.10);
    color: rgba(255,255,255,.85);
    cursor:pointer;
    font-size: 12px;
  }
  .lpbtn:active{transform: translateY(1px);}
  #logText{
    margin:0;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 11px;
    line-height: 1.35;
    color: rgba(255,255,255,.82);
    white-space: pre-wrap;
    overflow:auto;
    max-height: calc(42vh - 52px);
  }
  .warn{color:#ffd08a}
  .err{color:#ff7d7d}
</style>
</head>
<body>
<div id="app" aria-label="Burning Chilli X singlefile">
  <div class="topbar">
    <div class="tb-left" id="backBtn" aria-label="Back">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="M14.5 5.5L8 12l6.5 6.5" stroke="rgba(255,255,255,.85)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div class="tb-title">Burning Chilli X</div>
    <div class="tb-right">
      <button class="deposit" id="depositBtn">Поповнити</button>
    </div>
  </div>

  <!-- LAUNCH -->
  <section id="launch" class="screen">
    <div class="launch-wrap" id="launchTap">
      <div class="logo-block">
        <canvas class="logo-canvas" id="logoCanvas" width="900" height="660"></canvas>
      </div>

      <div class="bgaming" aria-label="BGAMING">
        <span class="b">B</span>
        <span>G</span>
        <span>A</span>
        <span>M</span>
        <span class="flip" data-char="I">I</span>
        <span class="flip" data-char="N">N</span>
        <span class="flip" data-char="G">G</span>
      </div>

      <div class="loading">
        <div class="dot"></div>
        <label>Loading</label>
      </div>
      <div class="tapto">Tap to start</div>
    </div>
  </section>

  <!-- GAME -->
  <section id="game" class="screen hidden">
    <div class="game-wrap">
      <div class="reels-bg" id="reelsBg">
        <div class="reels-frame"></div>
        <div class="reels-inner">
          <canvas id="reelsCanvas" width="900" height="900"></canvas>
        </div>
      </div>

      <div class="controls" aria-label="Controls">
        <div class="row">
          <div class="pill"><div class="k">Баланс</div><div class="v money" id="uiBalance">100000.00</div></div>
          <div class="pill" style="text-align:center;"><div class="k">Ставка</div><div class="v money" id="uiBet">1.00</div></div>
          <div class="pill" style="text-align:right;"><div class="k">Виграш</div><div class="v money" id="uiWin">0.00</div></div>
        </div>

        <div class="linesbar" aria-label="Lines">
          <button class="lbtn active" data-lines="100">100</button>
          <button class="lbtn" data-lines="80">80</button>
          <button class="lbtn" data-lines="60">60</button>
          <button class="lbtn" data-lines="40">40</button>
          <button class="lbtn" data-lines="20">20</button>
        </div>

        <div class="spinrow">
          <button class="smallbtn" id="betMinus" aria-label="Bet minus">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M6 12h12" stroke="rgba(255,255,255,.9)" stroke-width="2.6" stroke-linecap="round"/>
            </svg>
          </button>

          <button class="spinbtn" id="spinBtn" aria-label="Spin">
            <div class="ring" aria-hidden="true"></div>
            <div>SPIN</div>
          </button>

          <button class="smallbtn" id="betPlus" aria-label="Bet plus">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M12 6v12M6 12h12" stroke="rgba(255,255,255,.9)" stroke-width="2.6" stroke-linecap="round"/>
            </svg>
          </button>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="tog">
            <div class="chip" id="autoChip">AUTO <b id="autoVal">OFF</b></div>
            <div class="chip" id="turboChip">TURBO <b id="turboVal">OFF</b></div>
          </div>
          <div class="tog" style="justify-content:flex-end;">
            <div class="chip" id="infoChip">INFO</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="toast" id="toast"></div>

  <div id="logPanel" aria-label="Logs">
    <header>
      <b>LOGS (press F)</b>
      <div class="lpbtns">
        <button class="lpbtn" id="copyLogs">Copy</button>
        <button class="lpbtn" id="clearLogs">Clear</button>
        <button class="lpbtn" id="closeLogs">Close</button>
      </div>
    </header>
    <pre id="logText"></pre>
  </div>
</div>

<script>
(()=> {
  "use strict";

  // ---------- LOGGING ----------
  const logPanel = document.getElementById('logPanel');
  const logText = document.getElementById('logText');
  const toastEl = document.getElementById('toast');

  const logs = [];
  function ts(){ const d=new Date(); return d.toISOString().slice(11,23); }
  function pushLog(level, msg){
    const line = `[${ts()}] ${level}: ${msg}`;
    logs.push(line);
    if(logs.length>900) logs.splice(0, logs.length-900);
    if(logPanel.style.display==='block') logText.textContent = logs.join("\n");
    console[level==='ERROR'?'error':(level==='WARN'?'warn':'log')](line);
  }
  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    toastEl.classList.remove('hide');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{ toastEl.classList.add('hide'); toastEl.classList.remove('show'); }, 1400);
  }
  window.addEventListener('error', (e)=> pushLog('ERROR', (e && e.message) ? e.message : 'window.onerror'));
  window.addEventListener('unhandledrejection', (e)=> pushLog('ERROR', 'unhandledrejection: ' + ((e && e.reason && e.reason.message) ? e.reason.message : String(e.reason))));

  function toggleLogs(on){
    const visible = (logPanel.style.display === 'block');
    const next = (typeof on === 'boolean') ? on : !visible;
    logPanel.style.display = next ? 'block' : 'none';
    if(next) logText.textContent = logs.join("\n");
  }
  document.addEventListener('keydown', (e)=>{
    if((e.key||'').toLowerCase()==='f'){ e.preventDefault(); toggleLogs(); }
  });
  document.getElementById('closeLogs').onclick = ()=> toggleLogs(false);
  document.getElementById('copyLogs').onclick = async ()=>{
    try{ await navigator.clipboard.writeText(logs.join("\n")); showToast('Logs copied'); }
    catch(_){ showToast('Copy failed'); }
  };
  document.getElementById('clearLogs').onclick = ()=>{ logs.length=0; logText.textContent=''; showToast('Logs cleared'); };

  // ---------- UI ----------
  const launch = document.getElementById('launch');
  const game = document.getElementById('game');
  const backBtn = document.getElementById('backBtn');
  const depositBtn = document.getElementById('depositBtn');
  const launchTap = document.getElementById('launchTap');
  const launchEl = document.getElementById('launch');
  // <!-- ASSISTANT PATCH: v11 launch fast anytap + auto-enter -->
  let __entered = false;
  function __enterOnce(){
    if(__entered) return;
    __entered = true;
    enterGame();
  }


  backBtn.addEventListener('click', ()=>{ showToast('Back'); pushLog('INFO','Back tapped'); });
  depositBtn.addEventListener('click', ()=>{ showToast('Демо поповнення'); pushLog('INFO','Deposit tapped (demo)'); });

  // ---------- Logo drawing (own, not copied) ----------
  const logoCanvas = document.getElementById('logoCanvas');
  const lctx = logoCanvas.getContext('2d');

  function drawFlame(ctx, x, y, w, h){
    ctx.save();
    ctx.translate(x,y);
    const grd = ctx.createLinearGradient(0,h,0,0);
    grd.addColorStop(0,'rgba(0,0,0,0)');
    grd.addColorStop(0.25,'rgba(255,60,0,.25)');
    grd.addColorStop(0.7,'rgba(255,190,0,.35)');
    grd.addColorStop(1,'rgba(255,240,200,.15)');
    ctx.fillStyle = grd;

    for(let i=0;i<11;i++){
      const px = (i/10)*w;
      const ph = h*(0.35 + 0.7*Math.random());
      ctx.beginPath();
      ctx.moveTo(px, h);
      ctx.quadraticCurveTo(px+ w*0.03, h - ph*0.35, px + w*0.06, h - ph);
      ctx.quadraticCurveTo(px+ w*0.09, h - ph*0.35, px + w*0.12, h);
      ctx.closePath();
      ctx.fill();
    }
    ctx.restore();
  }

  function drawLogo(){
    const W = logoCanvas.width, H = logoCanvas.height;
    lctx.clearRect(0,0,W,H);

    // vignette
    const v = lctx.createRadialGradient(W*0.5,H*0.55,10, W*0.5,H*0.55, W*0.55);
    v.addColorStop(0,'rgba(160,10,10,.35)');
    v.addColorStop(0.55,'rgba(0,0,0,0)');
    v.addColorStop(1,'rgba(0,0,0,0)');
    lctx.fillStyle = v;
    lctx.fillRect(0,0,W,H);

    // flames
    drawFlame(lctx, W*0.18, H*0.30, W*0.64, H*0.42);

    // title "BURNING CHILLI X" own typography
    lctx.save();
    lctx.translate(W*0.5, H*0.22);
    lctx.textAlign='center';
    lctx.textBaseline='middle';
    lctx.font='900 64px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    const tgrd = lctx.createLinearGradient(-240,0,240,0);
    tgrd.addColorStop(0,'#ffcf5a'); tgrd.addColorStop(0.35,'#ff7b2b'); tgrd.addColorStop(0.7,'#ffd46c'); tgrd.addColorStop(1,'#ffcf5a');
    lctx.strokeStyle='rgba(0,0,0,.65)';
    lctx.lineWidth=14;
    lctx.lineJoin='round';
    lctx.strokeText('BURNING  CHILLI  X',0,0);
    lctx.fillStyle=tgrd;
    lctx.fillText('BURNING  CHILLI  X',0,0);
    lctx.restore();

    // center 7 + fruit row (stylized)
    lctx.save();
    lctx.translate(W*0.5, H*0.50);
    const glow = lctx.createRadialGradient(0,10,10,0,10,340);
    glow.addColorStop(0,'rgba(255,40,40,.25)');
    glow.addColorStop(0.6,'rgba(255,80,0,.12)');
    glow.addColorStop(1,'rgba(0,0,0,0)');
    lctx.fillStyle=glow;
    lctx.beginPath(); lctx.ellipse(0, 60, 320, 220, 0, 0, Math.PI*2); lctx.fill();

    // big 7
    lctx.save();
    lctx.translate(0, 30);
    lctx.font='1000 220px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    lctx.textAlign='center';
    lctx.textBaseline='middle';
    lctx.lineJoin='round';
    lctx.lineWidth=26;
    lctx.strokeStyle='rgba(0,0,0,.55)';
    lctx.strokeText('7', 0, 0);
    const g7=lctx.createLinearGradient(-70,-120,70,120);
    g7.addColorStop(0,'#ff4b4b'); g7.addColorStop(0.5,'#ff1f1f'); g7.addColorStop(1,'#ff8b6b');
    lctx.fillStyle=g7;
    lctx.fillText('7',0,0);

    // inner shine
    lctx.globalAlpha=.22;
    lctx.fillStyle='#fff';
    lctx.beginPath();
    lctx.ellipse(-22,-35, 30, 55, -0.3, 0, Math.PI*2);
    lctx.fill();
    lctx.restore();

    // fruit row behind
    function fruit(x,y,r,fill,stroke,detail){
      lctx.save();
      lctx.translate(x,y);
      lctx.beginPath(); lctx.arc(0,0,r,0,Math.PI*2);
      lctx.fillStyle=fill; lctx.fill();
      lctx.lineWidth=10; lctx.strokeStyle=stroke; lctx.stroke();
      if(detail) detail();
      lctx.restore();
    }
    fruit(-270, 70, 56, '#ffd75a', '#3b1908', ()=>{
      lctx.fillStyle='rgba(255,255,255,.25)'; lctx.beginPath(); lctx.arc(-18,-18,16,0,Math.PI*2); lctx.fill();
    });
    fruit(-160, 78, 56, '#ff3b3b', '#3b1908', ()=>{
      lctx.fillStyle='rgba(255,255,255,.22)'; lctx.beginPath(); lctx.arc(-18,-18,16,0,Math.PI*2); lctx.fill();
      lctx.strokeStyle='#1f8a36'; lctx.lineWidth=10; lctx.beginPath(); lctx.moveTo(5,-62); lctx.quadraticCurveTo(20,-92, 45,-75); lctx.stroke();
    });
    fruit(160, 78, 56, '#2f79ff', '#3b1908', ()=>{
      lctx.fillStyle='rgba(255,255,255,.2)'; lctx.beginPath(); lctx.arc(-18,-18,16,0,Math.PI*2); lctx.fill();
    });
    fruit(270, 68, 56, '#ffd75a', '#3b1908', ()=>{
      lctx.fillStyle='rgba(255,255,255,.25)'; lctx.beginPath(); lctx.arc(-18,-18,16,0,Math.PI*2); lctx.fill();
    });

    // chilli icon near title
    lctx.save();
    lctx.translate(0,-86);
    lctx.rotate(-0.15);
    lctx.beginPath();
    lctx.moveTo(20,0);
    lctx.bezierCurveTo(140,0, 160,70, 80,96);
    lctx.bezierCurveTo(10,120,-10,62, 20,0);
    lctx.closePath();
    lctx.fillStyle='#ff2a2a';
    lctx.fill();
    lctx.lineWidth=14; lctx.strokeStyle='rgba(0,0,0,.45)'; lctx.stroke();
    lctx.strokeStyle='#2aa24a'; lctx.lineWidth=10;
    lctx.beginPath(); lctx.moveTo(20,0); lctx.quadraticCurveTo(0,-34, -40,-26); lctx.stroke();
    lctx.restore();

    lctx.restore();

    // reflection floor
    lctx.save();
    lctx.globalAlpha = .15;
    lctx.translate(0, H*0.87);
    const grd = lctx.createLinearGradient(0,0,0,120);
    grd.addColorStop(0,'rgba(255,150,40,.35)');
    grd.addColorStop(1,'rgba(0,0,0,0)');
    lctx.fillStyle = grd;
    lctx.fillRect(0,0,W,120);
    lctx.restore();
  }

  // ---------- Game engine (own) ----------
  const reelsCanvas = document.getElementById('reelsCanvas');
  const rctx = reelsCanvas.getContext('2d');

  const uiBalance = document.getElementById('uiBalance');
  const uiBet = document.getElementById('uiBet');
  const uiWin = document.getElementById('uiWin');

  const spinBtn = document.getElementById('spinBtn');
  const betMinus = document.getElementById('betMinus');
  const betPlus = document.getElementById('betPlus');
  const autoChip = document.getElementById('autoChip');
  const turboChip = document.getElementById('turboChip');
  const autoVal = document.getElementById('autoVal');
  const turboVal = document.getElementById('turboVal');
  const infoChip = document.getElementById('infoChip');

  let balance = 100000.00;
  let bet = 1.00;
  const betSteps = [0.10,0.20,0.50,1.00,2.00,5.00,10.00,20.00,50.00,100.00];
  let betIdx = betSteps.indexOf(1.00);

  let activeLines = 100;
  let autoOn = false;
  let turboOn = false;

  const COLS = 5;
  const ROWS = 4; // closer to your screenshot grid (5x4)
  let grid = Array.from({length:COLS}, ()=> Array.from({length:ROWS}, ()=> 0));

  // Symbol definitions (own drawings)
  const SYM = {
    LEMON:0, CHERRY:1, PLUM:2, BELL:3, SEVEN:4, CHILLI:5, SCATTER:6, WILD:7
  };
  const symList = Object.values(SYM);

  // multipliers for 3/4/5 in streak (per line)
  const pay = {
    [SYM.LEMON]: [0,0, 0.4, 1.0, 3.0],
    [SYM.CHERRY]:[0,0, 0.5, 1.2, 3.5],
    [SYM.PLUM]:  [0,0, 0.55,1.4, 4.0],
    [SYM.BELL]:  [0,0, 0.8, 2.0, 6.0],
    [SYM.CHILLI]:[0,0, 1.0, 2.6, 8.0],
    [SYM.SEVEN]: [0,0, 1.5, 4.0, 12.0],
    [SYM.WILD]:  [0,0, 1.2, 3.0, 10.0],
    [SYM.SCATTER]:[0,0, 0,0,0]
  };

  // Generate payline patterns across 5 reels, rows 0..ROWS-1
  function genPaylines(n){
    const base = [];
    // Classic patterns for 20-ish
    base.push([1,1,1,1,1]);
    base.push([0,0,0,0,0]);
    base.push([2,2,2,2,2]);
    base.push([3,3,3,3,3]);
    base.push([0,1,2,1,0]);
    base.push([3,2,1,2,3]);
    base.push([1,0,0,0,1]);
    base.push([1,2,2,2,1]);
    base.push([2,3,3,3,2]);
    base.push([2,1,0,1,2]);
    base.push([0,1,1,1,0]);
    base.push([3,2,2,2,3]);
    base.push([1,1,0,1,1]);
    base.push([1,1,2,1,1]);
    base.push([2,2,1,2,2]);
    base.push([2,2,3,2,2]);
    base.push([0,1,2,3,3]);
    base.push([3,2,1,0,0]);
    base.push([0,0,1,2,3]);
    base.push([3,3,2,1,0]);

    // Expand to 40/60/80/100 with controlled random wiggles
    const out = base.slice(0, Math.min(n, base.length));
    function clamp(v){ return Math.max(0, Math.min(ROWS-1, v)); }
    let seed = 1337;
    function rnd(){
      seed = (seed*1664525 + 1013904223) >>> 0;
      return seed / 4294967296;
    }
    while(out.length < n){
      const pick = base[(out.length + 7) % base.length];
      const arr = pick.slice();
      for(let i=1;i<COLS-1;i++){
        const r = rnd();
        if(r < 0.40){
          const delta = (r < 0.20) ? -1 : 1;
          arr[i] = clamp(arr[i] + delta);
        }
      }
      // ensure not duplicate
      const key = arr.join(',');
      if(!out.some(p=>p.join(',')===key)) out.push(arr);
      if(out.length>250) break;
    }
    return out.slice(0,n);
  }

  const paylinesMap = {
    20: genPaylines(20),
    40: genPaylines(40),
    60: genPaylines(60),
    80: genPaylines(80),
    100: genPaylines(100)
  };

  // Reel spin state
  let spinning = false;
  let reelY = new Array(COLS).fill(0);
  let reelV = new Array(COLS).fill(0);
  let reelStopAt = new Array(COLS).fill(0);
  let highlightCells = []; // [{c,r}]
  let winLinesDraw = []; // [{lineIdx, pathRows, amount}]

  // Resize canvas to container
  function fitCanvas(){
    const inner = document.querySelector('.reels-inner');
    if(!inner) return;
    const rect = inner.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(2.0, window.devicePixelRatio||1));
    const w = Math.floor(rect.width * dpr);
    const h = Math.floor(rect.height * dpr);
    if(reelsCanvas.width !== w || reelsCanvas.height !== h){
      reelsCanvas.width = w; reelsCanvas.height = h;
      pushLog('INFO', `Canvas resized ${w}x${h} dpr=${dpr.toFixed(2)}`);
    }
  }

  function money(v){ return v.toFixed(2); }
  function syncUI(){
    uiBalance.textContent = money(balance);
    uiBet.textContent = money(bet);
  }

  // Symbol drawing helpers
  function drawSymbol(ctx, sym, x, y, w, h){
    // backdrop
    ctx.save();
    ctx.translate(x,y);
    const pad = Math.min(w,h)*0.08;
    const rx = Math.min(w,h)*0.18;
    // card
    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0,'#3a140b'); g.addColorStop(1,'#1a0806');
    roundRect(ctx, pad, pad, w-2*pad, h-2*pad, rx);
    ctx.fillStyle = g; ctx.fill();
    ctx.lineWidth = Math.max(2, Math.min(10, w*0.06));
    ctx.strokeStyle = 'rgba(255,215,120,.25)';
    ctx.stroke();

    // symbol
    const cx = w/2, cy = h/2 + h*0.02;
    const s = Math.min(w,h)*0.32;
    ctx.shadowColor = 'rgba(0,0,0,.35)';
    ctx.shadowBlur = Math.max(6, s*0.15);
    ctx.shadowOffsetY = Math.max(2, s*0.06);

    switch(sym){
      case SYM.LEMON:
        drawLemon(ctx,cx,cy,s);
        break;
      case SYM.CHERRY:
        drawCherry(ctx,cx,cy,s);
        break;
      case SYM.PLUM:
        drawPlum(ctx,cx,cy,s);
        break;
      case SYM.BELL:
        drawBell(ctx,cx,cy,s);
        break;
      case SYM.SEVEN:
        drawSeven(ctx,cx,cy,s);
        break;
      case SYM.CHILLI:
        drawChilli(ctx,cx,cy,s);
        break;
      case SYM.SCATTER:
        drawScatter(ctx,cx,cy,s);
        break;
      case SYM.WILD:
        drawWild(ctx,cx,cy,s);
        break;
    }
    ctx.restore();
  }
  function roundRect(ctx,x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }
  function drawGloss(ctx,x,y,w,h){
    const g = ctx.createLinearGradient(0,y,0,y+h);
    g.addColorStop(0,'rgba(255,255,255,.35)');
    g.addColorStop(0.35,'rgba(255,255,255,.10)');
    g.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=g;
    ctx.beginPath();
    ctx.ellipse(x-w*0.12, y-h*0.12, w*0.40, h*0.55, -0.5, 0, Math.PI*2);
    ctx.fill();
  }
  function drawLemon(ctx,cx,cy,s){
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(-0.12);
    const g = ctx.createLinearGradient(-s, -s, s, s);
    g.addColorStop(0,'#fff09a'); g.addColorStop(0.45,'#ffd54a'); g.addColorStop(1,'#ffb020');
    ctx.fillStyle=g;
    ctx.strokeStyle='rgba(30,10,0,.55)';
    ctx.lineWidth=s*0.18;
    ctx.beginPath();
    ctx.ellipse(0,0,s*1.05,s*0.78,0,0,Math.PI*2);
    ctx.fill(); ctx.stroke();
    drawGloss(ctx, 0, -s*0.10, s*1.4, s*1.0);
    ctx.restore();
  }
  function drawCherry(ctx,cx,cy,s){
    ctx.save();
    ctx.translate(cx,cy);
    // stems
    ctx.strokeStyle='#2fb25a';
    ctx.lineWidth = s*0.18;
    ctx.lineCap='round';
    ctx.beginPath();
    ctx.moveTo(-s*0.1,-s*1.0);
    ctx.quadraticCurveTo(0,-s*1.25, s*0.35,-s*0.82);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(-s*0.1,-s*1.0);
    ctx.quadraticCurveTo(-s*0.45,-s*1.35,-s*0.60,-s*0.95);
    ctx.stroke();
    // fruit
    function ball(x,y){
      const g = ctx.createRadialGradient(x-s*0.2,y-s*0.2, s*0.1, x,y,s*0.95);
      g.addColorStop(0,'#ffb0b0');
      g.addColorStop(0.35,'#ff3a3a');
      g.addColorStop(1,'#b70000');
      ctx.fillStyle=g;
      ctx.strokeStyle='rgba(30,10,0,.55)';
      ctx.lineWidth=s*0.18;
      ctx.beginPath(); ctx.arc(x,y,s*0.65,0,Math.PI*2); ctx.fill(); ctx.stroke();
      drawGloss(ctx, x-s*0.05, y-s*0.08, s*1.1, s*1.1);
    }
    ball(-s*0.35, s*0.25);
    ball(s*0.35, s*0.35);
    ctx.restore();
  }
  function drawPlum(ctx,cx,cy,s){
    ctx.save();
    ctx.translate(cx,cy);
    const g = ctx.createRadialGradient(-s*0.2,-s*0.2, s*0.15, 0,0,s*1.0);
    g.addColorStop(0,'#c7c6ff');
    g.addColorStop(0.35,'#5d77ff');
    g.addColorStop(1,'#1b3bbd');
    ctx.fillStyle=g;
    ctx.strokeStyle='rgba(30,10,0,.55)';
    ctx.lineWidth=s*0.18;
    ctx.beginPath();
    ctx.ellipse(0,0,s*0.95,s*1.05,0,0,Math.PI*2);
    ctx.fill(); ctx.stroke();
    drawGloss(ctx, -s*0.1, -s*0.2, s*1.2, s*1.2);
    ctx.restore();
  }
  function drawBell(ctx,cx,cy,s){
    ctx.save();
    ctx.translate(cx,cy);
    const g = ctx.createLinearGradient(0,-s,0,s);
    g.addColorStop(0,'#fff0a5');
    g.addColorStop(0.45,'#ffd34b');
    g.addColorStop(1,'#d37b00');
    ctx.fillStyle=g;
    ctx.strokeStyle='rgba(30,10,0,.55)';
    ctx.lineWidth=s*0.18;

    ctx.beginPath();
    ctx.moveTo(-s*0.85, -s*0.15);
    ctx.quadraticCurveTo(0,-s*1.25, s*0.85,-s*0.15);
    ctx.quadraticCurveTo(s*0.95, s*0.80, 0, s*0.92);
    ctx.quadraticCurveTo(-s*0.95, s*0.80, -s*0.85,-s*0.15);
    ctx.closePath();
    ctx.fill(); ctx.stroke();

    // clapper
    ctx.fillStyle='#ffd9a0';
    ctx.beginPath(); ctx.arc(0,s*0.62,s*0.18,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  function drawSeven(ctx,cx,cy,s){
    ctx.save();
    ctx.translate(cx,cy);
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`900 ${Math.floor(s*2.1)}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.lineJoin='round';
    ctx.lineWidth=s*0.22;
    ctx.strokeStyle='rgba(0,0,0,.55)';
    ctx.strokeText('7',0, s*0.12);
    const g = ctx.createLinearGradient(-s,-s,s,s);
    g.addColorStop(0,'#ff9a9a'); g.addColorStop(0.4,'#ff2f2f'); g.addColorStop(1,'#ffcfaf');
    ctx.fillStyle=g;
    ctx.fillText('7',0,s*0.12);
    ctx.globalAlpha=.22;
    ctx.fillStyle='#fff';
    ctx.beginPath(); ctx.ellipse(-s*0.25,-s*0.35,s*0.18,s*0.42,-0.25,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }
  function drawChilli(ctx,cx,cy,s){
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(-0.18);
    ctx.strokeStyle='rgba(0,0,0,.55)';
    ctx.lineWidth=s*0.22;
    const g = ctx.createLinearGradient(-s,0,s,0);
    g.addColorStop(0,'#ffb0a0'); g.addColorStop(0.35,'#ff2a2a'); g.addColorStop(1,'#b80000');
    ctx.fillStyle=g;
    ctx.beginPath();
    ctx.moveTo(-s*0.2,-s*0.85);
    ctx.bezierCurveTo(s*0.95,-s*0.75, s*1.05,s*0.45, s*0.15,s*0.95);
    ctx.bezierCurveTo(-s*0.60,s*1.15,-s*0.95,s*0.40,-s*0.2,-s*0.85);
    ctx.closePath();
    ctx.fill(); ctx.stroke();

    // stem
    ctx.strokeStyle='#2aa24a';
    ctx.lineWidth=s*0.20;
    ctx.beginPath();
    ctx.moveTo(-s*0.2,-s*0.85);
    ctx.quadraticCurveTo(-s*0.55,-s*1.25,-s*0.95,-s*1.02);
    ctx.stroke();

    ctx.restore();
  }
  function drawScatter(ctx,cx,cy,s){
    ctx.save();
    ctx.translate(cx,cy);
    const g = ctx.createRadialGradient(-s*0.2,-s*0.2, s*0.15, 0,0,s*1.1);
    g.addColorStop(0,'#fff2b8');
    g.addColorStop(0.4,'#ffd45c');
    g.addColorStop(1,'#d07d00');
    ctx.fillStyle=g;
    ctx.strokeStyle='rgba(0,0,0,.55)';
    ctx.lineWidth=s*0.20;
    star(ctx,0,0,s*0.95, s*0.45, 5);
    ctx.fill(); ctx.stroke();
    ctx.fillStyle='rgba(0,0,0,.65)';
    ctx.font=`900 ${Math.floor(s*0.62)}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('SC',0,s*0.08);
    ctx.restore();
  }
  function drawWild(ctx,cx,cy,s){
    ctx.save();
    ctx.translate(cx,cy);
    const g = ctx.createLinearGradient(-s,-s,s,s);
    g.addColorStop(0,'#b7ff3a');
    g.addColorStop(0.55,'#79d800');
    g.addColorStop(1,'#d6ff7e');
    ctx.fillStyle=g;
    ctx.strokeStyle='rgba(0,0,0,.55)';
    ctx.lineWidth=s*0.20;
    roundRect(ctx, -s*1.05, -s*0.75, s*2.10, s*1.50, s*0.38);
    ctx.fill(); ctx.stroke();
    ctx.fillStyle='rgba(0,0,0,.75)';
    ctx.font=`1000 ${Math.floor(s*0.9)}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('W',0,0);
    ctx.restore();
  }
  function star(ctx,cx,cy,outer,inner,points){
    let rot = Math.PI/2*3;
    let x=cx, y=cy;
    const step = Math.PI/points;
    ctx.beginPath();
    ctx.moveTo(cx, cy - outer);
    for(let i=0;i<points;i++){
      x = cx + Math.cos(rot)*outer;
      y = cy + Math.sin(rot)*outer;
      ctx.lineTo(x,y);
      rot += step;
      x = cx + Math.cos(rot)*inner;
      y = cy + Math.sin(rot)*inner;
      ctx.lineTo(x,y);
      rot += step;
    }
    ctx.closePath();
  }

  // Draw reels + UI overlays
  function draw(){
    const W = reelsCanvas.width, H = reelsCanvas.height;
    rctx.clearRect(0,0,W,H);

    // subtle background inside reels
    const bg = rctx.createLinearGradient(0,0,0,H);
    bg.addColorStop(0,'#250e08');
    bg.addColorStop(1,'#0b0404');
    rctx.fillStyle = bg;
    rctx.fillRect(0,0,W,H);

    // geometry
    const pad = Math.min(W,H)*0.05;
    const gap = Math.min(W,H)*0.02;
    const cellW = (W - pad*2 - gap*(COLS-1)) / COLS;
    const cellH = (H - pad*2 - gap*(ROWS-1)) / ROWS;

    // Determine effective scroll offsets per reel for spin animation
    const scroll = reelY.slice();

    // draw symbols (with scrolling strip during spin)
    for(let c=0;c<COLS;c++){
      for(let r=0;r<ROWS;r++){
        // compute symbol index for scroll: shift by scroll value
        let rr = r;
        if(spinning){
          const shift = Math.floor(scroll[c] / cellH);
          const frac = (scroll[c] % cellH);
          rr = r + shift;
          // draw two layers (current and next) with translation
          const y0 = pad + r*(cellH+gap) - frac;
          const x0 = pad + c*(cellW+gap);
          const symA = symAt(c, rr);
          drawSymbol(rctx, symA, x0, y0, cellW, cellH);
          const symB = symAt(c, rr+1);
          drawSymbol(rctx, symB, x0, y0 + cellH + gap, cellW, cellH);
          continue;
        }
        const x = pad + c*(cellW+gap);
        const y = pad + r*(cellH+gap);
        drawSymbol(rctx, grid[c][r], x, y, cellW, cellH);
      }
    }

    // highlight winning cells
    if(highlightCells.length){
      rctx.save();
      rctx.globalCompositeOperation = 'screen';
      for(const h of highlightCells){
        const x = pad + h.c*(cellW+gap);
        const y = pad + h.r*(cellH+gap);
        const g = rctx.createLinearGradient(x,y,x,y+cellH);
        g.addColorStop(0,'rgba(255,230,140,.10)');
        g.addColorStop(1,'rgba(255,120,40,.08)');
        rctx.fillStyle = g;
        roundRect(rctx, x+cellW*0.07, y+cellH*0.07, cellW*0.86, cellH*0.86, Math.min(cellW,cellH)*0.18);
        rctx.fill();

        rctx.strokeStyle = 'rgba(255,215,120,.45)';
        rctx.lineWidth = Math.max(2, Math.min(8, cellW*0.05));
        roundRect(rctx, x+cellW*0.09, y+cellH*0.09, cellW*0.82, cellH*0.82, Math.min(cellW,cellH)*0.18);
        rctx.stroke();
      }
      rctx.restore();
    }

    // draw paylines as golden lines
    if(winLinesDraw.length){
      rctx.save();
      rctx.lineCap='round';
      rctx.lineJoin='round';
      rctx.shadowColor='rgba(0,0,0,.35)';
      rctx.shadowBlur = Math.max(6, cellW*0.12);
      for(const wln of winLinesDraw){
        const rows = wln.pathRows;
        rctx.strokeStyle = 'rgba(255,200,60,.92)';
        rctx.lineWidth = Math.max(2.4, cellW*0.08);
        rctx.beginPath();
        for(let c=0;c<COLS;c++){
          const rr = rows[c];
          const cx = pad + c*(cellW+gap) + cellW/2;
          const cy = pad + rr*(cellH+gap) + cellH/2;
          if(c===0) rctx.moveTo(cx,cy);
          else rctx.lineTo(cx,cy);
        }
        rctx.stroke();
      }
      rctx.restore();
    }

    // fade edges
    const v = rctx.createLinearGradient(0,0,0,H);
    v.addColorStop(0,'rgba(0,0,0,.30)');
    v.addColorStop(0.15,'rgba(0,0,0,0)');
    v.addColorStop(0.85,'rgba(0,0,0,0)');
    v.addColorStop(1,'rgba(0,0,0,.35)');
    rctx.fillStyle=v;
    rctx.fillRect(0,0,W,H);
  }

  // Provide a pseudo reel strip for scrolling look
  function symAt(c, idx){
    // deterministic but varied
    const a = (c*13 + idx*17 + 7) % symList.length;
    // avoid too many scatters in strip
    if(symList[a]===SYM.SCATTER && ((c+idx)%3!==0)) return SYM.LEMON;
    return symList[a];
  }

  // Build final grid randomly (weighted)
  function randomSym(){
    const r = Math.random();
    if(r<0.18) return SYM.LEMON;
    if(r<0.34) return SYM.CHERRY;
    if(r<0.50) return SYM.PLUM;
    if(r<0.63) return SYM.BELL;
    if(r<0.74) return SYM.CHILLI;
    if(r<0.82) return SYM.SEVEN;
    if(r<0.90) return SYM.WILD;
    return SYM.SCATTER;
  }
  function fillGrid(){
    for(let c=0;c<COLS;c++){
      for(let r=0;r<ROWS;r++){
        grid[c][r] = randomSym();
      }
    }
  }

  // Evaluate paylines
  function evalWin(){
    const lines = paylinesMap[activeLines] || paylinesMap[20];
    let win = 0;
    highlightCells = [];
    winLinesDraw = [];
    // count scatters anywhere for bonus feel
    let scat = 0;
    for(let c=0;c<COLS;c++) for(let r=0;r<ROWS;r++) if(grid[c][r]===SYM.SCATTER) scat++;
    if(scat>=3){
      const scatWin = bet * (scat===3? 2 : scat===4? 8 : 20);
      win += scatWin;
      pushLog('INFO', `Scatter x${scat} => +${scatWin.toFixed(2)}`);
    }

    for(let i=0;i<lines.length;i++){
      const path = lines[i];
      // determine left-to-right streak (wild substitutes)
      let base = grid[0][path[0]];
      if(base===SYM.SCATTER) continue;
      let streak=1;
      // if first is wild, find next non-wild/scatter
      if(base===SYM.WILD){
        for(let c=1;c<COLS;c++){
          const s = grid[c][path[c]];
          if(s!==SYM.WILD && s!==SYM.SCATTER){ base=s; break; }
        }
      }
      for(let c=1;c<COLS;c++){
        const s = grid[c][path[c]];
        if(s===SYM.SCATTER) break;
        if(s===base || s===SYM.WILD || base===SYM.WILD){
          streak++;
        }else break;
      }
      if(streak>=3){
        const sym = (base===SYM.WILD) ? SYM.WILD : base;
        const mult = (pay[sym] && pay[sym][streak]) ? pay[sym][streak] : 0;
        if(mult>0){
          const amt = bet * mult;
          win += amt;
          winLinesDraw.push({lineIdx:i, pathRows:path, amount:amt});
          for(let c=0;c<streak;c++){
            highlightCells.push({c, r: path[c]});
          }
        }
      }
    }
    return win;
  }

  // Spin animation
  let raf = 0;
  let lastT = 0;

  function startSpin(){
    if(spinning) return;
    const cost = bet;
    if(balance < cost){
      showToast('Недостатньо балансу');
      pushLog('WARN','Insufficient balance');
      return;
    }
    balance -= cost;
    uiWin.textContent = money(0);
    syncUI();

    spinning = true;
    highlightCells = [];
    winLinesDraw = [];
    // set reel velocities and stop times
    const baseDur = turboOn ? 650 : 1200;
    const stagger = turboOn ? 120 : 220;
    for(let c=0;c<COLS;c++){
      reelY[c] = 0;
      reelV[c] = (turboOn ? 2.3 : 1.6) * (reelsCanvas.height/600) * (1 + c*0.05);
      reelStopAt[c] = performance.now() + baseDur + c*stagger;
    }
    pushLog('INFO', `SPIN start lines=${activeLines} bet=${money(bet)} turbo=${turboOn?'on':'off'} auto=${autoOn?'on':'off'}`);
    cancelAnimationFrame(raf);
    lastT = performance.now();
    raf = requestAnimationFrame(tick);
  }

  function stopReel(c){
    reelV[c] = 0;
  }

  function tick(t){
    const dt = Math.min(32, t - lastT);
    lastT = t;

    const cellH = getCellH();
    // move reels
    let anyMoving = false;
    for(let c=0;c<COLS;c++){
      if(reelV[c]>0){
        anyMoving = true;
        reelY[c] += reelV[c] * dt * 0.9;
        // keep within some range
        if(reelY[c] > cellH*1000) reelY[c] = reelY[c] % cellH;
        if(t >= reelStopAt[c]){
          stopReel(c);
          reelY[c] = 0;
        }
      }
    }
    draw();

    if(anyMoving){
      raf = requestAnimationFrame(tick);
      return;
    }

    // final settle
    spinning = false;
    fillGrid();
    const win = evalWin();
    if(win>0){
      balance += win;
      uiWin.textContent = money(win);
      syncUI();
      pushLog('INFO', `WIN ${money(win)} (lines=${activeLines})`);
      showToast('WIN +' + money(win));
      // keep showing lines shortly
      setTimeout(()=>{ winLinesDraw = []; highlightCells=[]; draw(); }, 1100);
    }else{
      uiWin.textContent = money(0);
      syncUI();
    }
    draw();

    if(autoOn){
      setTimeout(()=>{ if(autoOn) startSpin(); }, turboOn ? 350 : 650);
    }
  }

  function getCellH(){
    const W = reelsCanvas.width, H = reelsCanvas.height;
    const pad = Math.min(W,H)*0.05;
    const gap = Math.min(W,H)*0.02;
    return (H - pad*2 - gap*(ROWS-1)) / ROWS;
  }

  // ---------- Input bindings ----------
  spinBtn.addEventListener('click', ()=> startSpin());
  spinBtn.addEventListener('pointerdown', (e)=>{
    // hold -> turbo momentary for this spin
    spinBtn.setPointerCapture?.(e.pointerId);
    spinBtn._hold = setTimeout(()=>{ turboOn = true; setTurboUI(true); showToast('TURBO HOLD'); }, 380);
  });
  spinBtn.addEventListener('pointerup', ()=>{ clearTimeout(spinBtn._hold); spinBtn._hold=null; });
  spinBtn.addEventListener('pointercancel', ()=>{ clearTimeout(spinBtn._hold); spinBtn._hold=null; });

  betMinus.addEventListener('click', ()=>{
    if(spinning) return;
    betIdx = Math.max(0, betIdx-1);
    bet = betSteps[betIdx];
    syncUI();
    pushLog('INFO', 'Bet -> ' + money(bet));
  });
  betPlus.addEventListener('click', ()=>{
    if(spinning) return;
    betIdx = Math.min(betSteps.length-1, betIdx+1);
    bet = betSteps[betIdx];
    syncUI();
    pushLog('INFO', 'Bet -> ' + money(bet));
  });

  function setAutoUI(on){
    autoOn = on;
    autoVal.textContent = on ? 'ON' : 'OFF';
    autoChip.classList.toggle('on', on);
  }
  function setTurboUI(on){
    turboOn = on;
    turboVal.textContent = on ? 'ON' : 'OFF';
    turboChip.classList.toggle('on', on);
  }
  autoChip.addEventListener('click', ()=>{
    setAutoUI(!autoOn);
    pushLog('INFO','AUTO ' + (autoOn?'ON':'OFF'));
    if(autoOn && !spinning) startSpin();
  });
  turboChip.addEventListener('click', ()=>{
    setTurboUI(!turboOn);
    pushLog('INFO','TURBO ' + (turboOn?'ON':'OFF'));
  });

  infoChip.addEventListener('click', ()=>{
    showToast('INFO: демо панель');
    pushLog('INFO','INFO tapped');
  });

  // lines buttons
  document.querySelectorAll('.lbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(spinning) return;
      const v = parseInt(btn.getAttribute('data-lines')||'20',10);
      activeLines = v;
      document.querySelectorAll('.lbtn').forEach(b=>b.classList.toggle('active', b===btn));
      pushLog('INFO', 'Lines -> ' + activeLines);
      showToast('Lines ' + activeLines);
      // draw sample lines quickly
      winLinesDraw = (paylinesMap[activeLines]||paylinesMap[20]).slice(0, Math.min(12, activeLines)).map((p,i)=>({lineIdx:i, pathRows:p, amount:0}));
      draw();
      setTimeout(()=>{ if(!spinning){ winLinesDraw=[]; draw(); } }, 900);
    });
  });

  // ---------- Launch -> Game ----------
  function enterGame(){
    launch.classList.add('hidden');
    game.classList.remove('hidden');
    fitCanvas();
    fillGrid();
    draw();
    pushLog('INFO','ENTER_GAME');
  }

  // <!-- ASSISTANT PATCH: v11 make launch tappable anywhere + reduce perceived loading -->
  launchTap.addEventListener('click', __enterOnce);
  launchEl.addEventListener('click', __enterOnce);
  launchEl.addEventListener('pointerdown', (e)=>{ e.preventDefault(); __enterOnce(); }, {passive:false});
  // Auto-enter fallback (if user taps outside center or browser delays click)
  setTimeout(()=>{ if(!__entered) __enterOnce(); }, 2200);


  // ---------- Preflight checks ----------
  function selfCheck(){
    pushLog('INFO','SELF_CHECK_START');
    const required = ['app','launch','game','reelsCanvas','spinBtn'];
    for(const id of required){
      if(!document.getElementById(id)) pushLog('WARN','missing element: #' + id);
    }
    // ensure no click-blocking overlays
    const el = document.elementFromPoint(20, 80);
    if(!el) pushLog('WARN','elementFromPoint returned null');
    pushLog('INFO','SELF_CHECK_DONE');
  }

  function onResize(){
    fitCanvas();
    drawLogo();
    if(!game.classList.contains('hidden')) draw();
  }
  window.addEventListener('resize', ()=>{ clearTimeout(onResize._t); onResize._t=setTimeout(onResize, 60); });
  window.addEventListener('orientationchange', ()=>{ setTimeout(onResize, 120); });

  // init
  (function init(){
    pushLog('INFO','BOOT');
    drawLogo();
    // <!-- ASSISTANT PATCH: v11 show ready state quickly -->
    setTimeout(()=>{ try{ document.getElementById('launch').classList.add('ready'); }catch(e){} }, 650);
    selfCheck();
    syncUI();
    // show first frame (launch)
    requestAnimationFrame(()=>{ /* first frame ok */ });
  })();

})();
</script>
</body>
</html>
