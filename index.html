<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
<title>BTLIDER</title>
<style>
  :root{--bg:#0b0f14;--panel:#0f1620;--panel2:#0c121a;--text:#e8f0ff;--muted:#8aa0b8;--accent:#2dd4bf;--danger:#fb7185;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  #root{position:fixed;inset:0;display:flex;gap:10px;padding:10px;box-sizing:border-box;}
  #logPane{width:min(420px,44vw);background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;}
  #logTop{display:flex;align-items:center;justify-content:space-between;padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.04),transparent);}
  #logTitle{font-weight:700;font-size:14px;letter-spacing:.2px;}
  #logBtns button{margin-left:6px;border:1px solid rgba(255,255,255,.12);background:var(--panel2);color:var(--text);padding:6px 10px;border-radius:10px;font-size:12px}
  #log{flex:1;overflow:auto;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px;line-height:1.35;white-space:pre-wrap;}
  .row{display:flex;gap:10px;flex:1;min-width:0;}
  #mainPane{flex:1;min-width:0;background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;}
  #bar{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid rgba(255,255,255,.08);}
  #status{flex:1;color:var(--muted);font-size:12px;}
  #progressWrap{height:8px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden;width:160px;}
  #progress{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#60a5fa);}
  iframe{border:0;flex:1;width:100%;background:#05070a;}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);font-size:12px;color:var(--muted);}
  .ok{color:var(--accent);}
  .bad{color:var(--danger);}
  @media (max-width:860px){#root{flex-direction:column} #logPane{width:100%;height:34vh}}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div id="root" class="row">
  <div id="logPane">
    <div id="logTop">
      <div id="logTitle">LOG</div>
      <div id="logBtns">
        <button id="copyBtn">COPY</button>
        <button id="clearBtn">CLEAR</button>
        <button id="hideBtn">HIDE</button>
      </div>
    </div>
    <div id="log"></div>
  </div>

  <div id="mainPane">
    <div id="bar">
      <div class="pill" id="buildPill"></div>
      <div class="pill" id="authPill">AUTH: <span id="authState" class="bad">NO</span></div>
      <div id="status">boot…</div>
      <div id="progressWrap"><div id="progress"></div></div>
    </div>
    <iframe id="appFrame" title="BTLIDER"></iframe>
  </div>
</div>

<script>
(function(){
  const logEl = document.getElementById('log');
  const statusEl = document.getElementById('status');
  const progEl = document.getElementById('progress');
  const buildPill = document.getElementById('buildPill');
  const authStateEl = document.getElementById('authState');
  const frame = document.getElementById('appFrame');

  const BUILD = '2026-02-04 09:08:10 UTC';

  // ASSISTANT PATCH: gesture gate to prevent auto-opening modals
  let __lastGestureAt = 0;
  function __markGesture(){ __lastGestureAt = Date.now(); }
  window.addEventListener('pointerdown', __markGesture, {capture:true, passive:true});
  window.addEventListener('keydown', __markGesture, {capture:true});
  window.addEventListener('touchstart', __markGesture, {capture:true, passive:true});
  function __recentGesture(ms=1200){ return (Date.now()-__lastGestureAt) <= ms; }
  buildPill.textContent = 'BUILD: v32';

  function ts(){
    const d = new Date();
    return d.toTimeString().slice(0,8);
  }
  function append(line){
    logEl.textContent += line + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }
  function L(tag, msg, obj){
    try{
      const s = (obj!==undefined) ? ' | ' + JSON.stringify(obj) : '';
      append(`[${ts()}] ${tag}: ${msg}${s}`);
    }catch(e){
      append(`[${ts()}] ${tag}: ${msg}`);
    }
  }
  window.__BTLIDER_LOG = function(tag,msg,obj){ L(tag,msg,obj); };
  window.log = function(a,b,c){ L(String(a||'LOG'), String(b||''), c); };

  function setStatus(t){ statusEl.textContent = t; }
  function setProgress(p){ progEl.style.width = Math.max(0,Math.min(100,Number(p)||0)) + '%'; }

  document.getElementById('copyBtn').onclick = async () => {
    try{ await navigator.clipboard.writeText(logEl.textContent); }catch(e){}
    L('UI','COPY');
  };
  document.getElementById('clearBtn').onclick = () => { logEl.textContent=''; L('UI','CLEAR'); };
  document.getElementById('hideBtn').onclick = () => {
    const lp = document.getElementById('logPane');
    lp.style.display = (lp.style.display==='none') ? '' : 'none';
    L('UI','HIDE_TOGGLE');
  };

  window.addEventListener('error', (e)=>{
    L('ERROR', (e && e.message) ? e.message : 'error', { filename: e && e.filename, lineno: e && e.lineno, colno: e && e.colno });
  });
  window.addEventListener('unhandledrejection', (e)=>{
    const r = e && e.reason;
    L('REJ', (r && r.message) ? r.message : String(r||'unhandled'), r && r.stack ? {stack:r.stack} : undefined);
  });

  const SB_URL = 'https://vshzqiqppgitnhuqmcgn.supabase.co';
  const SB_KEY = 'sb_publishable_DJSaoIKQQPU_5rio3xt8ZQ_8H_6Xs4X';
  let sb = null;

  function getSB(){
    if(sb) return sb;
    if(!(window.supabase && window.supabase.createClient)){
      L('AUTH','Supabase lib missing');
      return null;
    }
    sb = window.supabase.createClient(SB_URL, SB_KEY, { auth: { detectSessionInUrl:true, persistSession:true, autoRefreshToken:true } });
    return sb;
  }

  function setAuthed(session, user, source){
    window.__BTLIDER_AUTHED = !!session;
    window.__BTLIDER_AUTH = { session: session ? {expires_at: session.expires_at} : null, user: user ? {id:user.id, email:user.email} : null, source: source||'' };
    authStateEl.textContent = window.__BTLIDER_AUTHED ? 'YES' : 'NO';
    authStateEl.className = window.__BTLIDER_AUTHED ? 'ok' : 'bad';
    L('AUTH', (window.__BTLIDER_AUTHED?'session=YES':'session=NO') + (user&&user.email?(' '+user.email):''), {source:source||''});
    try{ frame.contentWindow && frame.contentWindow.postMessage({type:'BTLIDER_AUTH_CHANGED', payload:{authed:!!window.__BTLIDER_AUTHED, user: window.__BTLIDER_AUTH.user}}, '*'); }catch(_e){}
  }

  async function syncSession(reason){
    const s = getSB(); if(!s) return;
    try{
      const { data, error } = await s.auth.getSession();
      if(error) throw error;
      const session = data && data.session;
      let user = null;
      if(session){
        try{
          const u = await s.auth.getUser();
          user = (u && u.data && u.data.user) ? u.data.user : (session.user||null);
        }catch(_e){ user = session.user||null; }
      }
      setAuthed(session, user, reason||'getSession');
    }catch(err){
      setAuthed(null, null, 'error');
      L('AUTH_ERR','syncSession failed', {message: err && err.message ? err.message : String(err)});
    }
  }

  window.BTLIDER = window.BTLIDER || {};
  window.BTLIDER.Auth = {
    async register(email, password){
      const s = getSB(); if(!s) throw new Error('Supabase not ready');
      L('AUTH_CALL','signUp', {email});
      const { data, error } = await s.auth.signUp({ email, password });
      if(error){ L('AUTH_ERR','signUp', {message:error.message}); throw error; }
      await syncSession('signUp');
      return data;
    },
    async login(email, password){
      const s = getSB(); if(!s) throw new Error('Supabase not ready');
      L('AUTH_CALL','signInWithPassword', {email});
      const { data, error } = await s.auth.signInWithPassword({ email, password });
      if(error){ L('AUTH_ERR','signIn', {message:error.message}); throw error; }
      await syncSession('signIn');
      return data;
    },
    async logout(){
      const s = getSB(); if(!s) throw new Error('Supabase not ready');
      L('AUTH_CALL','signOut');
      const { error } = await s.auth.signOut();
      if(error){ L('AUTH_ERR','signOut', {message:error.message}); throw error; }
      await syncSession('signOut');
      return true;
    },
    async getSession(){
      const s = getSB(); if(!s) return null;
      const { data, error } = await s.auth.getSession();
      if(error) throw error;
      return data && data.session;
    }
  };

  function routeTo(page){
    const next = page;
    try{
      frame.src = next;
      L('ROUTE','-> ' + next);
    }catch(e){
      L('ROUTE_ERR','frame src failed', {message:e.message, page: next});
    }
  }

  function routeHome(){
    const authed = !!window.__BTLIDER_AUTHED;
    routeTo(authed ? 'authed.html' : 'guest.html');
  }

  function routePromo(){
    routeTo('promo_bonus.html');
  }

  window.__BTLIDER_GO_HOME = routeHome;
  window.__BTLIDER_GO_PROMO = routePromo;

  window.addEventListener('message', (ev)=>{
    const d = ev && ev.data;
    if(!d) return;
    const t = (typeof d === 'string') ? d : d.type;
    if(t === 'NAV_HOME' || t === 'HOME' || t === 'ASSISTANT_HOME') routeHome();
    if(t === 'NAV_PROMO' || t === 'OPEN_PROMO' || t === 'PROMO') routePromo();
    if(t === 'AUTH_LOGOUT') window.BTLIDER.Auth.logout().catch(()=>{});
    if(t === 'AUTH_LOGIN' && d.payload) window.BTLIDER.Auth.login(d.payload.email, d.payload.password).catch(()=>{});
    if(t === 'AUTH_REGISTER' && d.payload) window.BTLIDER.Auth.register(d.payload.email, d.payload.password).catch(()=>{});
  });

  (async function boot(){
    append(`[${ts()}] BUILD: ${BUILD}`);
    setProgress(5);
    setStatus('auth init…');
    await syncSession('boot');
    const s = getSB();
    if(s){
      s.auth.onAuthStateChange((event, session)=>{
        L('AUTH_EVT', event, session ? {expires_at:session.expires_at} : null);
        setAuthed(session, session ? (session.user||null) : null, event);
        routeHome();
      });
    }
    setStatus('routing…');
    routeHome();
    setProgress(100);
    setStatus('ready');
  })();
})();
</script>

<!-- ASSISTANT PATCH: v28 full sync wallets/profile; build 2026-02-04 08:40:22 UTC -->
<style>

#btlLogPanel{position:fixed;left:8px;top:56px;width:min(46vw,460px);height:70vh;z-index:2147483000;
background:rgba(0,0,0,.72);color:#e7e7e7;border:1px solid rgba(255,255,255,.15);border-radius:14px;backdrop-filter: blur(8px);padding:10px;display:none}
#btlLogPanel pre{margin:8px 0 0 0;white-space:pre-wrap;word-break:break-word;font:12px/1.25 monospace;max-height:calc(70vh - 52px);overflow:auto}
#btlLogPanel .row{display:flex;gap:8px;align-items:center}
#btlLogPanel button{background:#222;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:6px 10px;font:12px sans-serif}
#btlLogToggle{position:fixed;right:10px;bottom:10px;z-index:2147483001;background:#111;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:10px 14px;font:12px sans-serif}
#btlProfileModal{position:fixed;inset:0;z-index:2147483002;display:none;align-items:center;justify-content:center}
#btlProfileModal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.78);backdrop-filter:blur(14px) saturate(1.2);-webkit-backdrop-filter:blur(14px) saturate(1.2)}
#btlProfileModal .card{position:relative;max-width:640px;width:min(94vw,640px);
  border-radius:24px; padding:18px 16px 14px;
  color:#eafff6;
  background:
    radial-gradient(900px 420px at 18% -10%, rgba(185,255,0,.16), transparent 60%),
    radial-gradient(700px 360px at 92% 8%, rgba(0,170,255,.14), transparent 62%),
    radial-gradient(520px 320px at 50% 112%, rgba(255,90,120,.10), transparent 70%),
    linear-gradient(180deg, rgba(10,14,18,.96), rgba(6,8,10,.96));
  border:1px solid rgba(255,255,255,.14);
  box-shadow:0 24px 80px rgba(0,0,0,.65), 0 0 0 1px rgba(185,255,0,.12) inset;
  overflow:hidden}
#btlProfileModal .card:before{content:'';position:absolute;inset:0;pointer-events:none;opacity:.9;
  background:
    repeating-linear-gradient(135deg, rgba(255,255,255,.05) 0 1px, transparent 1px 9px);
  mix-blend-mode:overlay}
#btlProfileModal .card:after{content:'';position:absolute;left:-40px;top:-60px;width:220px;height:220px;border-radius:60px;
  background:radial-gradient(circle at 30% 30%, rgba(185,255,0,.35), rgba(185,255,0,0) 70%);
  filter:blur(0px);opacity:.55;pointer-events:none;transform:rotate(12deg)}
#btlProfileModal .head{display:flex;align-items:center;gap:12px;margin-bottom:12px;position:relative}
#btlProfileModal .avatar{width:46px;height:46px;border-radius:16px;
  background:linear-gradient(135deg, rgba(185,255,0,.28), rgba(0,170,255,.18));
  border:1px solid rgba(255,255,255,.18);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 10px 28px rgba(0,0,0,.45)}
#btlProfileModal .avatar span{font-weight:900;letter-spacing:.5px;color:#f2ffe0;text-shadow:0 1px 0 rgba(0,0,0,.4)}
#btlProfileModal .title{display:flex;flex-direction:column;gap:2px}
#btlProfileModal .title h3{margin:0;font-weight:900;font-size:16px;letter-spacing:.2px}
#btlProfileModal .subtitle{font-size:12px;color:rgba(234,255,246,.72)}
#btlProfileModal .divider{height:1px;background:linear-gradient(90deg, rgba(185,255,0,.22), rgba(255,255,255,.10), rgba(0,170,255,.18));margin:12px 0}
#btlProfileModal .kv{display:grid;grid-template-columns:140px 1fr;gap:8px 10px;align-items:center;margin-top:2px}
#btlProfileModal .kv .k{font-size:12px;color:rgba(234,255,246,.70)}
#btlProfileModal .kv .v{font-size:13px;color:#eafff6;word-break:break-word}
#btlProfileModal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;position:relative}
#btlProfileModal .actions button{border-radius:14px;padding:10px 14px;font-size:13px;font-weight:800;
  border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:#eafff6}
#btlProfileModal .actions button:active{transform:translateY(1px)}
#btlProfileModal #btlCloseProfile{background:rgba(255,255,255,.04)}
#btlProfileModal #btlLogout{border-color:rgba(185,255,0,.30);
  background:linear-gradient(90deg, rgba(185,255,0,.26), rgba(0,170,255,.18));
  box-shadow:0 12px 30px rgba(0,0,0,.35)}

</style>
<div id="btlLogPanel"><div class="row">
  <button id="btlCopy">COPY</button><button id="btlClear">CLEAR</button><button id="btlHide">HIDE</button>
  <div style="margin-left:auto;font:12px sans-serif;opacity:.85">BTL LOG</div>
</div><pre id="btlLog"></pre></div>
<button id="btlLogToggle">LOG</button>

<div id="btlProfileModal">
  <div class="backdrop"></div>
  <div class="card">
    <div class="head">
      <div class="avatar" aria-hidden="true"><span id="btlProfileAvatar">BT</span></div>
      <div class="title">
        <h3>Профіль</h3>
        <div class="subtitle" id="btlProfileSubtitle">Синхронізація з БД</div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="kv" id="btlProfileKV"></div>
    <div class="actions">
      <button id="btlCloseProfile">Закрити</button>
      <button id="btlLogout">Вийти</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(() => {
  const BUILD = "BTLIDER v30 full 2026-02-04 10:20:00 UTC";
  const logLines = [];
  const logEl = document.getElementById('btlLog');
  const panel = document.getElementById('btlLogPanel');
  const toggleBtn = document.getElementById('btlLogToggle');
  function _push(line, obj){
    const ts = new Date().toLocaleTimeString('uk-UA', {hour12:false});
    const s = `[${ts}] ${line}` + (obj ? ` | ${JSON.stringify(obj)}` : '');
    logLines.push(s);
    if(logLines.length>400) logLines.splice(0, logLines.length-400);
    if(logEl) logEl.textContent = logLines.join("\n");
    try { console.log(s); } catch(e){}
  }
  window.__BTLIDER_LOG = _push;
  window.addEventListener('error', (e)=>_push('ERROR: '+(e.message||'') , {filename:e.filename, lineno:e.lineno, colno:e.colno}));
  window.addEventListener('unhandledrejection', (e)=>_push('REJ: '+(e.reason?.message||String(e.reason)), null));

  document.getElementById('btlCopy')?.addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText(logLines.join("\n")); _push('COPIED'); } catch(e) { _push('COPY_FAIL', {err:String(e)}); }
  });
  document.getElementById('btlClear')?.addEventListener('click', ()=>{ logLines.length=0; logEl.textContent=''; });
  document.getElementById('btlHide')?.addEventListener('click', ()=>{ panel.style.display='none'; });
  toggleBtn?.addEventListener('click', ()=>{ panel.style.display = (panel.style.display==='none'||!panel.style.display)?'block':'none'; });

  _push('BUILD: '+BUILD);

  // Supabase
  const supabase = window.supabase.createClient("https://vshzqiqppgitnhuqmcgn.supabase.co", "sb_publishable_DJSaoIKQQPU_5rio3xt8ZQ_8H_6Xs4X", {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });
  window.BTLIDER = window.BTLIDER || {};
  window.BTLIDER.supabase = supabase;

  const iframe = document.querySelector('iframe') || document.getElementById('appFrame');
  function setFrame(url){
    if(!iframe) return;
    iframe.src = url;
    _push('route -> '+url);
  }

  let currentUser = null;
  let currentWallet = null;

  async function fetchWallet(user){
    if(!user) return null;
    _push('DB_CALL: wallets.select', {user_id:user.id});
    let {data, error} = await supabase.from('wallets').select('user_id,balance,currency').eq('user_id', user.id).maybeSingle();
    if(error) {
      _push('DB_ERR: wallets.select', {msg:error.message});
      return null;
    }
    if(!data) {
      _push('DB_CALL: wallets.insert', {user_id:user.id});
      const ins = await supabase.from('wallets').insert({ user_id:user.id, balance: 0, currency: 'UAH' }).select('user_id,balance,currency').maybeSingle();
      if(ins.error) { _push('DB_ERR: wallets.insert', {msg:ins.error.message}); return null; }
      data = ins.data;
    }
    currentWallet = data;
    return data;
  }

  function broadcastAuth(){
    const payload = { authed: !!currentUser, user: currentUser ? { id: currentUser.id, email: currentUser.email } : null, wallet: currentWallet };
    try { iframe?.contentWindow?.postMessage({ type:'BTLIDER_AUTH_CHANGED', payload }, '*'); } catch(e) {}
  }

  function updateBalanceUI(wallet){
    if(!wallet) return;
    const bal = (wallet.balance ?? 0);
    const cur = (wallet.currency ?? 'UAH');
    // update common targets
    const targets = new Set();
    document.querySelectorAll('[data-btl-balance]').forEach(el=>targets.add(el));
    ['balance','userBalance','hudBalance','walletBalance'].forEach(id=>{ const el=document.getElementById(id); if(el) targets.add(el); });
    document.querySelectorAll('[class*="balance" i],[id*="balance" i]').forEach(el=>targets.add(el));
    targets.forEach(el=>{
      try {
        if(el.tagName==='INPUT') el.value = String(bal);
        else el.textContent = `${bal} ${cur}`;
      } catch(e){}
    });
    // compatibility for legacy offline widgets
    try {
      localStorage.setItem('BTLIDER_BALANCE', String(bal));
      localStorage.setItem('balance', String(bal));
      localStorage.setItem('user_balance', String(bal));
      localStorage.setItem('currency', String(cur));
    } catch(e){}
  }

  async function applySession(source){
    const { data, error } = await supabase.auth.getSession();
    if(error) _push('AUTH_ERR: getSession', {msg:error.message});
    const session = data?.session || null;
    currentUser = session?.user || null;
    _push('AUTH: session='+(session?'YES':'NO'), {source});
    currentWallet = null;
    if(currentUser) {
      await fetchWallet(currentUser);
      updateBalanceUI(currentWallet);
      setFrame('authed.html');
    } else {
      setFrame('guest.html');
    }
    broadcastAuth();
  }

  supabase.auth.onAuthStateChange(async (event, session)=>{
    _push('AUTH_EVT: '+event, session?.user?.email?{user:session.user.email}:null);
    currentUser = session?.user || null;
    currentWallet = null;
    if(currentUser) {
      await fetchWallet(currentUser);
      updateBalanceUI(currentWallet);
      setFrame('authed.html');
    } else {
      setFrame('guest.html');
    }
    broadcastAuth();
  });

  // Public API for iframes
  window.BTLIDER.Auth = {
    async register(email, password) {
      _push('AUTH_CALL: signUp', {email});
      const { data, error } = await supabase.auth.signUp({ email, password });
      if(error) { _push('AUTH_ERR: signUp', {msg:error.message}); throw error; }
      _push('AUTH_RES: signUp', {session:!!data.session, user:!!data.user});
      return data;
    },
    async login(email, password) {
      _push('AUTH_CALL: signIn', {email});
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) { _push('AUTH_ERR: signIn', {msg:error.message}); throw error; }
      _push('AUTH_RES: signIn', {session:!!data.session, user:!!data.user});
      return data;
    },
    async logout() {
      _push('AUTH_CALL: signOut');
      const { error } = await supabase.auth.signOut();
      if(error) { _push('AUTH_ERR: signOut', {msg:error.message}); throw error; }
      _push('AUTH_RES: signOut');
    },
    async getWallet() {
      if(!currentUser) return null;
      if(!currentWallet) await fetchWallet(currentUser);
      return currentWallet;
    },
    async refreshWallet() {
      if(!currentUser) return null;
      currentWallet = null;
      const w = await fetchWallet(currentUser);
      updateBalanceUI(w);
      broadcastAuth();
      return w;
    },
    async getUser() { return currentUser ? { id: currentUser.id, email: currentUser.email } : null; },
  };

  // Profile modal
  const modal = document.getElementById('btlProfileModal');
  const kv = document.getElementById('btlProfileKV');
  function openProfile(){
    if(!modal) return;
    const u = currentUser;
    const w = currentWallet;
    const rows = [
      ['Email', u?.email || '—'],
      ['User ID', u?.id || '—'],
      ['Баланс', w ? `${w.balance} ${w.currency}` : '—'],
    ];
    // header bits
    const av = document.getElementById('btlProfileAvatar');
    const sub = document.getElementById('btlProfileSubtitle');
    if(av){
      const src = (u?.email || u?.id || 'BT').trim();
      const letters = src.includes('@') ? src.split('@')[0] : src;
      av.textContent = (letters.slice(0,2) || 'BT').toUpperCase();
    }
    if(sub){ sub.textContent = w ? `Wallet: ${w.currency} • synced` : 'Wallet: —'; }
    kv.innerHTML = rows.map(([k,v])=>`<div class="k">${k}</div><div class="v">${String(v).replace(/</g,'&lt;')}</div>`).join('');
    modal.style.display='flex';
  }
  function closeProfile(){ modal.style.display='none'; }
  modal?.querySelector('.backdrop')?.addEventListener('click', closeProfile);
  document.getElementById('btlCloseProfile')?.addEventListener('click', closeProfile);
  document.getElementById('btlLogout')?.addEventListener('click', async ()=>{ try{await window.BTLIDER.Auth.logout(); closeProfile();}catch(e){} });

  window.BTLIDER.UI = { openProfile, openPromo:()=>setFrame('promo_bonus.html'), home:()=>applySession('home') };

  window.addEventListener('message', (ev)=>{
    const t = ev.data?.type;
    if(t==='OPEN_PROFILE'){
      if(__recentGesture()) openProfile();
      else safeLog('WARN','OPEN_PROFILE ignored (no user gesture)');
    }
    if(t==='OPEN_PROMO') setFrame('promo_bonus.html');
    if(t==='HOME') applySession('home_msg');
    if(t==='NEED_BALANCE') window.BTLIDER.Auth.refreshWallet();
  });

  // boot
  applySession('boot');

})();
</script>

<!-- ASSISTANT PATCH: MESSAGE ROUTER v31 -->
<script>
(function(){
  function safeLog(l,m,o){ try{ if(window.__BTLIDER_LOG) window.__BTLIDER_LOG(l,m,o);}catch(e){} }
  window.addEventListener('message', function(ev){
    const d = ev.data;
    if(!d || d.__BTLIDER!==true) return;
    const t = d.type;
    const p = d.payload||{};
    if(t==='OPEN_PROMO'){ safeLog('INFO','route -> promo_bonus.html', p); if(typeof window.routeTo==='function') window.routeTo('promo_bonus.html'); return; }
    if(t==='OPEN_PROFILE'){ safeLog('INFO','open profile', p); if(typeof window.openProfile==='function') window.openProfile(); return; }
    if(t==='OPEN_AUTH'){ safeLog('INFO','open auth', p); if(typeof window.openAuth==='function') window.openAuth(p.mode||'login'); return; }
    if(t==='DO_LOGOUT'){ if(window.BTLIDER && window.BTLIDER.Auth && window.BTLIDER.Auth.logout){ window.BTLIDER.Auth.logout(); } return; }
    if(t==='GO_HOME'){ if(typeof window.routeTo==='function') window.routeTo('authed.html'); return; }
    if(t==='GO_GUEST'){ if(typeof window.routeTo==='function') window.routeTo('guest.html'); return; }
    if(t==='PAGE_READY'){ /* ignore */ return; }
  });
})();
</script>

<!-- ASSISTANT PATCH: WALLET BALANCE v31 (wallets -> profiles fallback) -->
<script>
(function(){
  function safeLog(l,m,o){ try{ if(window.__BTLIDER_LOG) window.__BTLIDER_LOG(l,m,o);}catch(e){} }
  async function getBalanceForUser(supa, user){
    if(!supa || !user) return {balance:0,currency:'UAH'};
    const uid = user.id;
    // try wallets
    try{
      safeLog('INFO','DB_CALL: wallets.select',{user_id:uid});
      const {data, error} = await supa.from('wallets').select('balance,currency').eq('user_id', uid).maybeSingle();
      if(!error && data){
        return {balance: data.balance ?? 0, currency: data.currency || 'UAH'};
      }
      if(error){
        safeLog('WARN','DB_WARN: wallets.select', {message:error.message, code:error.code});
      }
      if(!data && !error){
        safeLog('INFO','DB_CALL: wallets.insert',{user_id:uid});
        const ins = await supa.from('wallets').insert({user_id: uid, balance: 0, currency: 'UAH'}).select('balance,currency').maybeSingle();
        if(!ins.error && ins.data){
          return {balance: ins.data.balance ?? 0, currency: ins.data.currency || 'UAH'};
        }
        if(ins.error){
          safeLog('WARN','DB_WARN: wallets.insert', {message:ins.error.message, code:ins.error.code});
        }
      }
    }catch(e){
      safeLog('WARN','DB_EX: wallets', {message: String(e && e.message || e)});
    }
    // fallback profiles
    try{
      safeLog('INFO','DB_CALL: profiles.select',{id:uid});
      const {data, error} = await supa.from('profiles').select('balance,currency').eq('id', uid).maybeSingle();
      if(!error && data){
        return {balance: data.balance ?? 0, currency: data.currency || 'UAH'};
      }
      if(error){
        safeLog('WARN','DB_WARN: profiles.select', {message:error.message, code:error.code});
      }
    }catch(e){
      safeLog('WARN','DB_EX: profiles', {message: String(e && e.message || e)});
    }
    return {balance:0,currency:'UAH'};
  }
  window.__BTLIDER_GET_BALANCE = getBalanceForUser;
})();
</script>

<!-- ASSISTANT PATCH: BALANCE SYNC v31 -->
<script>
(function(){
  function safeLog(l,m,o){ try{ if(window.__BTLIDER_LOG) window.__BTLIDER_LOG(l,m,o);}catch(e){} }
  async function syncBalanceFromDB(source){
    try{
      const supa = window.__BTLIDER_SUPABASE || (window.BTLIDER && window.BTLIDER.supabase) || window.supabaseClient;
      if(!supa || !supa.auth) return;
      const {data} = await supa.auth.getUser();
      const user = data && data.user;
      if(!user) return;
      const getter = window.__BTLIDER_GET_BALANCE;
      const bal = getter ? await getter(supa, user) : {balance:0,currency:'UAH'};
      safeLog('INFO','BALANCE_SYNC', {source: source||'manual', balance: bal.balance, currency: bal.currency});
      try{
        const frame = document.querySelector('iframe');
        if(frame && frame.contentWindow){
          frame.contentWindow.postMessage({__BTLIDER:true, type:'BTLIDER_BALANCE', payload: bal}, '*');
        }
      }catch(e){}
      // also update any balance nodes in index
      try{
        document.querySelectorAll('[data-btl-balance], [id*="balance" i], [class*="balance" i]').forEach(n=>{
          const txt = String(bal.balance)+' '+(bal.currency||'UAH');
          if(n.tagName==='INPUT') n.value = txt; else n.textContent = txt;
        });
      }catch(e){}
      try{
        localStorage.setItem('BTLIDER_BALANCE', String(bal.balance||0));
        localStorage.setItem('BTLIDER_CURRENCY', String(bal.currency||'UAH'));
      }catch(e){}
    }catch(e){
      safeLog('WARN','BALANCE_SYNC_ERR',{message:String(e && e.message || e)});
    }
  }
  window.__BTLIDER_SYNC_BALANCE = syncBalanceFromDB;

  // hook into auth changes if possible
  const orig = window.__BTLIDER_onAuthChanged;
  window.__BTLIDER_onAuthChanged = async function(payload){
    try{ if(typeof orig==='function') orig(payload); }catch(e){}
    await syncBalanceFromDB('auth_change');
  };

  // try once after load
  window.addEventListener('load', ()=>{ setTimeout(()=>syncBalanceFromDB('boot'), 600); });
})();
</script>
</body>
</html>
