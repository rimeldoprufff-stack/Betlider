<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
<title>BTLIDER</title>
<style>
  :root{--bg:#0b0f14;--panel:#0f1620;--panel2:#0c121a;--text:#e8f0ff;--muted:#8aa0b8;--accent:#2dd4bf;--danger:#fb7185;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  #root{position:fixed;inset:0;display:flex;gap:10px;padding:10px;box-sizing:border-box;}
  #logPane{width:min(420px,44vw);background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;}
  #logTop{display:flex;align-items:center;justify-content:space-between;padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.04),transparent);}
  #logTitle{font-weight:700;font-size:14px;letter-spacing:.2px;}
  #logBtns button{margin-left:6px;border:1px solid rgba(255,255,255,.12);background:var(--panel2);color:var(--text);padding:6px 10px;border-radius:10px;font-size:12px}
  #log{flex:1;overflow:auto;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px;line-height:1.35;white-space:pre-wrap;}
  .row{display:flex;gap:10px;flex:1;min-width:0;}
  #mainPane{flex:1;min-width:0;background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;}
  #bar{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid rgba(255,255,255,.08);}
  #status{flex:1;color:var(--muted);font-size:12px;}
  #progressWrap{height:8px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden;width:160px;}
  #progress{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#60a5fa);}
  iframe{border:0;flex:1;width:100%;background:#05070a;}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);font-size:12px;color:var(--muted);}
  .ok{color:var(--accent);}
  .bad{color:var(--danger);}
  @media (max-width:860px){#root{flex-direction:column} #logPane{width:100%;height:34vh}}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div id="root" class="row">
  <div id="logPane">
    <div id="logTop">
      <div id="logTitle">LOG</div>
      <div id="logBtns">
        <button id="copyBtn">COPY</button>
        <button id="clearBtn">CLEAR</button>
        <button id="hideBtn">HIDE</button>
      </div>
    </div>
    <div id="log"></div>
  </div>

  <div id="mainPane">
    <div id="bar">
      <div class="pill" id="buildPill"></div>
      <div class="pill" id="authPill">AUTH: <span id="authState" class="bad">NO</span></div>
      <div id="status">boot…</div>
      <div id="progressWrap"><div id="progress"></div></div>
    </div>
    <iframe id="appFrame" title="BTLIDER"></iframe>
  </div>
</div>

<script>
(function(){
  const logEl = document.getElementById('log');
  const statusEl = document.getElementById('status');
  const progEl = document.getElementById('progress');
  const buildPill = document.getElementById('buildPill');
  const authStateEl = document.getElementById('authState');
  const frame = document.getElementById('appFrame');

  const BUILD = 'BTLIDER v19 build 2026-02-03 23:42:48 UTC';
  buildPill.textContent = 'BUILD: v19';

  function ts(){
    const d = new Date();
    return d.toTimeString().slice(0,8);
  }
  function append(line){
    logEl.textContent += line + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }
  function L(tag, msg, obj){
    try{
      const s = (obj!==undefined) ? ' | ' + JSON.stringify(obj) : '';
      append(`[${ts()}] ${tag}: ${msg}${s}`);
    }catch(e){
      append(`[${ts()}] ${tag}: ${msg}`);
    }
  }
  window.__BTLIDER_LOG = function(tag,msg,obj){ L(tag,msg,obj); };
  window.log = function(a,b,c){ L(String(a||'LOG'), String(b||''), c); };

  function setStatus(t){ statusEl.textContent = t; }
  function setProgress(p){ progEl.style.width = Math.max(0,Math.min(100,Number(p)||0)) + '%'; }

  document.getElementById('copyBtn').onclick = async () => {
    try{ await navigator.clipboard.writeText(logEl.textContent); }catch(e){}
    L('UI','COPY');
  };
  document.getElementById('clearBtn').onclick = () => { logEl.textContent=''; L('UI','CLEAR'); };
  document.getElementById('hideBtn').onclick = () => {
    const lp = document.getElementById('logPane');
    lp.style.display = (lp.style.display==='none') ? '' : 'none';
    L('UI','HIDE_TOGGLE');
  };

  window.addEventListener('error', (e)=>{
    L('ERROR', (e && e.message) ? e.message : 'error', { filename: e && e.filename, lineno: e && e.lineno, colno: e && e.colno });
  });
  window.addEventListener('unhandledrejection', (e)=>{
    const r = e && e.reason;
    L('REJ', (r && r.message) ? r.message : String(r||'unhandled'), r && r.stack ? {stack:r.stack} : undefined);
  });

  const SB_URL = 'https://vshzqiqppgitnhuqmcgn.supabase.co';
  const SB_KEY = 'sb_publishable_DJSaoIKQQPU_5rio3xt8ZQ_8H_6Xs4X';
  let sb = null;

  function getSB(){
    if(sb) return sb;
    if(!(window.supabase && window.supabase.createClient)){
      L('AUTH','Supabase lib missing');
      return null;
    }
    sb = window.supabase.createClient(SB_URL, SB_KEY, { auth: { detectSessionInUrl:true, persistSession:true, autoRefreshToken:true } });
    return sb;
  }

  function setAuthed(session, user, source){
    window.__BTLIDER_AUTHED = !!session;
    window.__BTLIDER_AUTH = { session: session ? {expires_at: session.expires_at} : null, user: user ? {id:user.id, email:user.email} : null, source: source||'' };
    authStateEl.textContent = window.__BTLIDER_AUTHED ? 'YES' : 'NO';
    authStateEl.className = window.__BTLIDER_AUTHED ? 'ok' : 'bad';
    L('AUTH', (window.__BTLIDER_AUTHED?'session=YES':'session=NO') + (user&&user.email?(' '+user.email):''), {source:source||''});
    try{ frame.contentWindow && frame.contentWindow.postMessage({type:'BTLIDER_AUTH_CHANGED', payload:{authed:!!window.__BTLIDER_AUTHED, user: window.__BTLIDER_AUTH.user}}, '*'); }catch(_e){}
  }

  async function syncSession(reason){
    const s = getSB(); if(!s) return;
    try{
      const { data, error } = await s.auth.getSession();
      if(error) throw error;
      const session = data && data.session;
      let user = null;
      if(session){
        try{
          const u = await s.auth.getUser();
          user = (u && u.data && u.data.user) ? u.data.user : (session.user||null);
        }catch(_e){ user = session.user||null; }
      }
      setAuthed(session, user, reason||'getSession');
    }catch(err){
      setAuthed(null, null, 'error');
      L('AUTH_ERR','syncSession failed', {message: err && err.message ? err.message : String(err)});
    }
  }

  window.BTLIDER = window.BTLIDER || {};
  window.BTLIDER.Auth = {
    async register(email, password){
      const s = getSB(); if(!s) throw new Error('Supabase not ready');
      L('AUTH_CALL','signUp', {email});
      const { data, error } = await s.auth.signUp({ email, password });
      if(error){ L('AUTH_ERR','signUp', {message:error.message}); throw error; }
      await syncSession('signUp');
      return data;
    },
    async login(email, password){
      const s = getSB(); if(!s) throw new Error('Supabase not ready');
      L('AUTH_CALL','signInWithPassword', {email});
      const { data, error } = await s.auth.signInWithPassword({ email, password });
      if(error){ L('AUTH_ERR','signIn', {message:error.message}); throw error; }
      await syncSession('signIn');
      return data;
    },
    async logout(){
      const s = getSB(); if(!s) throw new Error('Supabase not ready');
      L('AUTH_CALL','signOut');
      const { error } = await s.auth.signOut();
      if(error){ L('AUTH_ERR','signOut', {message:error.message}); throw error; }
      await syncSession('signOut');
      return true;
    },
    async getSession(){
      const s = getSB(); if(!s) return null;
      const { data, error } = await s.auth.getSession();
      if(error) throw error;
      return data && data.session;
    }
  };

  function route(){
    const authed = !!window.__BTLIDER_AUTHED;
    const next = authed ? 'authed.html' : 'guest.html';
    try{
      frame.src = next;
      L('ROUTE','-> ' + next);
    }catch(e){
      L('ROUTE_ERR','frame src failed', {message:e.message});
    }
  }
  window.__BTLIDER_GO_HOME = route;

  window.addEventListener('message', (ev)=>{
    const d = ev && ev.data;
    if(!d) return;
    const t = (typeof d === 'string') ? d : d.type;
    if(t === 'NAV_HOME' || t === 'HOME' || t === 'ASSISTANT_HOME') route();
    if(t === 'AUTH_LOGOUT') window.BTLIDER.Auth.logout().catch(()=>{});
    if(t === 'AUTH_LOGIN' && d.payload) window.BTLIDER.Auth.login(d.payload.email, d.payload.password).catch(()=>{});
    if(t === 'AUTH_REGISTER' && d.payload) window.BTLIDER.Auth.register(d.payload.email, d.payload.password).catch(()=>{});
  });

  (async function boot(){
    append(`[${ts()}] BUILD: ${BUILD}`);
    setProgress(5);
    setStatus('auth init…');
    await syncSession('boot');
    const s = getSB();
    if(s){
      s.auth.onAuthStateChange((event, session)=>{
        L('AUTH_EVT', event, session ? {expires_at:session.expires_at} : null);
        setAuthed(session, session ? (session.user||null) : null, event);
        route();
      });
    }
    setStatus('routing…');
    route();
    setProgress(100);
    setStatus('ready');
  })();
})();
</script>
</body>
</html>
