<!doctype html>
<html lang="uk">
<head>
<!-- ASSISTANT PATCH: early addLine stub v23.14 -->
<script>
(function(){
  window.__BTLIDER_LINES = window.__BTLIDER_LINES || [];
  window.addLine = window.addLine || function(tag,msg,obj){
    try{
      window.__BTLIDER_LINES.push([Date.now(), tag, msg, obj]);
      if(window.__BTLIDER_LINES.length>600) window.__BTLIDER_LINES.shift();
    }catch(e){}
  };
})();
</script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>BTLIDER</title>
  <style>
/* ASSISTANT PATCH: HEADER GUARD (keep top header visible) */
:root { --btlider-header-z: 2147483000; }
.btlider-header-guard-visible {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  transform: none !important;
  pointer-events: auto !important;
}
.btlider-header-guard-fixed {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  z-index: var(--btlider-header-z) !important;
}

    html,body{height:100%;margin:0;background:#05070b;color:#e8eefc;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    #app{position:fixed;inset:0;display:flex;flex-direction:column}
    #frameWrap{position:relative;flex:1 1 auto;min-height:0}
    #appFrame{position:absolute;inset:0;width:100%;height:100%;border:0;background:transparent}
    #splash{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;
      background:radial-gradient(1200px 800px at 50% 30%, rgba(44,56,86,.45), rgba(10,12,18,.94));
      z-index:50}
    #progressBar{width:min(520px,86vw);height:10px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden}
    #progressBar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#6ea8ff,#9b7bff,#ff6ea8);transition:width .25s ease}
    #progressText{opacity:.85;font-size:14px}
    #logPanel{position:fixed;left:0;top:0;bottom:0;width:min(360px,92vw);max-width:92vw;background:rgba(6,8,12,.92);
      border-right:1px solid rgba(255,255,255,.08);backdrop-filter: blur(10px);z-index:80;display:flex;flex-direction:column}
    #logHdr{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
    #logHdr strong{font-size:13px;opacity:.9}
    .lb{margin-left:auto;display:flex;gap:6px}
    .btn{font-size:12px;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#e8eefc}
    .btn:active{transform:scale(.98)}
    #logBody{padding:10px;overflow:auto;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;line-height:1.35}
    #logBody .err{color:#ff8f8f}
    #logBody .warn{color:#ffd28f}
    #logBody .ok{color:#9bffb5}
    #logHint{padding:8px 10px;border-top:1px solid rgba(255,255,255,.08);font-size:11px;opacity:.75}
    #logPanel.is-hidden{display:none}
    #logToggle{position:fixed;left:10px;bottom:10px;z-index:90}
  
  /* ASSISTANT PATCH v23.8: hide debug panels for non-admin */
  body:not(.btl-admin) #logPanel{display:none !important;}
  body:not(.btl-admin) #logToggle{display:none !important;}
  body.btl-admin #logPanel{display:flex !important;}
  body.btl-admin #logToggle{display:block !important;}
</style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- ASSISTANT PATCH: HEADER ALWAYS VISIBLE v34 (Y) -->
<style>
/* Override older guard that used fixed positioning; sticky is safer on mobile + avoids "UAH only" collapse */
.btlider-header-guard-fixed{
  position: sticky !important;
  top: 0 !important;
  left: auto !important;
  right: auto !important;
  width: 100% !important;
}
</style>
<script>
(function(){
  function qs(sel, root){ try{return (root||document).querySelector(sel);}catch(e){return null;} }
  function qsa(sel, root){ try{return Array.from((root||document).querySelectorAll(sel));}catch(e){return [];} }

  function pickHeader(){
    return qs('[data-id="header-wrapper"]') ||
           qs('[data-id="header-title"]')?.closest('[data-id]') ||
           qs('#header') ||
           qs('header') ||
           qs('[role="banner"]') ||
           qs('.header') ||
           qs('.header-wrapper') ||
           qs('.topbar') ||
           qs('.top-bar');
  }

  function forceShow(el){
    if(!el) return;
    try{
      el.classList.add('btlider-header-guard-visible','btlider-header-guard-fixed');
      el.style.display = 'block';
      el.style.visibility = 'visible';
      el.style.opacity = '1';
      el.style.transform = 'none';
      el.style.pointerEvents = 'auto';
      el.style.zIndex = '2147483000';
      // also unhide a few ancestors (common when wrapper gets hidden)
      var p = el.parentElement;
      for(var i=0;i<3 && p;i++){
        if(p && p.style){
          if(p.style.display==='none') p.style.display='block';
          if(p.style.visibility==='hidden') p.style.visibility='visible';
          if(p.style.opacity==='0') p.style.opacity='1';
        }
        p = p.parentElement;
      }
    }catch(e){}
  }

  var snapshot = null;
  function ensure(){
    var h = pickHeader();
    if(h){
      if(!snapshot){
        try{ snapshot = h.cloneNode(true); snapshot.__btliderSnapshot = true; }catch(e){}
      }
      forceShow(h);
      return;
    }
    // header missing: try restore from snapshot
    if(snapshot && document.body){
      try{
        var existing = pickHeader();
        if(existing) return;
        var ins = snapshot.cloneNode(true);
        // prevent duplicate ids by leaving markup as-is; this is last-resort fallback and only runs if header is missing
        document.body.insertBefore(ins, document.body.firstChild);
        forceShow(ins);
      }catch(e){}
    }
  }

  // Observe DOM changes that might hide/remove the header after load
  var mo = null;
  function startObserver(){
    if(mo) return;
    try{
      mo = new MutationObserver(function(){ ensure(); });
      mo.observe(document.documentElement || document.body, {subtree:true, childList:true, attributes:true, attributeFilter:['style','class','hidden']});
    }catch(e){}
  }

  ensure();
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ ensure(); startObserver(); }, {once:true});
  } else {
    startObserver();
  }
  window.addEventListener('load', function(){ ensure(); }, {once:true});
  // short burst checks right after load, then slow keepalive
  var n=0;
  var fast = setInterval(function(){ n++; ensure(); if(n>=30) { clearInterval(fast); } }, 250);
  setInterval(ensure, 1500);
})();
</script>
</head>
<body>
  <div id="app">
    <div id="frameWrap">
      <iframe id="appFrame" title="BTLIDER App" src="about:blank"></iframe>
      <div id="splash" aria-live="polite">
        <div style="font-weight:700;letter-spacing:.3px">BTLIDER</div>
        <div id="progressBar"><i id="progressFill"></i></div>
        <div id="progressText">Завантаження 0%</div>
      </div>
    </div>
  </div>

  <div id="logPanel">
    <div id="logHdr">
      <strong>LOG</strong>
      <div class="lb">
        <button class="btn" id="copyLogBtn">COPY</button>
        <button class="btn" id="clearLogBtn">CLEAR</button>
        <button class="btn" id="hideLogBtn">HIDE</button>
      </div>
    </div>
    <div id="logBody"></div>
    <div id="logHint">CTRL: COPY/CLEAR/HIDE • Якщо зависло — скинь COPY сюди.</div>
  </div>
  <button class="btn" id="logToggle">LOG</button>

  <!-- ASSISTANT PATCH v32: removed injected Admin button/modal.
       Reason: project rule forbids adding/moving buttons arbitrarily.
       Admin access remains via admin.html route + admin-only elements.
  -->


<script>
(() => {
  const BUILD = "BTLIDER v23.16 root-only (no offline auth) build 2026-02-04";
  const SB_URL = "https://vshzqiqppgitnhuqmcgn.supabase.co";
  const SB_ANON = "sb_publishable_DJSaoIKQQPU_5rio3xt8ZQ_8H_6Xs4X";
  // Admin gating:
  // 1) if profile.role === 'admin'
  // 2) OR email === ADMIN_EMAIL (your main account)
  const ADMIN_EMAIL = "bondarenkodarrderrrr@gmail.com";
  function isAdminProfile(p){
    try{
      if(!p) return false;
      if(String(p.role||'').toLowerCase() === 'admin') return true;
      const em = String(p.email||'').toLowerCase();
      return !!em && em === ADMIN_EMAIL.toLowerCase();
    }catch(e){ return false; }
  }
  function isAdmin(){
    try{
      const st = window.BTLIDER && window.BTLIDER.state;
      const email = st && st.user && st.user.email ? String(st.user.email).toLowerCase() : '';
      if(email && email === ADMIN_EMAIL.toLowerCase()) return true;
      return isAdminProfile(st && st.profile);
    }catch(e){ return false; }
  }
  function setAdminUI(v){
    try{ document.body.classList.toggle('btl-admin', !!v); window.__BTLIDER_IS_ADMIN = !!v; }catch(e){}
  }
  // ASSISTANT PATCH v27: BASE_PATH auto-detect (GitHub Pages repo vs localhost)
  const BASE_PATH = (function(){
    try{
      const p = String(location.pathname||'/');
      // If hosted on GitHub Pages under /Betlider/, keep it. Otherwise root.
      return (p.indexOf('/Betlider/') !== -1) ? '/Betlider/' : '/';
    }catch(e){ return '/'; }
  })(); // GitHub Pages repo path
  const frame = document.getElementById('appFrame');
    // ASSISTANT PATCH v23.8: broadcast admin state to child pages
  function sendAdminState(){
    try{
      const st = window.BTLIDER && window.BTLIDER.state;
      const email = st && st.user && st.user.email ? String(st.user.email) : '';
      const isAdmin = (String(email||'').toLowerCase() === ADMIN_EMAIL.toLowerCase()) || isAdminProfile(st && st.profile);
      frame && frame.contentWindow && frame.contentWindow.postMessage({__btlider:true,type:'BTLIDER_ADMIN_STATE', isAdmin:isAdmin, email:email}, '*');
    }catch(e){}
  }
const splash = document.getElementById('splash');
  const fill = document.getElementById('progressFill');
  const ptxt = document.getElementById('progressText');

  const logPanel = document.getElementById('logPanel');
  const logBody = document.getElementById('logBody');
  const copyBtn = document.getElementById('copyLogBtn');
  const clearBtn = document.getElementById('clearLogBtn');
  const hideBtn = document.getElementById('hideLogBtn');
  const toggleBtn = document.getElementById('logToggle');

  const lines = [];

  // ASSISTANT PATCH v27: clipboard fallback for http/LAN (navigator.clipboard may be undefined)
  function safeCopyText(text){
    try{
      if(navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function'){
        return navigator.clipboard.writeText(text);
      }
    }catch(e){}
    return new Promise(function(resolve, reject){
      try{
        var ta = document.createElement('textarea');
        ta.value = String(text||'');
        ta.setAttribute('readonly','');
        ta.style.position='fixed';
        ta.style.top='-1000px';
        ta.style.left='-1000px';
        ta.style.opacity='0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        var ok = false;
        try{ ok = document.execCommand('copy'); }catch(_e){ ok = false; }
        document.body.removeChild(ta);
        ok ? resolve(true) : reject(new Error('copy_failed'));
      }catch(e){ reject(e); }
    });
  }

  function stamp() {
    const d = new Date();
    return d.toTimeString().slice(0,8);
  }
  function addLine(level, msg, data) {
    const t = `[${stamp()}] ${msg}` + (data !== undefined ? ` | ${JSON.stringify(data)}` : '');
    lines.push(t);
    const div = document.createElement('div');
    if(level==='err') div.className='err';
    if(level==='warn') div.className='warn';
    if(level==='ok') div.className='ok';
    div.textContent = t;
    logBody.appendChild(div);
    logBody.scrollTop = logBody.scrollHeight;
  }
  // Compatibility: some old code may call log(...)
  window.log = (...a) => addLine('ok', a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' '));
  window.__BTLIDER_LOG = (lvl,msg,data) => addLine(lvl,msg,data);

  function setProgress(p) {
    const pct = Math.max(0, Math.min(100, p|0));
    fill.style.width = pct + '%';
    ptxt.textContent = `Завантаження ${pct}%`;
    if(pct >= 100) {
      setTimeout(() => splash.style.display='none', 150);
    }
  }

  copyBtn.onclick = async () => {
    const txt = lines.join('\n');
    try{
      if(navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function'){
        await navigator.clipboard.writeText(txt);
      }else{
        // Fallback for non-secure contexts (http on LAN IP, etc.)
        const ta = document.createElement('textarea');
        ta.value = txt;
        ta.setAttribute('readonly','');
        ta.style.position='fixed';
        ta.style.left='-9999px';
        ta.style.top='-9999px';
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand('copy'); }catch(_e){}
        document.body.removeChild(ta);
      }
      addLine('ok','COPIED');
    }catch(e){ addLine('warn','COPY_FAIL', String(e && e.message || e)); }
  };
  window.addLine = window.__BTLIDER_LOG; // alias

  clearBtn.onclick = () => { lines.length=0; logBody.textContent=''; addLine('ok','CLEARED'); };
  hideBtn.onclick = () => logPanel.classList.add('is-hidden');
  toggleBtn.onclick = () => logPanel.classList.toggle('is-hidden');

  // Clean offline leftovers that could fake auth
  const offlineKeys = ['gorilla_current','gorilla_users','BTLIDER_AUTH','BTLIDER_AUTHED','BTLIDER_DEMO_USER'];
  offlineKeys.forEach(k => {
    if(localStorage.getItem(k) !== null) {
      localStorage.removeItem(k);
      addLine('warn', `CLEAN: removed ${k}`);
    }
  });

  addLine('ok', 'BUILD: ' + BUILD);

  // Global error hooks
  window.addEventListener('error', (e) => {
    addLine('err', 'ERROR: ' + (e.message || 'unknown'), {filename:e.filename, lineno:e.lineno, colno:e.colno});
  });
  window.addEventListener('unhandledrejection', (e) => {
    addLine('err', 'UNHANDLED_REJECTION', String(e.reason && e.reason.message || e.reason || 'unknown'));
  });

  // Supabase client
  // Admin gating via profiles.role (Variant B)
  let adminMode = false;
  function isAdminProfile(p){
    return !!(p && String(p.role||'').toLowerCase()==='admin');
  }
const supabase = window.supabase.createClient(SB_URL, SB_ANON, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true
    }
  });
  window.BTLIDER = window.BTLIDER || {};
  window.BTLIDER.supabase = supabase;
  // ===== ASSISTANT PATCH v23: Wallet sync (Supabase wallets) =====
  window.BTLIDER = window.BTLIDER || {};
  setAdminUI(false);
  window.BTLIDER.state = window.BTLIDER.state || { authed:false, user:null, profile:null, balance:null, currency:'UAH', lastGesture:0 };
  // user gesture tracker (used to prevent auto-opening promo/profile on load)
  function markGesture(){ try{ window.BTLIDER.state.lastGesture = Date.now(); }catch(e){} }
  window.addEventListener('pointerdown', markGesture, {passive:true});
  window.addEventListener('keydown', markGesture, {passive:true});


  async function fetchWallet(user){
    if(!user) return null;
    try{
      addLine('DB_CALL: wallets.select', {user:user.email});
      let { data, error } = await supabase.from('wallets').select('balance,currency').eq('user_id', user.id).maybeSingle();
      if(error){
        // if table missing or RLS blocks, log and return null
        addLine('DB_ERR: wallets.select', {message:error.message, code:error.code||null});
        return null;
      }
      if(!data){
        addLine('DB_CALL: wallets.insert', {user:user.email});
        const ins = await supabase.from('wallets').insert({ user_id:user.id, balance:0, currency:'UAH' }).select('balance,currency').maybeSingle();
        if(ins.error){
          addLine('DB_ERR: wallets.insert', {message:ins.error.message, code:ins.error.code||null});
          return null;
        }
        data = ins.data;
      }
      const bal = Number(data.balance||0);
      const cur = String(data.currency||'UAH');
      window.BTLIDER.state.balance = bal;
      window.BTLIDER.state.currency = cur;
      // Offline/localStorage balance removed: Supabase DB is the only source of truth.
      // broadcast to iframe
      try{
        const fr = document.getElementById('appFrame');
        fr && fr.contentWindow && fr.contentWindow.postMessage({ __btlider: true, type:'BTLIDER_BALANCE', balance:bal, currency:cur }, '*');
      }catch(e){}
      addLine('DB_RES: wallets', {balance:bal, currency:cur});
      return {balance:bal, currency:cur};
    }catch(e){
      addLine('DB_EX: wallets', {message:String(e)});
      return null;
    }
  }
  // ===== ASSISTANT PATCH v23.13: Profiles sync (Supabase profiles) =====
  async function fetchProfile(user){
    if(!user) return null;
    try{
      addLine('DB_CALL: profiles.select', {user:user.email});
      let { data, error } = await supabase.from('profiles').select('email,display_name,role').eq('user_id', user.id).maybeSingle();
      if(error){
        addLine('DB_ERR: profiles.select', {message:error.message, code:error.code||null});
        return null;
      }
      if(!data){
        addLine('DB_CALL: profiles.insert', {user:user.email});
        const ins = await supabase.from('profiles').insert({
          user_id: user.id,
          email: user.email,
          display_name: (user.user_metadata && (user.user_metadata.full_name || user.user_metadata.name)) || null,
          role: 'user'
        }).select('email,display_name,role').maybeSingle();
        if(ins.error){
          addLine('DB_ERR: profiles.insert', {message:ins.error.message, code:ins.error.code||null});
          return null;
        }
        data = ins.data || null;
      } else {
        // keep email synced best-effort
        if(!data.email && user.email){
          try{ await supabase.from('profiles').update({ email:user.email }).eq('user_id', user.id); }catch(e){}
        }
      }
      return data || null;
    }catch(e){
      addLine('DB_EX: profiles', String(e && e.message || e));
      return null;
    }
  }
  // ===== ASSISTANT PATCH v23.13: Bonuses + Ledger helpers =====
  async function fetchBonuses(user){
    if(!user) return [];
    try{
      addLine('DB_CALL: user_bonuses.select', {user:user.email});
      const { data, error } = await supabase.from('user_bonuses')
        .select('id,bonus_code,status,value,meta,created_at')
        .eq('user_id', user.id)
        .order('created_at', { ascending:false })
        .limit(50);
      if(error){
        addLine('DB_ERR: user_bonuses.select', {message:error.message, code:error.code||null});
        return [];
      }
      return data || [];
    }catch(e){
      addLine('DB_EX: user_bonuses', String(e && e.message || e));
      return [];
    }
  }

  async function addLedger(user, delta, reason, ref, meta){
    if(!user) return false;
    try{
      addLine('DB_CALL: wallet_ledger.insert', {delta, reason});
      const { error } = await supabase.from('wallet_ledger').insert({
        user_id: user.id,
        delta: Number(delta)||0,
        reason: String(reason||'unknown'),
        ref: ref ? String(ref) : null,
        meta: meta || {}
      });
      if(error){
        addLine('DB_ERR: wallet_ledger.insert', {message:error.message, code:error.code||null});
        return false;
      }
      return true;
    }catch(e){
      addLine('DB_EX: wallet_ledger', String(e && e.message || e));
      return false;
    }
  }

  async function setWalletBalance(user, newBalance, currency){
    if(!user) return null;
    try{
      const nb = Number(newBalance);
      if(!isFinite(nb)) throw new Error('balance is not a number');
      addLine('DB_CALL: wallets.update', {balance: nb});
      const { data, error } = await supabase.from('wallets')
        .update({ balance: nb, currency: String(currency||'UAH') })
        .eq('user_id', user.id)
        .select('balance,currency')
        .maybeSingle();
      if(error){
        addLine('DB_ERR: wallets.update', {message:error.message, code:error.code||null});
        return null;
      }
      return data || null;
    }catch(e){
      addLine('DB_EX: wallets.update', String(e && e.message || e));
      return null;
    }
  }



  async function refreshSessionAndWallet(source){
    const sess = await getSessionSafe(source||'refresh');
    // getSessionSafe returns the session object (or null)
    const s = sess || null;
    window.BTLIDER.state.authed = !!s;
    window.BTLIDER.state.user = s ? s.user : null;
    // profiles + admin gating (Variant B)
    if(s && s.user){
      window.BTLIDER.state.profile = await fetchProfile(s.user);
      try{ setAdminUI(isAdmin()); sendAdminState(); }catch(e){}
      await fetchWallet(s.user);
    }else{
      window.BTLIDER.state.profile = null;
      try{ setAdminUI(false); sendAdminState(); }catch(e){}

      window.BTLIDER.state.balance = null;
      window.BTLIDER.state.currency = 'UAH';
    }
    // notify iframe about auth state
    try{
      const fr = document.getElementById('appFrame');
      fr && fr.contentWindow && fr.contentWindow.postMessage({ __btlider:true, type:'BTLIDER_AUTH_CHANGED', authed:window.BTLIDER.state.authed, user:window.BTLIDER.state.user, balance:window.BTLIDER.state.balance, currency:window.BTLIDER.state.currency }, '*');
    }catch(e){}
    return window.BTLIDER.state;
  }

  // expose for child pages
  window.BTLIDER.getState = () => ({...window.BTLIDER.state});
  window.BTLIDER.refresh = () => refreshSessionAndWallet('manual');


  async function getSessionSafe(source) {
    try {
      const { data, error } = await supabase.auth.getSession();
      if(error) addLine('err','AUTH_ERR getSession', error.message);
      return (data && data.session) ? data.session : null;
    } catch(e) {
      addLine('err','AUTH_ERR getSession EX', String(e && e.message || e));
      return null;
    }
  }

  function navTo(path) {
    frame.src = path;
    addLine('ok', 'route -> ' + path);
    setProgress(30);
  }

  

  function routeTo(path){
    // alias for legacy calls
    try{ navTo(path); }catch(e){ try{ frame.src = path; }catch(_e){} }
  }
function setAuthed(isAuthed, source) {
    window.__BTLIDER_AUTHED = !!isAuthed;
    addLine('ok', 'AUTH: session=' + (isAuthed ? 'YES' : 'NO'), {source});
    // toggle admin button (only when authed + admin mode enabled)
    try{
      const adminBtn = document.getElementById('adminBtn');
      const st = window.BTLIDER && window.BTLIDER.state;
      const adminMode = (localStorage.getItem('BTLIDER_ADMIN_MODE') === '1');
      const email = (st && st.user && st.user.email) ? String(st.user.email) : '';
      const isAdminNow = (String(email||'').toLowerCase() === ADMIN_EMAIL.toLowerCase()) || isAdminProfile(st && st.profile);
      setAdminUI(isAdminNow);
      sendAdminState();
      if(adminBtn){
        adminBtn.style.display = (isAuthed && adminMode && isAdminNow) ? 'block' : 'none';
      }
      if(isAuthed && st && st.balance != null){
        const sb = document.getElementById('adminSelfBalance');
        const sc = document.getElementById('adminSelfCurrency');
        if(sb) sb.value = String(st.balance);
        if(sc) sc.value = String(st.currency||'UAH');
      }
      if(isAuthed && !adminMode){
        // keep silent unless user enabled admin mode intentionally
      }
    }catch(e){}
  }

  
  // ===== ASSISTANT PATCH v23.4: hash routes (promo) =====
  function handleHashRoute(){
    try{
      const h = (location.hash||'').replace('#','').trim();
      if(!h) return;
      // only allow hash routes after a real user gesture
      const lg = (window.BTLIDER.state && window.BTLIDER.state.lastGesture) ? window.BTLIDER.state.lastGesture : 0;
      if(!lg || (Date.now()-lg) > 1500){
        addLine('warn','HASH_ROUTE ignored (no gesture)', {hash:h});
        return;
      }
      if(h === 'BTLIDER_PROMO'){
        addLine('ok','HASH_ROUTE: BTLIDER_PROMO');
        routeTo('promo_bonus.html');
      }
      if(h === 'BTLIDER_PROFILE'){
        addLine('ok','HASH_ROUTE: BTLIDER_PROFILE');
        routeTo('profile.html');
      }
    }catch(e){}
  }
  window.addEventListener('hashchange', handleHashRoute);

  
  // ===== ASSISTANT PATCH v23.4: stub modal for blocked links =====
  function showStubModal(title){
    try{
      const m = document.getElementById('stubModal');
      const t = document.getElementById('stubTitle');
      if(t) t.textContent = title || 'Скоро';
      if(m) m.style.display = 'flex';
    }catch(e){}
  }

  // Bridge API for iframes
  window.BTLIDER.Auth = {
    
      session: async function(){ try{ return await supabase.auth.getSession(); }catch(e){ throw e; } },
      getSession: async function(){ try{ return await supabase.auth.getSession(); }catch(e){ throw e; } },
async register(email, password) {
      addLine('ok','AUTH_CALL: signUp', {email});
      const { data, error } = await supabase.auth.signUp({
        email, password,
        options: {
          emailRedirectTo: location.origin + BASE_PATH + 'index.html'
        }
      });
      if(error) {
        addLine('err','AUTH_ERR: signUp', error.message);
        return { ok:false, error: error.message };
      }
      // When confirm email is OFF => session may be present
      const sess = data && data.session ? data.session : null;
      addLine('ok','AUTH_RES: signUp', {session: !!sess, user: !!(data && data.user)});
      return { ok:true, data:data };
    },
    async login(email, password) {
      addLine('ok','AUTH_CALL: signInWithPassword', {email});
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) {
        addLine('err','AUTH_ERR: signInWithPassword', error.message);
        return { ok:false, error: error.message };
      }
      addLine('ok','AUTH_RES: signInWithPassword', {session: !!(data && data.session)});
      return data;
    },
    async logout() {
      addLine('ok','AUTH_CALL: signOut');
      const { error } = await supabase.auth.signOut();
      if(error) {
        addLine('err','AUTH_ERR: signOut', error.message);
        return { ok:false, error: error.message };
      }
      addLine('ok','AUTH_RES: signOut');
      return { ok:true };
    }
    ,async session(){
      const { data, error } = await supabase.auth.getSession();
      if(error){ addLine('err','AUTH_ERR: getSession', error.message); return null; }
      return (data && data.session) ? data.session : null;
    }
    ,async getSession(){ return this.session(); }

  };

  // Auth state changes
  supabase.auth.onAuthStateChange((evt, session) => {
    addLine('ok', 'AUTH_EVT: ' + evt, session ? {user:session.user && session.user.email} : null);
    setAuthed(!!session, evt);
    try{ refreshSessionAndWallet('AUTH_EVT:'+evt); }catch(_e){}
    // notify iframe
    try {
      frame.contentWindow && frame.contentWindow.postMessage({__btlider:true,type:'BTLIDER_AUTH_CHANGED', authed: !!session, user: session?session.user:null}, '*');
    } catch(_e) {}
    // route
    if(session) {
      navTo('authed.html');
      setProgress(80);
    } else {
      navTo('guest.html');
      setProgress(60);
    }
  });

  // Boot routing (lazy iframe to avoid freeze)
  (async () => {
    setProgress(5);
    // Let first frame paint
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    setProgress(12);

    const sess = await getSessionSafe('boot');
    setAuthed(!!sess, 'boot');
    try{ await refreshSessionAndWallet('boot');
  handleHashRoute(); }catch(_e){}
    // Delay iframe heavy load a bit to avoid jank
    setTimeout(() => {
      if(sess) navTo('authed.html'); else navTo('guest.html');
      setProgress(65);
    }, 50);

    // If iframe doesn't load in time, show error but keep log
    const t0 = Date.now();
    let loaded = false;
    frame.addEventListener('load', () => {
      loaded = true;
      setProgress(100);
    }, { once:true });
    setTimeout(() => {
      if(!loaded) {
        window.__BTLIDER_LOG && window.__BTLIDER_LOG('warn','WARN: iframe load timeout', {ms: Date.now()-t0, src: frame.src});
        // Do NOT block the app on slow/blocked external resources: hide splash and continue.
        try{ setProgress(100); }catch(_e){}
        try{ splash && (splash.style.display='none'); }catch(_e){}
      }
    }, 8000);
  })();
})();

  // ===== ASSISTANT PATCH v23: child commands =====
  const __cmdDebounce = Object.create(null);
  
  // ASSISTANT PATCH v23.12: command throttle to prevent spam loops
  let __lastOpenPromoAt = 0;
  let __lastOpenProfileAt = 0;
  function __throttle(tsRef, ms){ const now=Date.now(); if(now - tsRef < ms) return [true, tsRef]; return [false, now]; }
window.addEventListener('message', (ev) => {
  const d = ev && ev.data;
  if(!d || !d.__btlider) return;

  // debounce spammy commands
  try{
    const k = d.type || '';
    const now = Date.now();
    if(k){
      if(__cmdDebounce[k] && (now-__cmdDebounce[k]) < 350) return;
      __cmdDebounce[k] = now;
    }
  }catch(e){}

  const authed = !!(window.BTLIDER && window.BTLIDER.state && window.BTLIDER.state.authed);

  if(d.type === 'NAV_HOME' || d.type === 'ROUTE_HOME'){
    window.__BTLIDER_LOG && window.__BTLIDER_LOG('ok','CMD: '+d.type);
    try{ authed ? routeTo('authed.html') : routeTo('guest.html'); }catch(e){}
    return;
  }

  if(d.type === 'OPEN_ADMIN'){
    // STRICT ADMIN GATE: only allow for the configured admin email
    try{
      const email = (window.BTLIDER && window.BTLIDER.state && window.BTLIDER.state.user && window.BTLIDER.state.user.email) ? String(window.BTLIDER.state.user.email).toLowerCase() : '';
      const isAdmin = (email === 'bondarenkodarrderrrr@gmail.com');
      if(!isAdmin){
        window.__BTLIDER_LOG && window.__BTLIDER_LOG('warn','CMD: OPEN_ADMIN_BLOCKED', { email: email || null });
        try{ showStubModal('Адмін доступ лише для адміністратора'); }catch(e){}
        return;
      }
      window.__BTLIDER_LOG && window.__BTLIDER_LOG('ok','CMD: OPEN_ADMIN');
      try{ routeTo('admin.html'); }catch(e){}
    }catch(e){}
    return;
  }

  if(d.type === 'OPEN_PROMO'){
    const __now_OPEN_PROMO = Date.now();
    if(__now_OPEN_PROMO - __lastOpenPromoAt < 500){ window.__BTLIDER_LOG && window.__BTLIDER_LOG('warn','CMD_THROTTLED: OPEN_PROMO'); return; }
    __lastOpenPromoAt = __now_OPEN_PROMO;
    window.__BTLIDER_LOG && window.__BTLIDER_LOG('ok','CMD: OPEN_PROMO');
    try{ routeTo('promo_bonus.html'); }catch(e){}
    return;
  }

  if(d.type === 'OPEN_PROFILE'){
    const __now_OPEN_PROFILE = Date.now();
    if(__now_OPEN_PROFILE - __lastOpenProfileAt < 500){ window.__BTLIDER_LOG && window.__BTLIDER_LOG('warn','CMD_THROTTLED: OPEN_PROFILE'); return; }
    __lastOpenProfileAt = __now_OPEN_PROFILE;
    window.__BTLIDER_LOG && window.__BTLIDER_LOG('ok','CMD: OPEN_PROFILE');
    try{ routeTo('profile.html'); }catch(e){}
    return;
  }

  if(d.type === 'OPEN_STUB'){
    window.__BTLIDER_LOG && window.__BTLIDER_LOG('warn','CMD: OPEN_STUB', d);
    try{ showStubModal(d && d.label ? d.label : 'Скоро'); }catch(e){}
    return;
  }

  if(d.type === 'NEED_BALANCE'){
    window.__BTLIDER_LOG && window.__BTLIDER_LOG('ok','CMD: NEED_BALANCE');
    const st = window.BTLIDER.getState ? window.BTLIDER.getState() : null;
    try{
      const fr = document.getElementById('appFrame');
      fr && fr.contentWindow && fr.contentWindow.postMessage({ __btlider:true, type:'BTLIDER_BALANCE', balance:st?st.balance:null, currency:st?st.currency:'UAH' }, '*');
    }catch(e){}
    return;
  }
}, false);
</script>

  <!-- ASSISTANT PATCH v23.4: STUB MODAL -->
  <div id="stubModal" style="display:none;position:fixed;inset:0;z-index:99999;align-items:center;justify-content:center;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);">
    <div style="width:min(92vw,420px);border-radius:16px;padding:16px 14px;background:linear-gradient(180deg,rgba(28,28,35,.96),rgba(10,10,14,.96));border:1px solid rgba(255,255,255,.10);box-shadow:0 0 0 1px rgba(0,255,170,.06),0 18px 60px rgba(0,0,0,.65);">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-weight:800;font-size:16px;letter-spacing:.2px;" id="stubTitle">Скоро</div>
        <button id="stubClose" style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;">Закрити</button>
      </div>
      <div style="margin-top:10px;opacity:.85;font-size:13px;line-height:1.35;">Ця кнопка була прив’язана до старого зовнішнього сайту. Ми вимкнули зовнішні переходи. Потрібно підключити нашу функцію під цю кнопку (буде зроблено по списку).</div>
      <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end;">
        <button id="stubGoPromo" style="background:linear-gradient(90deg,rgba(0,255,170,.22),rgba(0,140,255,.18));border:1px solid rgba(0,255,170,.25);color:#fff;border-radius:12px;padding:10px 12px;cursor:pointer;">Промо</button>
        <button id="stubGoProfile" style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);color:#fff;border-radius:12px;padding:10px 12px;cursor:pointer;">Профіль</button>
      </div>
    </div>
  </div>

<!-- ASSISTANT PATCH: universal diag + loader failsafe v23.14 -->
<script>
(function(){
  'use strict';
  function ts(){
    try{
      const d=new Date();
      return d.toTimeString().slice(0,8);
    }catch(e){ return ''; }
  }
  function safeJson(o){
    try{ return JSON.stringify(o); }catch(e){ return String(o); }
  }
  function pushLine(tag,msg,obj){
    window.__BTLIDER_LINES = window.__BTLIDER_LINES || [];
    window.__BTLIDER_LINES.push([Date.now(), tag, msg, obj]);
    if(window.__BTLIDER_LINES.length>800) window.__BTLIDER_LINES.shift();
  }
  // Hard guarantee
  window.addLine = window.addLine || function(tag,msg,obj){ pushLine(tag,msg,obj); };

  // Capture errors for everyone (temporary)
  window.addEventListener('error', function(e){
    pushLine('ERROR', (e && e.message) ? e.message : 'error', {filename:e && e.filename, lineno:e && e.lineno, colno:e && e.colno});
  });
  window.addEventListener('unhandledrejection', function(e){
    var r = e && e.reason;
    pushLine('REJECT', (r && (r.message||r.toString())) || 'unhandledrejection', {reason: (r && (r.stack||r.message)) || String(r)});
  });

  function mount(){
    if(document.getElementById('btlDiagPanel')) return;
    var wrap=document.createElement('div');
    wrap.id='btlDiagPanel';
    wrap.style.cssText='position:fixed;left:8px;bottom:68px;width:min(360px,92vw);max-height:42vh;z-index:2147483647;background:rgba(0,0,0,.72);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.18);border-radius:14px;overflow:hidden;font:12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#fff;';
    var head=document.createElement('div');
    head.style.cssText='display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.12);';
    head.innerHTML='<div style="font-weight:700;letter-spacing:.2px;">BTLIDER LOG</div><div style="opacity:.75;flex:1;">(тимчасово для всіх)</div>';
    var btnCopy=document.createElement('button');
    btnCopy.textContent='COPY';
    btnCopy.style.cssText='background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:6px 10px;font-weight:700;';
    var btnHide=document.createElement('button');
    btnHide.textContent='HIDE';
    btnHide.style.cssText=btnCopy.style.cssText;
    btnHide.onclick=function(){ wrap.style.display='none'; };
    btnCopy.onclick=function(){
      try{
        var lines=(window.__BTLIDER_LINES||[]).slice(-250).map(function(x){
          var t = ts();
          try{ t = new Date(x[0]).toTimeString().slice(0,8); }catch(e){}
          var tag=x[1], msg=x[2], obj=x[3];
          return '['+t+'] '+tag+': '+msg+(obj!==undefined ? ' | '+safeJson(obj) : '');
        }).join('\n');
        (function(){
          try{
            if(navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function'){
              copyTextSafe(lines).then(function(){ pushLine('COPIED','OK'); }).catch(function(){ pushLine('COPIED','FAILED'); });
              return;
            }
          }catch(_e){}
          try{
            var ta=document.createElement('textarea');
            ta.value=lines;
            ta.setAttribute('readonly','');
            ta.style.position='fixed';
            ta.style.left='-9999px';
            ta.style.top='-9999px';
            document.body.appendChild(ta);
            ta.select();
            try{ var ok=document.execCommand('copy'); pushLine('COPIED', ok?'OK':'FAILED'); }catch(e){ pushLine('COPIED','FAILED'); }
            document.body.removeChild(ta);
          }catch(e){ pushLine('COPIED','FAILED'); }
        })();
      }catch(e){ pushLine('COPIED','EX', String(e && e.message || e)); }
    };
    head.appendChild(btnCopy);
    head.appendChild(btnHide);

    var body=document.createElement('div');
    body.id='btlDiagBody';
    body.style.cssText='padding:8px 10px;overflow:auto;max-height:34vh;white-space:pre-wrap;word-break:break-word;';
    wrap.appendChild(head);
    wrap.appendChild(body);
    document.body.appendChild(wrap);

    function render(){
      var arr=(window.__BTLIDER_LINES||[]).slice(-200);
      body.textContent=arr.map(function(x){
        var t=ts(); try{ t=new Date(x[0]).toTimeString().slice(0,8);}catch(e){}
        return '['+t+'] '+x[1]+': '+x[2]+(x[3]!==undefined ? ' | '+safeJson(x[3]) : '');
      }).join('\n');
      body.scrollTop = body.scrollHeight;
    }
    render();
    setInterval(render, 700);
  }

  function loaderFailsafe(){
    try{
      // remove common full-screen blockers
      var kill = [
        '#preloader','#loader','#loading','#loadingOverlay','.preloader','.loader','.loading-overlay','.loadingOverlay','[data-btl-loader]','[data-loader]'
      ];
      kill.forEach(function(sel){
        document.querySelectorAll(sel).forEach(function(el){
          try{ el.style.display='none'; }catch(e){}
        });
      });
      if(document.documentElement) document.documentElement.classList.remove('loading');
      if(document.body) document.body.classList.remove('loading');
      pushLine('DIAG','loader failsafe executed');
      try{ setProgress(100); }catch(_e){}
      try{ splash && (splash.style.display='none'); }catch(_e){}
    }catch(e){
      pushLine('DIAG','loader failsafe error', String(e && e.message || e));
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    mount();
    // If anything still blocks after 7s, kill it
    setTimeout(loaderFailsafe, 7000);
  });

  // If DOM already loaded
  if(document.readyState === 'interactive' || document.readyState === 'complete'){
    setTimeout(function(){ try{ mount(); }catch(e){} }, 0);
    setTimeout(loaderFailsafe, 7000);
  }
})();
</script>

<!-- ASSISTANT PATCH: HEADER GUARD 2026-02-05 18:01:12 UTC -->
<script>
(function(){
  function q(sel){ try{return document.querySelector(sel);}catch(e){return null;} }
  function pickHeader(){
    return q('[data-id="header-wrapper"]') ||
           q('#header') ||
           q('header') ||
           q('.header') ||
           q('.header-wrapper') ||
           q('.topbar') ||
           q('.top-bar');
  }
  function forceShow(el){
    if(!el) return;
    try{
      el.classList.add('btlider-header-guard-visible','btlider-header-guard-fixed');
      el.style.display = 'block';
      el.style.visibility = 'visible';
      el.style.opacity = '1';
      el.style.transform = 'none';
      el.style.pointerEvents = 'auto';
      el.style.zIndex = '2147483000';
    }catch(e){}
  }
  function fixAuthButtons(){
    var ids = ['#header-login','#header-register','#loginBtn','#registerBtn'];
    ids.forEach(function(s){
      var el = q(s);
      if(el){
        try{
          el.style.display = '';
          el.style.visibility = 'visible';
          el.style.opacity = '1';
          el.style.pointerEvents = 'auto';
        }catch(e){}
      }
    });
  }
  function tick(){
    var h = pickHeader();
    if(h){ forceShow(h); fixAuthButtons(); }
  }
  tick();
  document.addEventListener('DOMContentLoaded', tick, { once:true });
  window.addEventListener('load', tick, { once:true });
  setInterval(tick, 900);
})();
</script>

<!-- ASSISTANT PATCH: ADMIN UI GATE (do NOT hide header) 2026-02-05 18:01:12 UTC -->
<script>
(function(){
  var ADMIN_EMAILS = ['bondarenkodarrderrrr@gmail.com','bondarenkodarderrrr@gmail.com'];
  function q(sel){ try{return document.querySelector(sel);}catch(e){return null;} }
  function qa(sel){ try{return Array.from(document.querySelectorAll(sel));}catch(e){return [];} }
  function hide(el){ if(!el) return; try{ el.style.display='none'; }catch(e){} }
  function show(el){ if(!el) return; try{ el.style.display=''; }catch(e){} }
  function isAdminEmail(email){
    if(!email) return false;
    email = String(email).toLowerCase().trim();
    for(var i=0;i<ADMIN_EMAILS.length;i++) if(ADMIN_EMAILS[i]===email) return true;
    return false;
  }
  function getEmailFromSession(){
    try{
      if(window.BTLIDER && window.BTLIDER.Auth && typeof window.BTLIDER.Auth.session==='function') return null;
      var keys = Object.keys(localStorage||{});
      for(var i=0;i<keys.length;i++) {
        var k = keys[i];
        if(k.indexOf('supabase')>=0 && k.indexOf('auth-token')>=0) {
          var raw = localStorage.getItem(k);
          if(!raw) continue;
          try {
            var j = JSON.parse(raw);
            var email = j && j.user && j.user.email;
            if(email) return email;
          } catch(e){}
        }
      }
    }catch(e){}
    return null;
  }
  function applyGate(isAdmin){
    qa('[data-btlider-admin-only]').forEach(function(el){ if(isAdmin) show(el); else hide(el); });
    var sels = ['#toggleLog','#copyLog','#btliderAdminBtn','#adminBtn','#adminPanelBtn','.btlider-admin-only'];
    sels.forEach(function(sel){
      var el = q(sel);
      if(el){ if(isAdmin) show(el); else hide(el); }
    });
  }
  async function tickAsync(){
    var email = null;
    try{
      if(window.BTLIDER && window.BTLIDER.Auth && typeof window.BTLIDER.Auth.session==='function') {
        var s = await window.BTLIDER.Auth.session();
        email = s && s.email ? s.email : null;
      }
    }catch(e){}
    if(!email) email = getEmailFromSession();
    applyGate(isAdminEmail(email));
  }
  document.addEventListener('DOMContentLoaded', function(){
    tickAsync();
    setInterval(tickAsync, 1200);
  });
})();
</script>

</body>
</html>
